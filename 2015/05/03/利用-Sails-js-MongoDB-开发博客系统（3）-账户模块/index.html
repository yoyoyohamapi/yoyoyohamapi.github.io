<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="利用 Sails.js + MongoDB 开发博客系统（3）-- 账户模块"/>




  <meta name="keywords" content="Sails,Node,MongoDB," />




  <link rel="alternate" href="/atom.xml" title="吴小蛆的巣">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x" />



<link rel="canonical" href="http://yoyoyohamapi.me/2015/05/03/利用-Sails-js-MongoDB-开发博客系统（3）-账户模块/"/>


<meta name="description" content="章节概述在本章中，你讲学习到如下知识：  Sails 中如何配置 MongoDB。 Sails 中的模型层（Models）知识，如模型属性（attributes），模型生命期回调（lifecycle callbacks）等。 利用 Passport.js 来管理我们的账户认证。 认识密码加密策略 bcrypt。 认识 Sails 的核心模块 policies。 如何在 Sails 中撰写自定义配置">
<meta name="keywords" content="Sails,Node,MongoDB">
<meta property="og:type" content="article">
<meta property="og:title" content="利用 Sails.js + MongoDB 开发博客系统（3）-- 账户模块">
<meta property="og:url" content="http://yoyoyohamapi.me/2015/05/03/利用-Sails-js-MongoDB-开发博客系统（3）-账户模块/index.html">
<meta property="og:site_name" content="吴小蛆的巣">
<meta property="og:description" content="章节概述在本章中，你讲学习到如下知识：  Sails 中如何配置 MongoDB。 Sails 中的模型层（Models）知识，如模型属性（attributes），模型生命期回调（lifecycle callbacks）等。 利用 Passport.js 来管理我们的账户认证。 认识密码加密策略 bcrypt。 认识 Sails 的核心模块 policies。 如何在 Sails 中撰写自定义配置">
<meta property="og:image" content="http://7pulhb.com1.z0.glb.clouddn.com/sails-generate_api.png">
<meta property="og:image" content="http://7pulhb.com1.z0.glb.clouddn.com/sails-%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2.png">
<meta property="og:image" content="http://7pulhb.com1.z0.glb.clouddn.com/sails-2_user_created.png">
<meta property="og:image" content="http://7pulhb.com1.z0.glb.clouddn.com/sails - 登陆页面. png">
<meta property="og:image" content="http://7pulhb.com1.z0.glb.clouddn.com/sails-%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95.png">
<meta property="og:updated_time" content="2017-04-30T03:44:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用 Sails.js + MongoDB 开发博客系统（3）-- 账户模块">
<meta name="twitter:description" content="章节概述在本章中，你讲学习到如下知识：  Sails 中如何配置 MongoDB。 Sails 中的模型层（Models）知识，如模型属性（attributes），模型生命期回调（lifecycle callbacks）等。 利用 Passport.js 来管理我们的账户认证。 认识密码加密策略 bcrypt。 认识 Sails 的核心模块 policies。 如何在 Sails 中撰写自定义配置">
<meta name="twitter:image" content="http://7pulhb.com1.z0.glb.clouddn.com/sails-generate_api.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />







<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  



    <title> 利用 Sails.js + MongoDB 开发博客系统（3）-- 账户模块 · 吴小蛆的巣 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">吴小蛆的巣</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">吴小蛆的巣</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              Tags
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              Categories
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          利用 Sails.js + MongoDB 开发博客系统（3）-- 账户模块
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          May 3, 2015
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#章节概述"><span class="toc-text">章节概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计"><span class="toc-text">设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#user-document-设计"><span class="toc-text">user document 设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成-user-api"><span class="toc-text">生成 user api</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-MongoDB-数据库连接"><span class="toc-text">配置 MongoDB 数据库连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-Sails-对-MongoDB-的依赖"><span class="toc-text">安装 Sails 对 MongoDB 的依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-MongoDB-连接"><span class="toc-text">配置 MongoDB 连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模型层的基本配置"><span class="toc-text">模型层的基本配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用-Passport-js-来管理我们的账户认证"><span class="toc-text">利用 Passport.js 来管理我们的账户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装依赖"><span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-user-实体"><span class="toc-text">配置 user 实体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建路由及视图"><span class="toc-text">创建路由及视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建对应的视图"><span class="toc-text">创建对应的视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#撰写登录验证逻辑，感谢-Giancarlo-Soverini-提供教程"><span class="toc-text">撰写登录验证逻辑，感谢 Giancarlo Soverini 提供教程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#访问控制（ACL）"><span class="toc-text">访问控制（ACL）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Policies"><span class="toc-text">Policies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化"><span class="toc-text">优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#表单验证"><span class="toc-text">表单验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#章节预告"><span class="toc-text">章节预告</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="章节概述"><a href="#章节概述" class="headerlink" title="章节概述"></a>章节概述</h2><p>在本章中，你讲学习到如下知识：</p>
<ul>
<li>Sails 中如何配置 MongoDB。</li>
<li>Sails 中的模型层（Models）知识，如模型属性（attributes），模型生命期回调（lifecycle callbacks）等。</li>
<li>利用 Passport.js 来管理我们的账户认证。</li>
<li>认识密码加密策略 bcrypt。</li>
<li>认识 Sails 的核心模块 policies。</li>
<li>如何在 Sails 中撰写自定义配置。</li>
<li>如何扩展 swig 模板引擎。</li>
<li>semantic-ui 中表单验证模块的应用。</li>
</ul>
<a id="more"></a>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><h3 id="user-document-设计"><a href="#user-document-设计" class="headerlink" title="user document 设计"></a>user document 设计</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>类型</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>siteName</td>
<td>站点名称</td>
<td>string</td>
<td>必选，1~10 个字符</td>
</tr>
<tr>
<td>siteDesc</td>
<td>站点简介</td>
<td>string</td>
<td>可选，不超过 20 字符</td>
</tr>
<tr>
<td>email</td>
<td>用户邮箱</td>
<td>string(email)</td>
<td>必选，唯一</td>
</tr>
<tr>
<td>password</td>
<td>密码</td>
<td>string</td>
<td>必选，原始长度不少于 6 个字符</td>
</tr>
</tbody>
</table>
<h3 id="生成-user-api"><a href="#生成-user-api" class="headerlink" title="生成 user api"></a>生成 user api</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails generate api user</div></pre></td></tr></table></figure>
<p>可以看到，Sails 为我们生成了 user 相应地模型及控制器</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-generate_api.png" width="300"><br></div>

<h2 id="配置-MongoDB-数据库连接"><a href="#配置-MongoDB-数据库连接" class="headerlink" title="配置 MongoDB 数据库连接"></a>配置 MongoDB 数据库连接</h2><h3 id="安装-Sails-对-MongoDB-的依赖"><a href="#安装-Sails-对-MongoDB-的依赖" class="headerlink" title="安装 Sails 对 MongoDB 的依赖"></a>安装 Sails 对 MongoDB 的依赖</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install sails-mongo --save</div></pre></td></tr></table></figure>
<h3 id="配置-MongoDB-连接"><a href="#配置-MongoDB-连接" class="headerlink" title="配置 MongoDB 连接"></a>配置 MongoDB 连接</h3><p>修改 config/connections.js:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.connections = &#123;</div><div class="line">  <span class="attr">mongo</span>: &#123;</div><div class="line">    <span class="attr">adapter</span>: <span class="string">'sails-mongo'</span>,</div><div class="line">    <span class="attr">host</span>: <span class="string">'localhost'</span>, <span class="comment">// defaults to `localhost` if omitted</span></div><div class="line">    port: <span class="number">27017</span>, <span class="comment">// defaults to 27017 if omitted</span></div><div class="line">    database: <span class="string">'blog'</span> <span class="comment">// or omit if not relevant</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="模型层的基本配置"><a href="#模型层的基本配置" class="headerlink" title="模型层的基本配置"></a>模型层的基本配置</h3><p>修改 config/models.js，配置模型的连接数据库位 MongoDB，并为每个模型添加 updatedAt 以及 createdAt 属性:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.models = &#123;</div><div class="line"></div><div class="line">  <span class="string">'connection'</span> : <span class="string">'mongo'</span>,</div><div class="line">  <span class="attr">autoCreatedAt</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">autoUpdatedAt</span>: <span class="literal">true</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="利用-Passport-js-来管理我们的账户认证"><a href="#利用-Passport-js-来管理我们的账户认证" class="headerlink" title="利用 Passport.js 来管理我们的账户认证"></a>利用 Passport.js 来管理我们的账户认证</h2><p><a href="http://passportjs.org/" target="_blank" rel="external"><strong>Passport.js</strong> </a>是 Node.js 中一个专注于登录验证的中间件，配置灵活，支持很多第三方登录验证。十分感谢 <a href="http://iliketomatoes.com/implement-passport-js-authentication-with-sails-js-0-10-2/" target="_blank" rel="external">这篇教程</a> 帮助我将 Passport.js 集成到 Sails 中。</p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>安装<a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="external"> bcrypt </a>，bcrypt 被认为是比一般加盐加密更好的密码加密手段，一般的加盐加密在密码较简单是仍可能被暴力破解，bcrypt 牺牲了部分性能，来换取更高的密码存储安全，参看如下两篇文章：</p>
<ul>
<li><p><a href="http://codahale.com/how-to-safely-store-a-password/" target="_blank" rel="external">How To Safely Store A Password</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/lixiong/archive/2011/12/24/2300098.html" target="_blank" rel="external">md5/sha1+salt 和 Bcrypt</a></p>
</li>
</ul>
<p>安装 bcrypt:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install bcrpyt --save</div></pre></td></tr></table></figure>
<p>安装 Passport.js:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install passport --save</div></pre></td></tr></table></figure>
<p>因为我们是本地验证，所以只需要 Passport 的本地验证支持</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install passport-local --save</div></pre></td></tr></table></figure>
<h3 id="配置-user-实体"><a href="#配置-user-实体" class="headerlink" title="配置 user 实体"></a>配置 user 实体</h3><p>在此博客系统中，用户注册前需要对用户密码进行 bcrypt 加密，这将会利用到 Sails 中模型层的生命期回调<a href="http://www.sailsjs.org/documentation/concepts/models-and-orm/lifecycle-callbacks" target="_blank" rel="external"> Lifecycle callbacks </a>, 在此，我们用到的生命期为 <code>beforeCreate</code>，亦即模型创建前执行的回调：</p>
<p><strong>api/models/User.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>);</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="comment">// 站点名称</span></div><div class="line">    siteName: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">required</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">minLength</span>:<span class="number">1</span>,</div><div class="line">      <span class="attr">maxLength</span>:<span class="number">10</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 邮箱</span></div><div class="line">    email: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'email'</span>,</div><div class="line">      <span class="attr">unique</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">required</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 密码</span></div><div class="line">    password: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">required</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 站点简介</span></div><div class="line">    siteDesc: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">defaultsTo</span>: <span class="string">'暂无简介'</span>,</div><div class="line">      <span class="attr">maxLength</span>:<span class="number">40</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 是否管理员（默认为非管理员）</span></div><div class="line">    isAdmin: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'boolean'</span>,</div><div class="line">      <span class="attr">defaultsTo</span>: <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// 创建（注册）用户前，对用户密码加密</span></div><div class="line">  beforeCreate: <span class="function"><span class="keyword">function</span> (<span class="params">values, cb</span>) </span>&#123;</div><div class="line">    bcrypt.genSalt(<span class="number">10</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, salt</span>) </span>&#123;</div><div class="line">      bcrypt.hash(values.password, salt, <span class="function"><span class="keyword">function</span>(<span class="params">err, hash</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(err) <span class="keyword">return</span> cb(err);</div><div class="line">        values.password = hash;</div><div class="line">        <span class="comment">// 执行用户定义回调</span></div><div class="line">        cb();</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="创建路由及视图"><a href="#创建路由及视图" class="headerlink" title="创建路由及视图"></a>创建路由及视图</h3><p>先创建一个封装了登录注册逻辑的控制器 AuthController.js：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails generate controller auth</div></pre></td></tr></table></figure>
<p>接下来在 config/routes.js 中为我们的登录注册创建相应路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">//config/routes.js</span></div><div class="line"><span class="built_in">module</span>.exports.routes = &#123;</div><div class="line"></div><div class="line">  <span class="comment">/***************************************************************************</span></div><div class="line">  *                                                                          *</div><div class="line">  * Make the view located at `views/homepage.ejs` (or `views/homepage.jade`, *</div><div class="line">  * etc. depending on your default view engine) your home page.              *</div><div class="line">  *                                                                          *</div><div class="line">  * (Alternatively, remove this and add an `index.html` file in your         *</div><div class="line">  * `assets` directory)                                                      *</div><div class="line">  *                                                                          *</div><div class="line">  ***************************************************************************/</div><div class="line"></div><div class="line">  <span class="comment">//'/': &#123;</span></div><div class="line">  <span class="comment">//  view: 'homepage'</span></div><div class="line">  <span class="comment">//&#125;</span></div><div class="line"></div><div class="line">  <span class="string">'/'</span> : &#123;</div><div class="line">    <span class="attr">view</span> :<span class="string">'index'</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">//---------------Login &amp; Register</span></div><div class="line">    <span class="comment">// 跳转到注册页面</span></div><div class="line">    <span class="string">'get /register'</span>: <span class="string">'AuthController.toRegister'</span>,</div><div class="line">    <span class="comment">// 处理注册逻辑</span></div><div class="line">    <span class="string">'post /register'</span>: <span class="string">'AuthController.processRegister'</span>,</div><div class="line">    <span class="comment">// 跳转到登陆页</span></div><div class="line">    <span class="string">'get /login'</span>: &#123;</div><div class="line">        <span class="attr">view</span>: <span class="string">'passport/login'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 处理登陆逻辑</span></div><div class="line">    <span class="string">'post /login'</span>: <span class="string">'AuthController.processLogin'</span>,</div><div class="line">    <span class="comment">// 登出逻辑</span></div><div class="line">    <span class="string">'/logout'</span>: <span class="string">'AuthController.logout'</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="创建对应的视图"><a href="#创建对应的视图" class="headerlink" title="创建对应的视图"></a>创建对应的视图</h3><blockquote>
<p>相应地 css 文件内容不给出，UI 设计见仁见智。</p>
</blockquote>
<p>views/passport/layout.swig：</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> '../partial/layout.swig' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/passport.css"</span>/&gt;</span></span></div><div class="line"><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>注意，给登录及注册页面声明待调用模块：</p>
<p>passport/login 及 passport/register</p>
<p>views/passport/login.swig:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> 'layout.swig' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">set</span></span> module = 'passport/login' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> title -%&#125;</span><span class="xml">欢迎登录</span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> form_content -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"ui form"</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"ui dividing header"</span>&gt;</span> 欢迎登录 < span class="tag">&lt;/<span class="name">h1</span>&gt;</div><div class="line">        <span class="template-tag">&#123;% <span class="name"><span class="keyword">if</span></span> err -%&#125;</span><span class="xml"></span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui error message"</span> <span class="attr">style</span>=<span class="string">"display: block"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span> 登录失败 < span class="tag">&lt;/<span class="name">div</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span> 账号或密码错误 < span class="tag">&lt;/<span class="name">p</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="template-tag">&#123;%- <span class="name"><span class="keyword">endif</span></span> %&#125;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"您的邮箱"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"您的密码"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui buttons"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"ui positive button"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span> 登录 < span class="tag">&lt;/<span class="name">button</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"or"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"ui negative button"</span> <span class="attr">href</span>=<span class="string">"/register"</span>&gt;</span> 注册 < span class="tag">&lt;/<span class="name">a</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>views/passport/register.swig：</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> 'layout.swig' -%&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">set</span></span> module='passport/register' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> title -%&#125;</span><span class="xml">注册</span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> form_content -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"ui form"</span> <span class="attr">action</span>=<span class="string">"/register"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"ui dividing header"</span>&gt;</span> 欢迎注册 < span class="tag">&lt;/<span class="name">h1</span>&gt;</div><div class="line">        <span class="template-tag">&#123;% <span class="name"><span class="keyword">if</span></span> err -%&#125;</span><span class="xml"></span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui error message"</span> <span class="attr">style</span>=<span class="string">"display: block"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span> 注册失败 < span class="tag">&lt;/<span class="name">div</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span> 邮箱已被注册 < span class="tag">&lt;/<span class="name">p</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="template-tag">&#123;%- <span class="name"><span class="keyword">endif</span></span> %&#125;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span> = <span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"siteName"</span> <span class="attr">name</span>=<span class="string">"siteName"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"填写站点名称"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">placeholder</span>=<span class="string">"填写邮箱"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"填写密码（不少于 6 个字符）"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"siteDesc"</span> <span class="attr">name</span>=<span class="string">"siteDesc"</span> <span class="attr">placeholder</span>=<span class="string">"填写站点简介"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui buttons"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"ui positive button"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span> 注册 < span class="tag">&lt;/<span class="name">button</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"or"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"ui negative button"</span> <span class="attr">href</span>=<span class="string">"/login"</span>&gt;</span> 登录 < span class="tag">&lt;/<span class="name">a</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;%-<span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="撰写登录验证逻辑，感谢-Giancarlo-Soverini-提供教程"><a href="#撰写登录验证逻辑，感谢-Giancarlo-Soverini-提供教程" class="headerlink" title="撰写登录验证逻辑，感谢 Giancarlo Soverini 提供教程"></a>撰写登录验证逻辑，<a href="http://iliketomatoes.com/implement-passport-js-authentication-with-sails-js-0-10-2/" target="_blank" rel="external">感谢 Giancarlo Soverini 提供教程</a></h3><p>在 api/controllers/AuthController.js 添加如下内容：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 验证逻辑控制器</div><div class="line">* */</div><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理注册逻辑</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    processRegister: <span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line">        <span class="comment">// 由请求参数构造待创建 User 对象</span></div><div class="line">        <span class="keyword">var</span> user = req.allParams();</div><div class="line">        User.create(user).exec(<span class="function"><span class="keyword">function</span> <span class="title">createCB</span>(<span class="params">err, created</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">               <span class="comment">// 如果有误，返回错误</span></div><div class="line">                res.view(<span class="string">'passport/register'</span>,&#123;<span class="attr">err</span>:err&#125;);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">// 否则，将新创建的用户登录</span></div><div class="line">                req.login(created, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> next(err); &#125;</div><div class="line">                    <span class="keyword">return</span> res.redirect(<span class="string">'/'</span>);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理登陆逻辑</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    processLogin: <span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line">        <span class="comment">// 使用本地验证策略对登录进行验证</span></div><div class="line">        passport.authenticate(<span class="string">'local'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, user, info</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> ((err) || (!user)) &#123;</div><div class="line">                <span class="keyword">return</span> res.send(&#123;</div><div class="line">                    <span class="attr">message</span>: info.message,</div><div class="line">                    <span class="attr">user</span>: user</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            req.logIn(user, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) res.send(err);</div><div class="line">                <span class="keyword">return</span> res.send(&#123;</div><div class="line">                    <span class="attr">message</span>: info.message,</div><div class="line">                    <span class="attr">user</span>: user</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">        &#125;)(req, res);</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理登出逻辑</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    logout: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">        req.logout();</div><div class="line">        res.redirect(<span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p>任何 Sails 的控制器方法都有两个参数，<a href="http://www.sailsjs.org/documentation/reference/request-req" target="_blank" rel="external"> req（请求）对象</a>及<a href="http://www.sailsjs.org/documentation/reference/response-res" target="_blank" rel="external"> res（响应）对象</a>。</p>
</blockquote>
<p>创建 config/passport.js 对 Passport 验证进行如下配置：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>),</div><div class="line">    <span class="comment">// 使用本地登录逻辑</span></div><div class="line">    LocalStrategy = <span class="built_in">require</span>(<span class="string">'passport-local'</span>).Strategy,</div><div class="line">    <span class="comment">// 使用 bcrypt 进行密码加密</span></div><div class="line">    bcrypt = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>);</div><div class="line"></div><div class="line">passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, done</span>) </span>&#123;</div><div class="line">    done(<span class="literal">null</span>, user.id);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, done</span>) </span>&#123;</div><div class="line">    User.findOne(&#123; <span class="attr">id</span>: id &#125; , <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">        done(err, user);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">passport.use(<span class="keyword">new</span> LocalStrategy(&#123;</div><div class="line">        <span class="attr">usernameField</span>: <span class="string">'email'</span>,</div><div class="line">        <span class="attr">passwordField</span>: <span class="string">'password'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">email, password, done</span>) </span>&#123;</div><div class="line"></div><div class="line">        User.findOne(&#123; <span class="attr">email</span>: email &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> done(err); &#125;</div><div class="line">            <span class="keyword">if</span> (!user) &#123;</div><div class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>, &#123; <span class="attr">message</span>: <span class="string">'Incorrect email.'</span> &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            bcrypt.compare(password, user.password, <span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!res)</div><div class="line">                    <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>, &#123;</div><div class="line">                        <span class="attr">message</span>: <span class="string">'Invalid Password'</span></div><div class="line">                    &#125;);</div><div class="line">                <span class="keyword">var</span> returnUser = &#123;</div><div class="line">                    <span class="attr">email</span>: user.email,</div><div class="line">                    <span class="attr">createdAt</span>: user.createdAt,</div><div class="line">                    <span class="attr">id</span>: user.id</div><div class="line">                &#125;;</div><div class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, returnUser, &#123;</div><div class="line">                    <span class="attr">message</span>: <span class="string">'Logged In Successfully'</span></div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">));</div></pre></td></tr></table></figure>
<h2 id="访问控制（ACL）"><a href="#访问控制（ACL）" class="headerlink" title="访问控制（ACL）"></a>访问控制（ACL）</h2><p>将 Sails 启动后，访问 <a href="http://localhost:1337" target="_blank" rel="external"> localhost:1337/register </a> 进行用户注册:</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2.png" width="500"><br></div>

<p>然后可以在 MongoDB 中看到，我们成功创建了用户:</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-2_user_created.png" width="300"><br></div>

<h3 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h3><p>如何对系统中的页面进行访问控制，这里就要用到 Sails 的核心组件 —<a href="http://www.sailsjs.org/documentation/concepts/policies" target="_blank" rel="external"> Policies </a>，接下来我们创建几个 policy 来对我们的业务逻辑进行访问控制（access control）。</p>
<p>首先，创建 api/policies/isAuthenticated.js，该 policy 用于判断请求是否得到授权（即用户是否登录）：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 用户是否被授权</div><div class="line"> * @param req</div><div class="line"> * @param res</div><div class="line"> * @param next</div><div class="line"> * @returns &#123;*&#125;</div><div class="line"> */</div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (req.isAuthenticated()) &#123;</div><div class="line">        <span class="keyword">return</span> next();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>因为本博客系统为私人博客，故在跳转到注册的业务逻辑时，我们需要知道用户是否被创建，如果用户被创建，则跳转回首页，否则继续执行注册相应逻辑：</p>
<p>创建 api/policies/userNotCreated.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// 检查数据库中是否已经有用户</span></div><div class="line">    User.find().exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(users.length)&#123;</div><div class="line">            res.redirect(<span class="string">'/logout'</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            next();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>同时，本系统显然只有当用户存在时访问才是有效地（否则没有文章来源）。创建 api/policies/userCreated.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// 检查数据库中是否已经有用户</span></div><div class="line">    User.find().exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(users.length)&#123;</div><div class="line">            next();</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            res.redirect(<span class="string">'/register'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>然后设置 config/policies.js，建立 policy 与各业务逻辑的映射关系：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Policy Mappings</div><div class="line"> */</div><div class="line"><span class="built_in">module</span>.exports.policies = &#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 默认所有行为需要登录</span></div><div class="line">    <span class="comment">// 若某些行为不需要，则在下面声明</span></div><div class="line">    <span class="string">'*'</span>: <span class="string">'isAuthenticated'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// 验证逻辑都不需要登录</span></div><div class="line">    <span class="comment">// 用户创建后不再允许注册</span></div><div class="line">    AuthController: &#123;</div><div class="line">        <span class="string">'*'</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">toRegister</span>: <span class="string">'userNotCreated'</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>true</code> 代表该业务逻辑可被任何角色访问，而通配符 <code>*</code> 则代表所有业务逻辑。</p>
<p>接下来重启 sails，并访问<a href="http://localhost:1337" target="_blank" rel="external"> localhost:1337 </a>，我们将会被跳转登录页：</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails - 登陆页面. png" width="800"><br></div>

<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>诸如站点名称（siteName），站点简介（siteDesc）等属性将经常被不止一个页面所访问，如果每次我们进行数据库查询获取这两个数据将会是十分低效的，在这里，我们通过 Sails 来设置这两个属性。</p>
<p>创建 config/site.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.site = &#123;</div><div class="line">    <span class="comment">// 站点名称</span></div><div class="line">    name  : <span class="string">""</span>,</div><div class="line">    <span class="comment">// 站点介绍</span></div><div class="line">    desc  : <span class="string">""</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>现在，在 swig 中，我们可以通过如下方式访问到这两个变量了：</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; sails.config.site.name &#125;&#125;</span><span class="xml"></span></div><div class="line"><span class="template-variable">&#123;&#123; sails.config.site.desc &#125;&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>这样的书写方式太过冗长，为此，我们修改我们的视图配置，让页面维护一个 <code>site</code> 对象：</p>
<p><strong>config/views.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> extras = <span class="built_in">require</span>(<span class="string">'swig-extras'</span>);</div><div class="line"><span class="built_in">module</span>.exports.views = &#123;</div><div class="line">    <span class="attr">engine</span>: &#123;</div><div class="line">        <span class="comment">/* Template File Extension */</span></div><div class="line">        ext: <span class="string">'swig'</span>,</div><div class="line"></div><div class="line">        <span class="comment">/* Function to handle render request */</span></div><div class="line">        fn: <span class="function"><span class="keyword">function</span> (<span class="params">path, data, cb</span>) </span>&#123;</div><div class="line">            <span class="comment">/* Swig Renderer */</span></div><div class="line">            <span class="keyword">var</span> swig = <span class="built_in">require</span>(<span class="string">'swig'</span>);</div><div class="line">            <span class="comment">// 保证我们在开发环境下每次更改 swig 不用重启 sails</span></div><div class="line">            <span class="keyword">if</span> (data.settings.env === <span class="string">'development'</span>) &#123;</div><div class="line">                swig.setDefaults(&#123;<span class="attr">cache</span>: <span class="literal">false</span>&#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 维护一个 site 变量</span></div><div class="line">            data.site = sails.config.site;</div><div class="line">            <span class="comment">// 提供一个变量标示用户是否登录</span></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> (data.isLogged) == <span class="string">'undefined'</span>) &#123;</div><div class="line">                data.isLogged = !!data.req.isAuthenticated();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * 绑定一些常用路径</div><div class="line">             * Thanks to: https://github.com/mahdaen/sails-views-swig</div><div class="line">             * */</div><div class="line">            <span class="keyword">var</span> paths = &#123;</div><div class="line">                <span class="attr">script</span>: <span class="string">'/js'</span>,</div><div class="line">                <span class="attr">style</span>: <span class="string">'/styles/default'</span>,</div><div class="line">                <span class="attr">image</span>: <span class="string">'/images'</span>,</div><div class="line">                <span class="attr">font</span>: <span class="string">'/fonts'</span>,</div><div class="line">                <span class="attr">icon</span>: <span class="string">'/icons'</span>,</div><div class="line">                <span class="attr">bower</span>: <span class="string">'/bower_components'</span></div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!data.path) &#123;</div><div class="line">                data.path = paths;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> paths) &#123;</div><div class="line">                    <span class="keyword">if</span> (!key <span class="keyword">in</span> data.path) &#123;</div><div class="line">                        data.path[key] = paths[key];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 补充 extra</span></div><div class="line">            extras.useFilter(swig, <span class="string">'split'</span>);</div><div class="line">            <span class="comment">/* Render Templates */</span></div><div class="line">            <span class="keyword">return</span> swig.renderFile(path, data, cb);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">layout</span>: <span class="string">'layout'</span>,</div><div class="line"></div><div class="line">    <span class="attr">partials</span>: <span class="literal">false</span></div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>显然，每次服务器启动的时候就应当设置这两个变量，为此，我们修改 config/bootstrap.js，该文件可以配置服务器启动时的相应动作：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.bootstrap = <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</div><div class="line">    <span class="comment">// 启动时刷新站点信息</span></div><div class="line">    User.find().exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(users.length &gt; <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">var</span> user = users[<span class="number">0</span>];</div><div class="line">            sails.config.site.name = user.siteName;</div><div class="line">            sails.config.site.desc = user.siteDesc;</div><div class="line">        &#125;</div><div class="line">        cb();</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>而每次用户信息创建或更新时也应当更新站点配置，为此，我们在 user 模型中添加新的生命期回调： <code>afterUpdate</code> 及 <code>afterCreate</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"></div><div class="line">afterCreate: <span class="function"><span class="keyword">function</span> (<span class="params">createdUser, cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.updateSite(user);</div><div class="line">    cb();</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// 用户信息更新时，更新站点信息</span></div><div class="line">afterUpdate: <span class="function"><span class="keyword">function</span> (<span class="params">user,cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.updateSite(user);</div><div class="line">    cb();</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// 更新站点信息</span></div><div class="line">updateSite: <span class="function"><span class="keyword">function</span>(<span class="params">user</span>)</span>&#123;</div><div class="line">    sails.config.site.name = user.siteName;</div><div class="line">    sails.config.site.desc = user.siteDesc;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h2><p>后端的属性验证已经在对应的 user 模型中设置好了，现在我们利用 semantic-ui 的 <a href="http://semantic-ui.com/collections/form.html" target="_blank" rel="external">表单验证模块</a> 来设置前端表单验证，让登录注册页的交互更加完整。</p>
<p>首先，我们要在 assets/js/common/main.js 中手动声明 semantic 表单验证组件的位置：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 第三方模块声明</span></div><div class="line"><span class="built_in">require</span>.config(&#123;</div><div class="line">    <span class="attr">baseUrl</span>: <span class="string">'/bower_components/'</span>,</div><div class="line">    <span class="attr">paths</span>: &#123;</div><div class="line">        <span class="attr">jquery</span>: <span class="string">'jquery/dist/jquery'</span>,</div><div class="line">        <span class="attr">requirejs</span>: <span class="string">'requirejs/require'</span>,</div><div class="line">        <span class="string">'semantic-ui'</span>: <span class="string">'semantic-ui/dist/semantic'</span>,</div><div class="line">        <span class="attr">underscore</span>: <span class="string">'underscore/underscore'</span>,</div><div class="line">        <span class="attr">backbone</span>: <span class="string">'backbone/backbone'</span>,</div><div class="line">        <span class="string">'semantic-form'</span>: <span class="string">'semantic-ui/dist/components/form.min'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">packages</span>: [</div><div class="line"></div><div class="line">    ]</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 加载 app，并运行</span></div><div class="line"><span class="built_in">require</span>([<span class="string">'/js/common/app.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">app</span>)</span>&#123;</div><div class="line">    app.init();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>接下来，我们在 assets/js/passport 目录下创建三个文件：</p>
<ul>
<li>login.js</li>
<li>register.js</li>
<li>PassportPanel.js</li>
</ul>
<p>其中，PassportPanel.js 中提供一个账户框视图组件，该组件继承自 <code>Backbone.View</code> ，供 login 及 register 两个 module 调用。</p>
<p>PassportPanel.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'semantic-form'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> PassportPanel = Backbone.View.extend(&#123;</div><div class="line">        <span class="attr">el</span>: $(<span class="string">'.passportContainer'</span>),</div><div class="line">        <span class="attr">events</span>: &#123;</div><div class="line">            <span class="string">'click input'</span>: <span class="string">'hideError'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">initialize</span>: <span class="function"><span class="keyword">function</span> (<span class="params">which</span>) </span>&#123;</div><div class="line">            <span class="comment">// 初始化时绑定表单验证</span></div><div class="line">            <span class="keyword">if</span> (which === <span class="string">'login'</span>)</div><div class="line">                <span class="keyword">this</span>.bindLoginForm();</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="keyword">this</span>.bindRegForm();</div><div class="line"></div><div class="line">        &#125;,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 聚焦输入框时，隐藏错误提示</div><div class="line">         */</div><div class="line">        hideError: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> ($(<span class="string">'.error'</span>).length &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (!$(<span class="string">'.error'</span>).is(<span class="string">':hidden'</span>)) &#123;</div><div class="line">                    $(<span class="string">'.error'</span>).hide();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 绑定登录表单验证</div><div class="line">         */</div><div class="line">        bindLoginForm: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            $(<span class="string">'.ui.form'</span>).form(&#123;</div><div class="line">                <span class="attr">inline</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">fields</span>: &#123;</div><div class="line">                    <span class="attr">email</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'email'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'email'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'请填写正确的邮箱'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">password</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'password'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'empty'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'请填写密码'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 绑定注册表单验证</span></div><div class="line">        bindRegForm: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            $(<span class="string">'.ui.form'</span>).form(&#123;</div><div class="line">                <span class="attr">inline</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">fields</span>: &#123;</div><div class="line">                    <span class="attr">siteName</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'siteName'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'empty'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'站点名不能为空'</span></div><div class="line">                            &#125;,</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'maxLength[10]'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'站点名不能超过 10 个字符'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">email</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'email'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'email'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'请填写正确的邮箱'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">password</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'password'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'length[6]'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'密码不能少于 6 位'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">siteDesc</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'siteDesc'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'maxLength[20]'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'站点简介不超过 20 字符'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> PassportPanel;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>login.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'./PassportPanel.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">PassportPanel</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">run</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="comment">// 如果有错误，则当 focus 输入域时，自动隐藏错误提示</span></div><div class="line">            <span class="keyword">var</span> loginPanel = <span class="keyword">new</span> PassportPanel(<span class="string">'login'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>register.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'./PassportPanel.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">PassportPanel</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">run</span> : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="keyword">var</span> regPanel = <span class="keyword">new</span> PassportPanel(<span class="string">'reg'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>测试一下：</p>
<div style="text-align: center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95.png" width="800"><br></div>

<h2 id="章节预告"><a href="#章节预告" class="headerlink" title="章节预告"></a>章节预告</h2><p>在下一章当中，我们开始实现博客系统的文章模块。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>吴晓军</span>
    </p>
    <p class="copyright-item">
      <span>来源: </span>
      <a href="http://yoyoyohamapi.me">http://yoyoyohamapi.me</a>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="http://yoyoyohamapi.me/2015/05/03/利用-Sails-js-MongoDB-开发博客系统（3）-账户模块/">http://yoyoyohamapi.me/2015/05/03/利用-Sails-js-MongoDB-开发博客系统（3）-账户模块/</a>
    </p>

    <p class="copyright-item lincese">
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Sails/">Sails</a>
            
              <a href="/tags/Node/">Node</a>
            
              <a href="/tags/MongoDB/">MongoDB</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2015/05/02/利用-Sails-js-MongoDB-开发博客系统（2）-框架完善/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">利用 Sails.js + MongoDB 开发博客系统（2）-- 框架完善</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2015/05/04/利用-Sails-js-MongoDB-开发博客系统（4）-文章模块/">
        <span class="next-text nav-default">利用 Sails.js + MongoDB 开发博客系统（4）-- 文章模块</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:softshot37@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/yoyoyohamapi" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://www.zhihu.com/people/wu-xiao-jun-64-55/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">吴晓军</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  




    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
