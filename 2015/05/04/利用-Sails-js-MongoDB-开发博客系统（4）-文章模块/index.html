<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="利用 Sails.js + MongoDB 开发博客系统（4）-- 文章模块"/>




  <meta name="keywords" content="Sails, Node, MongoDB, 吴小蛆的巣" />










  <link rel="alternate" href="/atom.xml" title="吴小蛆的巣">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.9.0" />



<link rel="canonical" href="http://yoyoyohamapi.me/2015/05/04/利用-Sails-js-MongoDB-开发博客系统（4）-文章模块/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.9.0" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>








<script>
  window.config = {"title":"吴小蛆的巣","subtitle":null,"description":"只要努力，蛆虫也能变成苍蝇翱翔于天际","author":"吴晓军","language":null,"timezone":null,"url":"http://yoyoyohamapi.me","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":true,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":true,"line_number":false,"tab_replace":"  "},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":"even","deploy":{"type":"git","repo":"https://github.com/yoyoyohamapi/yoyoyohamapi.github.io.git","branch":"master"},"ignore":[],"math":{"engine":"mathjax"},"sitemap":{"path":"sitemap.xml"},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":10},"index_generator":{"per_page":10},"feed":{"type":"atom","limit":20,"hub":"","content":true,"content_limit":140,"content_limit_delim":"","path":"atom.xml"},"tag_generator":{"per_page":10},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true},"server":{"log":false,"ip":"0.0.0.0"},"since":2015,"favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags","Categories":"/categories"},"color":"Default","toc":true,"fancybox":true,"pjax":true,"copyright":{"enable":true,"origin":"http://yoyoyohamapi.me","license":"本文采用<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可"},"reward":{"enable":true,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"softshot37@gmail.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/yoyoyohamapi","weibo":null,"zhihu":"https://www.zhihu.com/people/wu-xiao-jun-64-55/activities","pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":null,"app_key":null},"baidu_analytics":null,"baidu_verification":null,"google_analytics":null,"google_verification":null,"disqus_shortname":"yoyoyohamapi","version":"2.9.0"};
</script>

    <title> 利用 Sails.js + MongoDB 开发博客系统（4）-- 文章模块 - 吴小蛆的巣 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">吴小蛆的巣</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">吴小蛆的巣</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          利用 Sails.js + MongoDB 开发博客系统（4）-- 文章模块
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-05-04
        </span>
        
          <div class="post-category">
            
              <a href="/categories/利用-Sails-js-MongoDB-开发博客系统/">利用 Sails.js + MongoDB 开发博客系统</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#章节概述"><span class="toc-text">章节概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计"><span class="toc-text">设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#article-document"><span class="toc-text">article document</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#category-document"><span class="toc-text">category document</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#额外需求"><span class="toc-text">额外需求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化"><span class="toc-text">初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-api"><span class="toc-text">创建 api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-“未分类”"><span class="toc-text">创建 “未分类”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#标签统计功能"><span class="toc-text">标签统计功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MapReduce"><span class="toc-text">MapReduce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#标签统计实现"><span class="toc-text">标签统计实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-tags-api"><span class="toc-text">创建 tags api</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加路由及访问控制"><span class="toc-text">添加路由及访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#路由"><span class="toc-text">路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Policies"><span class="toc-text">Policies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#页面组织"><span class="toc-text">页面组织</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业务逻辑撰写"><span class="toc-text">业务逻辑撰写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Promise-解决难看的嵌套回调"><span class="toc-text">Promise 解决难看的嵌套回调</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编辑"><span class="toc-text">编辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#markdown-支持"><span class="toc-text">markdown 支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码高亮支持"><span class="toc-text">代码高亮支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#预览"><span class="toc-text">预览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重构标签"><span class="toc-text">重构标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#显示文章"><span class="toc-text">显示文章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#分页"><span class="toc-text">分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#业务逻辑"><span class="toc-text">业务逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#markdown-显示优化"><span class="toc-text">markdown 显示优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#章节预告"><span class="toc-text">章节预告</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <h2 id="章节概述"><a href="#章节概述" class="headerlink" title="章节概述"></a>章节概述</h2><p>在本章中，你将能学习到如下知识：</p>
<ul>
<li>认识 MongoDB 的 <code>mapReduce</code> 函数，并利用其实现标签统计功能。</li>
<li>认识 ES6 中的 Promise，了解其实现库 blue bird，为我们解决 Node 中难看的嵌套回调。</li>
<li>如何利用 markdown 来创建文章并完成代码高亮显示。</li>
</ul>
<a id="more"></a>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>我们将设计如下两个 document：</p>
<ul>
<li>文章（article）</li>
<li>分类（category）</li>
</ul>
<p>而评论将使用<a href="http://duoshuo.com/" target="_blank" rel="noopener">多说</a>。</p>
<h3 id="article-document"><a href="#article-document" class="headerlink" title="article document"></a>article document</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>类型</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>title</td>
<td>文章标题</td>
<td>string</td>
<td>必选，长度 1-20 字符</td>
</tr>
<tr>
<td>content</td>
<td>文章内容</td>
<td>string</td>
<td>必选，不少于 1 个字符</td>
</tr>
<tr>
<td>author</td>
<td>作者</td>
<td>User</td>
<td>必选</td>
</tr>
<tr>
<td>tags</td>
<td>标签</td>
<td>array</td>
<td></td>
</tr>
<tr>
<td>category</td>
<td>分类</td>
<td>Category</td>
<td>默认：未分类</td>
</tr>
</tbody>
</table>
<h3 id="category-document"><a href="#category-document" class="headerlink" title="category document"></a>category document</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>类型</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>名称</td>
<td>string</td>
<td>必选, 长度 1-20 字符</td>
</tr>
</tbody>
</table>
<h3 id="额外需求"><a href="#额外需求" class="headerlink" title="额外需求"></a>额外需求</h3><ol>
<li>用户具有默认分类：<strong>未分类</strong>。</li>
<li>每创建一篇文章，需要完成标签统计。</li>
</ol>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="创建-api"><a href="#创建-api" class="headerlink" title="创建 api"></a>创建 api</h3><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">sails <span class="keyword">generate</span> api article</span><br><span class="line">sails <span class="keyword">generate</span> api category</span><br></pre></td></tr></table></figure>
<h3 id="创建-“未分类”"><a href="#创建-“未分类”" class="headerlink" title="创建 “未分类”"></a>创建 “未分类”</h3><p>我们需要在 user 模型中的 <code>afterCreate</code> 这个生命期中存储一个默认分类：</p>
<p>api/models/Category.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Category.js</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @description :: 分类</span></span><br><span class="line"><span class="comment"> * @docs        :: http://sailsjs.org/#!documentation/models</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DEFAULT_NAME = <span class="string">"未分类"</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    attributes: &#123;</span><br><span class="line">        name: &#123;</span><br><span class="line">            type: <span class="string">"string"</span>,</span><br><span class="line">            required: <span class="literal">true</span>,</span><br><span class="line">            unique:<span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得默认分类名</span></span><br><span class="line">    getDefault: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT_NAME;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>api/models/User.js:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">   <span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 创建（注册）用户前，对用户密码加密</span></span><br><span class="line">   beforeCreate: <span class="function"><span class="keyword">function</span> (<span class="params">values, cb</span>) </span>&#123;</span><br><span class="line">       bcrypt.genSalt(<span class="number">10</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, salt</span>) </span>&#123;</span><br><span class="line">           bcrypt.hash(values.password, salt, <span class="function"><span class="keyword">function</span> (<span class="params">err, hash</span>) </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);</span><br><span class="line">               values.password = hash;</span><br><span class="line">               <span class="comment">// 执行用户定义回调</span></span><br><span class="line">               cb();</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建用户后，自动为之生成默认分类 -"未分类"，并更新站点信息</span></span><br><span class="line">   afterCreate: <span class="function"><span class="keyword">function</span> (<span class="params">createdUser, cb</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> thisModal = <span class="keyword">this</span>;</span><br><span class="line">       Category.create(&#123;<span class="attr">name</span>:Category.getDefault(),<span class="attr">creator</span>:createdUser&#125;)</span><br><span class="line">           .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,category</span>)</span>&#123;</span><br><span class="line">               <span class="keyword">if</span>(category)&#123;</span><br><span class="line">                   thisModal.updateSite(createdUser);</span><br><span class="line">                   cb();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">   &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ..</span></span><br></pre></td></tr></table></figure>
<h2 id="标签统计功能"><a href="#标签统计功能" class="headerlink" title="标签统计功能"></a>标签统计功能</h2><h3 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h3><p>如何统计所有文章中标签的出现频度，很容易想到的办法是遍历所有文章来统计各个标签的出现的次数，但这样做是十分低效的，为了完成这个需求，我们将利用 MongoDB 中的 <code>mapReduce()</code> 函数，相应知识可以参考官方文档：<a href="http://docs.mongodb.org/manual/core/map-reduce/" target="_blank" rel="noopener">Map Reduce</a></p>
<p>这里以一个例子简要的介绍一下 MongoDB 的 <code>mapReduce()</code>。考虑一个学生（Student）集合（collection），当中有如下三个学生文档（document）：张三，李四，王五</p>
<p>张三：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  name: "张三",</span><br><span class="line">  class: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>李四：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  name: "李四",</span><br><span class="line">  class: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>王五：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  name: "王五",</span><br><span class="line">  class: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们利用 Map Reduce 来统计各个班级的学生人数，首先我们要进行一个 map 过程，该过程就是__根据一定条件将划分数据。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  emit(<span class="keyword">this</span>.class,&#123;<span class="attr">count</span>:<span class="number">1</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>emit(参数 1, 参数 2)</code> 方法，我们就能获得输出键值对（key-value）。其中，<code>参数 1</code> 可以看做我们数据的划分依据，例如，本例中我们是根据班级进行划分，而 <code>参数 2</code> 则是要传入这个划分的值，本例中，每个班级下，我们需要学生人数统计 <code>count:1</code>。</p>
<p>本例中，map 过程将会为我们产生两个文档，分别是：</p>
<p><strong>班级 1</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;1,[&#123;count:1&#125;,&#123;count:1&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p><strong>班级 2</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;2,&#123;count:1&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>下面再通过 reduce 过程对 map 产生的键值对进行处理，输出每个班的人数：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> reduce = <span class="function"><span class="keyword">function</span>(<span class="params">key,values</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = &#123;<span class="attr">count</span>:<span class="number">0</span>&#125;</span><br><span class="line">  values.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    res.count += value.count;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>! 重要：reduce 函数中接收的 <code>values</code> 参数的形式，必须和 reduce 函数返回的结果 <code>res</code> 的形式一致。</p>
</blockquote>
<p>本例中，reduce 过程将产生两个文档：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  _id: 1</span><br><span class="line">  value: &#123;count:2&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">_id: 2</span><br><span class="line">value: &#123;count:1&#125;</span><br></pre></td></tr></table></figure>
<p>最后，通过 MongoDb 的 <code>mapReduce()</code> 函数将统计信息输出到 <code>statistics</code> 集合中：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">db.student.mapReduce(map,reduce,&#123;<span class="attr">out</span>:<span class="string">"statistics"</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>现在我们执行</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.statistics</span><span class="selector-class">.find</span>();</span><br></pre></td></tr></table></figure>
<p>将能看到如下结果：</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-mapreduce_result.png" width="300"><br></div>

<h3 id="标签统计实现"><a href="#标签统计实现" class="headerlink" title="标签统计实现"></a>标签统计实现</h3><p>借助 sails 中 <a href="http://sailsjs.org/documentation/reference/waterline-orm/models/native" target="_blank" rel="noopener"> <code>native()</code> </a> 方法，我们可以封装 <code>mapreduce()</code> 函数到我们的业务逻辑中：</p>
<p>api/models/Article.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Article.js</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @description :: 文章模型</span></span><br><span class="line"><span class="comment"> * @docs        :: http://sailsjs.org/#!documentation/models</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义 Article 集合的 map，reduce 函数, 统计标签</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> map = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 分类依据组成为："用户 ID: 标签"</span></span><br><span class="line">    <span class="keyword">this</span>.tags.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">tag</span>) </span>&#123;</span><br><span class="line">        emit(tag, <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> reduce = <span class="function"><span class="keyword">function</span> (<span class="params">k, values</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> total = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">        total += values[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    attributes: &#123;</span><br><span class="line">        title: &#123;</span><br><span class="line">            type: <span class="string">'string'</span>,</span><br><span class="line">            required: <span class="literal">true</span>,</span><br><span class="line">            minLength: <span class="number">1</span>,</span><br><span class="line">            maxLength: <span class="number">40</span></span><br><span class="line">        &#125;,</span><br><span class="line">        content: &#123;</span><br><span class="line">            type: <span class="string">'string'</span>,</span><br><span class="line">            required: <span class="literal">true</span>,</span><br><span class="line">            minLength: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        tags: &#123;</span><br><span class="line">            type: <span class="string">'array'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        category: &#123;</span><br><span class="line">            model: <span class="string">'category'</span>,</span><br><span class="line">            required: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每次文章创建完成，更新标签统计</span></span><br><span class="line">    afterCreate: <span class="function"><span class="keyword">function</span> (<span class="params">article, cb</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.updateTags();</span><br><span class="line">        cb();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//custom</span></span><br><span class="line">    updateTags: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Article.native(<span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span> res.serverError(err);</span><br><span class="line">            collection.mapReduce(map, reduce, &#123;<span class="attr">out</span>: <span class="string">"tags"</span>&#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="创建-tags-api"><a href="#创建-tags-api" class="headerlink" title="创建 tags api"></a>创建 tags api</h3><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line">sails <span class="keyword">generate</span> api tags</span><br></pre></td></tr></table></figure>
<h2 id="添加路由及访问控制"><a href="#添加路由及访问控制" class="headerlink" title="添加路由及访问控制"></a>添加路由及访问控制</h2><h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p><strong>_config/routes.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//----------------Aticles</span></span><br><span class="line">   <span class="comment">// 默认显示全部文章</span></span><br><span class="line">   <span class="string">'/'</span>: <span class="string">'ArticleController.index'</span>,</span><br><span class="line">   <span class="comment">// 显示某篇文章</span></span><br><span class="line">   <span class="string">'get /article/show/:id'</span> : <span class="string">'ArticleController.show'</span>,</span><br><span class="line">   <span class="comment">// 跳转到创建文章页</span></span><br><span class="line">   <span class="string">'get /article/new'</span>: <span class="string">'ArticleController.new'</span>,</span><br><span class="line">   <span class="comment">// 跳转到编辑文章页</span></span><br><span class="line">   <span class="string">'get /article/edit/:id'</span>: <span class="string">'ArticleController.edit'</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 显示分类下的全部文章</span></span><br><span class="line">   <span class="string">'/category/:id/articles/:page'</span>: <span class="string">'CategoryController.getArticles'</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 显示标签下的全部文章</span></span><br><span class="line">   <span class="string">'/tag/:name/articles/:page'</span>: <span class="string">'TagsController.getArticles'</span>,</span><br></pre></td></tr></table></figure>
<h3 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h3><p>config/polies.js:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 文章显示逻辑不需要登录</span></span><br><span class="line">    ArticleController: &#123;</span><br><span class="line">        index: <span class="string">'userCreated'</span>,</span><br><span class="line">        show: <span class="string">'userCreated'</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    CategoryController: &#123;</span><br><span class="line">        getArticles: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    TagsController: &#123;</span><br><span class="line">        getArticles: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="页面组织"><a href="#页面组织" class="headerlink" title="页面组织"></a>页面组织</h2><p>我是采用如下的页面组织方式:</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-article_views.png" width="300"><br></div>

<p>其中编辑页面和创建页面因为逻辑相似，二者共用 save.swig，其中含有一个编辑器 _editor.swig 的子页面，建议所有内嵌的子页面都以下划线开头，以示区分。</p>
<h2 id="业务逻辑撰写"><a href="#业务逻辑撰写" class="headerlink" title="业务逻辑撰写"></a>业务逻辑撰写</h2><p>api/controllers/ArticleController.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳至创建文章</span></span><br><span class="line">    <span class="keyword">new</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取分类</span></span><br><span class="line">        Category.find()</span><br><span class="line">            .exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, categories</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">                    <span class="keyword">return</span> res.view(</span><br><span class="line">                        <span class="string">'article/save'</span>,</span><br><span class="line">                        &#123;</span><br><span class="line">                            categories: categories,</span><br><span class="line">                            form: &#123;<span class="attr">action</span>: <span class="string">'/article'</span>, <span class="attr">method</span>: <span class="string">'POST'</span>&#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    )</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳至修改文章:</span></span><br><span class="line">    edit: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取文章</span></span><br><span class="line">        <span class="keyword">var</span> id = req.param(<span class="string">'id'</span>);</span><br><span class="line">        Article.findOne(id).exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, article</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 如果不存在，404</span></span><br><span class="line">            <span class="keyword">if</span> (article) &#123;</span><br><span class="line">                <span class="comment">// 获取分类</span></span><br><span class="line">                Category.find()</span><br><span class="line">                    .exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, categories</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">                            <span class="keyword">return</span> res.view(</span><br><span class="line">                                <span class="string">'article/save'</span>,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    article: article,</span><br><span class="line">                                    categories: categories,</span><br><span class="line">                                    form: &#123;<span class="attr">action</span>: <span class="string">'/article/'</span> + id, <span class="attr">method</span>: <span class="string">'PUT'</span>&#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            )</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> res.notFound();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Promise-解决难看的嵌套回调"><a href="#Promise-解决难看的嵌套回调" class="headerlink" title="Promise 解决难看的嵌套回调"></a>Promise 解决难看的嵌套回调</h3><p>OK，可以看到，我们已经遇到了 Node 常见的多层嵌套回调了，不断横向延伸的代码感觉就像闷了口大翔在嘴里，非常不舒服，在 ES6 中，可以通过 <a href="https://promisesaplus.com/" target="_blank" rel="noopener"> Promise </a> 来解决嵌套的回调，下面简要介绍一下 Promise。</p>
<p>顾名思义，Promise 代表一种“许诺”，也就是未来才会发生的东西，如同现实生活中的许诺一样，它会被“履行（fulfiled）” 或者 “拒绝履行（rejected）”，Promise 的核心方法为 <code>then(onFulfiled,onRejected)</code>，通过 <code>then</code>，我们就能构造一个不断向下的过程，而不是横向延伸。</p>
<p>看个栗子：</p>
<p>一个 Ajax 请求的嵌套回调:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 首先我要得到一篇文章</span></span><br><span class="line">$.get(<span class="string">'/article'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="comment">// 在回调中得到该文章所有的评论</span></span><br><span class="line">    $.get(article.commentsURL,<span class="function"><span class="keyword">function</span>(<span class="params">err,comments</span>)</span>&#123;</span><br><span class="line">      <span class="comment">//doSomething</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>经 Promise 处理后的代码:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$.get(<span class="string">'/article'</span>)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">article</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $.get(article.commentsURL);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">comments</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// doSomething</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// error handler</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>显然，这种向下的逐级传递使得回调逻辑更加易读以及易维护。想更深入了解 Promise，可以参看<a href="http://spion.github.io/posts/why-i-am-switching-to-promises.html" target="_blank" rel="noopener">这篇文章</a>.</p>
<p>Sails 所采用的 Waterline 也提倡我们进行 Promise 式的书写，其所采用的 Promise 实现库是<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener"> blue bird </a>。现在我们通过 blue bird 对编辑文章的业务逻辑进行重构：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 跳至修改文章:</span></span><br><span class="line">edit: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取文章</span></span><br><span class="line">    <span class="keyword">var</span> id = req.param(<span class="string">'id'</span>);</span><br><span class="line">    Article.findOne(id).populate(<span class="string">'category'</span>)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">article</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> [article,Category.find()];</span><br><span class="line">        &#125;)</span><br><span class="line">        .spread(<span class="function"><span class="keyword">function</span> (<span class="params">article, categories</span>) </span>&#123;</span><br><span class="line">            res.view(</span><br><span class="line">                <span class="string">'article/save'</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                    article: article,</span><br><span class="line">                    categories: categories,</span><br><span class="line">                    form: &#123;<span class="attr">action</span>: <span class="string">'/article/'</span> + id, <span class="attr">method</span>: <span class="string">'PUT'</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            res.notFound();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们访问<a href="http://localhost:1337/article/new" target="_blank" rel="noopener"> localhost:1337/article/new </a>，进入如下页面:</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-%E5%88%9B%E5%BB%BA%E6%96%87%E7%AB%A0.png" width="800"><br></div>

<h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><h3 id="markdown-支持"><a href="#markdown-支持" class="headerlink" title="markdown 支持"></a>markdown 支持</h3><p>个人不喜欢用富文本编辑器，技术博客最好的写作工具还是 markdown，下面我们通过 bower 来为前端添加 markdown 解析，这里我用的<a href="https://github.com/chjj/marked" target="_blank" rel="noopener"> marked </a>。</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bower </span>install <span class="keyword">marked </span>--save</span><br></pre></td></tr></table></figure>
<h3 id="代码高亮支持"><a href="#代码高亮支持" class="headerlink" title="代码高亮支持"></a>代码高亮支持</h3><p>对于代码高亮，选择老牌的<a href="https://highlightjs.org/" target="_blank" rel="noopener"> highlight.js </a>，它提供了不少很骚的主题。</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bower </span><span class="keyword">install </span>highlightjs --save</span><br></pre></td></tr></table></figure>
<p>记得将喜欢的高亮主题 css 添加到页面，否则看不到加亮效果</p>
<p>views/article/layout.swig:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> '../partial/layout.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/article.css"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.bower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/highlightjs/styles/solarized_dark.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p>现在，我们可以试试效果了，在表单创建相应内容，然后单击预览看看效果：</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-4_article_edit.png" width="800"><br></div>

<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-4_article_preview.png" width="800"><br></div>

<blockquote>
<p>在创建 / 编辑文章前端逻辑中，新用到的 semantic-ui 的组件有<a href="http://www.semantic-ui.cn/modules/modal.html" target="_blank" rel="noopener"> modal </a></p>
</blockquote>
<h3 id="重构标签"><a href="#重构标签" class="headerlink" title="重构标签"></a>重构标签</h3><p>因为表单发送的标签（tags）是字符串，而实际上我们的标签在数据库中的组织形式是数组，所以我们需要在 <strong> 每次后端验证 article 的表单前 </strong> 对发送过来的标签进行处理，将其转换为字符串形式，并保证每个标签的有效性和唯一性：</p>
<p>api/models/Article.js 中为 <code>beforeValidate</code> 生命期添加逻辑:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 文章验证前，重构标签</span></span><br><span class="line">    beforeValidate: <span class="function"><span class="keyword">function</span>(<span class="params">article,cb</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(article.tags.length) &#123;</span><br><span class="line">            <span class="keyword">var</span> rowTags = article.tags[<span class="number">0</span>].split(<span class="string">""</span>);</span><br><span class="line">            article.tags = [];</span><br><span class="line">            <span class="comment">// 去除空标签及重复标签</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;rowTags.length;i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> tag = rowTags[i].replace(<span class="string">" "</span>,<span class="string">""</span>);</span><br><span class="line">                <span class="keyword">if</span>(tag.length&gt;<span class="number">0</span> &amp;&amp; (article.tags.indexOf(tag)&lt;<span class="number">0</span>))&#123;</span><br><span class="line">                    article.tags.push(tag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cb();</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<h2 id="显示文章"><a href="#显示文章" class="headerlink" title="显示文章"></a>显示文章</h2><h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>考虑到访问性能，我们要进行分页，分页采用 “下一页” 方式，操作方式为 “点击加载”。</p>
<p>Waterline 通过 <code>paginate()</code> 函数实现分页：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Model.find().paginate(&#123;<span class="attr">page</span>: <span class="number">2</span>, <span class="attr">limit</span>: <span class="number">10</span>&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h3><p>在 api/controllers/ArticleController.js 添加文章显示的业务逻辑:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 文章查询顺序：以更新时间逆序</span></span><br><span class="line">FIND_ORDER = <span class="string">'updatedAt desc'</span>;</span><br><span class="line"><span class="comment">// 文章每页条目数</span></span><br><span class="line">FIND_PER_PAGE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文章查询顺序：以更新时间逆序</span></span><br><span class="line">FIND_ORDER = <span class="string">'updatedAt desc'</span>;</span><br><span class="line"><span class="comment">// 文章每页条目数</span></span><br><span class="line">FIND_PER_PAGE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 首页显示文章</span></span><br><span class="line"><span class="comment">     * @param req</span></span><br><span class="line"><span class="comment">     * @param res</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    index:<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 获得当前需要加载第几页</span></span><br><span class="line">        <span class="keyword">var</span> page = req.param(<span class="string">'page'</span>) ? req.param(<span class="string">'page'</span>) : <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 如果是第 1 页，则需要加载分类以及标签</span></span><br><span class="line">        <span class="keyword">if</span>( page==<span class="number">1</span> ) &#123;</span><br><span class="line">            Article.find(&#123;</span><br><span class="line">                sort: FIND_ORDER,</span><br><span class="line">            &#125;).paginate(&#123;<span class="attr">page</span>: page, <span class="attr">limit</span>: FIND_PER_PAGE&#125;)</span><br><span class="line">                .populate(<span class="string">'category'</span>).then(<span class="function"><span class="keyword">function</span> (<span class="params">articles</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// 每篇文章转换</span></span><br><span class="line">                    <span class="comment">// 查找分类, 及标签</span></span><br><span class="line">                    <span class="keyword">return</span> [</span><br><span class="line">                        articles,</span><br><span class="line">                        Category.find(),</span><br><span class="line">                        Tags.find()</span><br><span class="line">                    ];</span><br><span class="line">                &#125;)</span><br><span class="line">                .spread(<span class="function"><span class="keyword">function</span> (<span class="params">articles, categories, tags</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> res.view(</span><br><span class="line">                        <span class="string">'article/index'</span>,</span><br><span class="line">                        &#123;</span><br><span class="line">                            articles: articles,</span><br><span class="line">                            categories: categories,</span><br><span class="line">                            tags: tags,</span><br><span class="line">                            page: page</span><br><span class="line">                        &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            Article.find(&#123;</span><br><span class="line">                    sort: FIND_ORDER,</span><br><span class="line">                &#125;).paginate(&#123;<span class="attr">page</span>: page, <span class="attr">limit</span>: FIND_PER_PAGE&#125;)</span><br><span class="line">                .populate(<span class="string">'category'</span>).exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, articles</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">                        <span class="comment">// 刷新下一页</span></span><br><span class="line">                        <span class="keyword">return</span> res.view(</span><br><span class="line">                            <span class="string">'article/_article'</span>,</span><br><span class="line">                            &#123;</span><br><span class="line">                                articles: articles,</span><br><span class="line">                                page: page</span><br><span class="line">                            &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示某篇文章</span></span><br><span class="line">    show:<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> id = req.param(<span class="string">'id'</span>);</span><br><span class="line">        Article.findOne(id).populate(<span class="string">'category'</span>).</span><br><span class="line">            exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, article</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                res.notFound();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res.view(<span class="string">'article/show'</span>,&#123;</span><br><span class="line">                    articles: [article]</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//..............</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="markdown-显示优化"><a href="#markdown-显示优化" class="headerlink" title="markdown 显示优化"></a>markdown 显示优化</h3><p>我自己小改了一下 git 的 markdown theme，主要是去掉了自带的代码高亮，来使得 markdown 解析出的内容效果更加舒适，相应文件在<a href="https://github.com/yoyoyohamapi/blog/blob/master/assets/sass/default/markdown.scss" target="_blank" rel="noopener">这儿</a>。</p>
<p>在 views/article/layout.swig 引入 css：</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> '../partial/layout.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/article.css"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.bower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/highlightjs/styles/solarized_dark.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/markdown.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>OK，访问 <a href="http://localhost:1337" target="_blank" rel="noopener"> localhost:1337 </a> 看一下效果：</p>
<div style="text-align:center"><br><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-4_article_index.png" width="800"><br></div>

<h2 id="章节预告"><a href="#章节预告" class="headerlink" title="章节预告"></a>章节预告</h2><p>下一章节中，我们将实现个人信息维护功能。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://yoyoyohamapi.me">吴晓军</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://yoyoyohamapi.me/2015/05/04/利用-Sails-js-MongoDB-开发博客系统（4）-文章模块/">http://yoyoyohamapi.me/2015/05/04/利用-Sails-js-MongoDB-开发博客系统（4）-文章模块/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden />
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Sails/">Sails</a>
            
              <a href="/tags/Node/">Node</a>
            
              <a href="/tags/MongoDB/">MongoDB</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2015/05/05/利用-Sails-js-MongoDB-开发博客系统（5）-个人信息维护/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">利用 Sails.js + MongoDB 开发博客系统（5） -- 个人信息维护</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2015/05/03/利用-Sails-js-MongoDB-开发博客系统（3）-账户模块/">
        <span class="next-text nav-default">利用 Sails.js + MongoDB 开发博客系统（3）-- 账户模块</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:softshot37@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/yoyoyohamapi" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://www.zhihu.com/people/wu-xiao-jun-64-55/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">吴晓军</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoyoyohamapi.me/2015/05/04/利用-Sails-js-MongoDB-开发博客系统（4）-文章模块/';
        this.page.identifier = '2015/05/04/利用-Sails-js-MongoDB-开发博客系统（4）-文章模块/';
        this.page.title = '利用 Sails.js + MongoDB 开发博客系统（4）-- 文章模块';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//yoyoyohamapi.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.9.0"></script>

  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
