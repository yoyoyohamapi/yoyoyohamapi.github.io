<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="只要努力，蛆虫也能变成苍蝇翱翔于天际"/>







  <link rel="alternate" href="/atom.xml" title="吴小蛆的巣">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x" />



<link rel="canonical" href="http://yoyoyohamapi.me/"/>


<meta name="description" content="只要努力，蛆虫也能变成苍蝇翱翔于天际">
<meta property="og:type" content="website">
<meta property="og:title" content="吴小蛆的巣">
<meta property="og:url" content="http://yoyoyohamapi.me/index.html">
<meta property="og:site_name" content="吴小蛆的巣">
<meta property="og:description" content="只要努力，蛆虫也能变成苍蝇翱翔于天际">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="吴小蛆的巣">
<meta name="twitter:description" content="只要努力，蛆虫也能变成苍蝇翱翔于天际">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />







<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  



    <title> 吴小蛆的巣 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">吴小蛆的巣</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">吴小蛆的巣</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              Tags
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              Categories
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/29/斯坦福机器学习笔记/">斯坦福机器学习笔记</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Apr 29, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>系列文章已发布至 <a href="https://www.gitbook.com/book/yoyoyohamapi/mit-ml" target="_blank" rel="external">Gitbook</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Image_Processing/数字图像处理（17）-- 颜色知识(4)：全彩色图像处理/">数字图像处理（17）-- 颜色知识 (4)：全彩色图像处理</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>全彩色（full color）图像的处理通常有以下两种策略：</p>
<ol>
<li><p>对每一个颜色分量（通道）进行处理，得到各个分量的处理结果，最后进行叠加操作。</p>
</li>
<li><p>对整个像素的颜色向量进行处理，得到整个图的处理结果。</p>
</li>
</ol>
<p>先看一个对每个分量进行线性变换的处理，在该例子中，分别在 RGB 颜色模型和 HSV 颜色模型中对全彩色图像进行处理。</p>
<p>在 RGB 颜色模型中，变换函数为：</p>
<p>$s_i=kr_i$  $(i=1,2,3)$</p>
<p>其中，$s_i$ 为目标颜色分量 i 强度，$r_i$ 为原图像颜色分量 i 强度。</p>
<p>在 HSV 颜色模型中，变换函数为：</p>
<p>$s_3=kr_3$</p>
<p>即在 HSV 颜色模型中，只对强度 V 做线性变化。</p>
<p>当 $K=0.75$ 时，有如下处理结果：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 对 V 通道最线性变换. png" alt="对 V 通道做线性变换"></p>
<p>代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv/cv.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</div><div class="line"></div><div class="line"><span class="comment">// 图像处理基础素材路径</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BASEPATH <span class="meta-string">"/Users/feiyu06/Pictures/img_processing/"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE unsigned char</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 图像路径</span></div><div class="line">    <span class="built_in">string</span> img_path = <span class="string">"DIP3E_Original_Images_CH06/Fig0631(a)(strawberries_coffee_full_color).tif"</span>;</div><div class="line">    Mat img = imread(BASEPATH+img_path, <span class="number">1</span>);</div><div class="line">    <span class="comment">//img_rgb_processed 为 rgb 颜色模型处理后的图像</span></div><div class="line">    Mat img_rgb_processed;</div><div class="line">    <span class="comment">//img</span></div><div class="line">    Mat img_hsv_processed;</div><div class="line">    cvtColor(img, img_hsv_processed,CV_BGR2HSV);</div><div class="line">    img_hsv_processed.convertTo(img_hsv_processed, CV_32F);</div><div class="line">    img.convertTo(img, CV_32F);</div><div class="line">    <span class="comment">// 原图像大小</span></div><div class="line">    Size size = img.size();</div><div class="line">    <span class="comment">// 原图像通道数</span></div><div class="line">    <span class="keyword">int</span> channels_num = img.channels();</div><div class="line">    <span class="comment">// 拆分用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; s_channels(channels_num);</div><div class="line">    <span class="comment">// 合并用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; m_channels(channels_num);</div><div class="line">    <span class="comment">//************************ 开始进行 RGB 颜色空间的亮度降低 ***************************</span></div><div class="line">    split(img,s_channels);</div><div class="line">    <span class="comment">// 线性变化的 k 值</span></div><div class="line">    <span class="keyword">double</span> k = <span class="number">0.75</span>;</div><div class="line">    <span class="keyword">int</span> i,j;</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;channels_num;i++)&#123;</div><div class="line">        <span class="comment">// 灰度归一化处理</span></div><div class="line">        normalize(s_channels[i], s_channels[i],<span class="number">1.0</span>,<span class="number">0</span>,NORM_MINMAX);</div><div class="line">        m_channels[i] = s_channels[i]*k;</div><div class="line">    &#125;</div><div class="line">    merge(m_channels,img_rgb_processed);</div><div class="line">    <span class="comment">//****************************************************************************</span></div><div class="line">    </div><div class="line">    <span class="comment">//*********************** 开始进行 HSV 颜色空间的亮度降低 ****************************</span></div><div class="line">    split(img_hsv_processed,s_channels);</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;channels_num;i++)&#123;</div><div class="line">        <span class="keyword">if</span>(i==<span class="number">2</span>)&#123;</div><div class="line">            <span class="comment">// 灰度归一化处理</span></div><div class="line">            m_channels[i] = s_channels[i]*k;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            m_channels[i] = s_channels[i];</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    merge(m_channels,img_hsv_processed);</div><div class="line">    <span class="comment">// 将 HSV 图像转换为 BGR 图像，方便显示</span></div><div class="line">    convertScaleAbs(img_hsv_processed, img_hsv_processed);</div><div class="line">    cvtColor(img_hsv_processed, img_hsv_processed, CV_HSV2BGR);</div><div class="line">    <span class="comment">//*****************************************************************************</span></div><div class="line">    <span class="comment">// 接下来是图像显示</span></div><div class="line">    convertScaleAbs(img, img);</div><div class="line">    namedWindow(<span class="string">"src pic"</span>, WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"rgb processed pic"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"hsv processed pic"</span>,WINDOW_AUTOSIZE);</div><div class="line">    imshow(<span class="string">"src pic"</span>, img);</div><div class="line">    imshow(<span class="string">"rgb processed pic"</span>,img_rgb_processed);</div><div class="line">    imshow(<span class="string">"hsv processed pic"</span>,img_hsv_processed);</div><div class="line">    waitKey(<span class="number">0</span>);</div><div class="line">    <span class="comment">//return</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，在 RGB 颜色模型和 HSV 颜色模型中，达到了相同的降低亮度的效果，然而 HSV 中只需对强度 V 这一个分量进行操作即可，这也体现出了 HSV 的<strong>“分离了灰度（亮度）和颜色信息”</strong>这一优势。</p>
<h2 id="彩色分割"><a href="#彩色分割" class="headerlink" title="彩色分割"></a>彩色分割</h2><p>进行彩色分割的目的就在于突出图像中感兴趣的区域，由于彩色图像多是定义在三维空间，所以感兴趣的区域不再是平面线段，而是空间立体区域，通常有：</p>
<p>立方体区域：</p>
<p>$s_i=\begin{cases}0.5&amp;\text{if }[|r_j-a<em>j|&gt; \frac{w}{2}]</em>{any 1\leq{j}\leq{n}}\r_i&amp;\text{otherwise}\end{cases}$  $i=1,2,3….,n$</p>
<p>其中，$a_j$ 为感兴趣的颜色分量 $j$,$W$ 为感兴趣颜色立方体边长,$W$ 也可看做是最大不能偏离兴趣颜色分量的距离。考虑某颜色分量与感兴趣的颜色分量间的差值关系，若有任意一对分量差超过 $\frac{W}{2}$, 则输出的颜色分量被标定为 $0.5$。</p>
<p>例如，若感兴趣的颜色分量为(0.2,0.3,0.5),W=0.2, 则 $\frac{W}{2}$=0.1; 考虑某像素的颜色为(0,1,0,4,0.3)，那么颜色分量 $r_2=0.4$ 的输出应为多少？</p>
<p>因为：</p>
<p>$|0.1-0.2|=0.1\leq\frac{W}{2}$</p>
<p>$|0.4-0.3|=0.1\leq\frac{W}{2}$</p>
<p>$|0.3-0.5|=0.2\gt\frac{W}{2}$</p>
<p>故颜色分量 $r_2=0.4$ 的输出应为 $s_2=0.5$</p>
<p>球体区域：</p>
<p>$s<em>i=\begin{cases}0.5&amp;\text{if }\sum\limits</em>{j=1}^n(r_j-a_j)^2\gt R_0^2\r_i&amp;\text{otherwise}\end{cases}$</p>
<p>其中，$R_0$ 为球体半径</p>
<p>如下图所示，采用的 $W=0.1049$，突出显示了草莓区域：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 彩色分割. png" alt="彩色图像分割"></p>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv/cv.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</div><div class="line"></div><div class="line"><span class="comment">// 图像处理基础素材路径</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BASEPATH <span class="meta-string">"/Users/feiyu06/Pictures/img_processing/"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE unsigned char</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 图像路径</span></div><div class="line">    <span class="built_in">string</span> img_path = <span class="string">"DIP3E_Original_Images_CH06/Fig0631(a)(strawberries_coffee_full_color).tif"</span>;</div><div class="line">    Mat img = imread(BASEPATH+img_path, <span class="number">1</span>);</div><div class="line">    img.convertTo(img, CV_32FC3);</div><div class="line">    Mat img_dst = img.clone();</div><div class="line">    </div><div class="line">    <span class="comment">// 设定立方体边长</span></div><div class="line">    <span class="keyword">float</span> W = <span class="number">0.1049</span>;</div><div class="line">    <span class="comment">// 感兴趣的颜色</span></div><div class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; itst = &#123;<span class="number">0.1922</span>,<span class="number">0.1608</span>,<span class="number">0.6863</span>&#125;;</div><div class="line">    <span class="function">Mat <span class="title">interest</span><span class="params">(itst)</span></span>;</div><div class="line">    <span class="comment">// 用于分离通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; s_channels(img.channels());</div><div class="line">    split(img,s_channels);</div><div class="line">    <span class="keyword">int</span> i,j,k;</div><div class="line">    <span class="comment">// 标定每一个通道</span></div><div class="line">    <span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;img.channels();k++)&#123;</div><div class="line">        normalize(s_channels[k],s_channels[k],<span class="number">1.0</span>,<span class="number">0.0</span>,NORM_MINMAX);</div><div class="line">    &#125;    <span class="comment">// 遍历像素</span></div><div class="line">    merge(s_channels, img);</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;img.rows;i++)</div><div class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;img.cols;j++)&#123;</div><div class="line">            Mat r = interest.clone();</div><div class="line">            r.at&lt;<span class="keyword">float</span>&gt;(<span class="number">0</span>,<span class="number">0</span>) = img.at&lt;Vec3f&gt;(i,j)[<span class="number">0</span>];</div><div class="line">            r.at&lt;<span class="keyword">float</span>&gt;(<span class="number">1</span>,<span class="number">0</span>) = img.at&lt;Vec3f&gt;(i,j)[<span class="number">1</span>];</div><div class="line">            r.at&lt;<span class="keyword">float</span>&gt;(<span class="number">2</span>,<span class="number">0</span>) = img.at&lt;Vec3f&gt;(i,j)[<span class="number">2</span>];</div><div class="line">            <span class="keyword">double</span> max,min;</div><div class="line">            <span class="comment">// 获得距离矩阵</span></div><div class="line">            Mat distance = <span class="built_in">abs</span>(r-interest);</div><div class="line">            minMaxLoc(distance, &amp;min, &amp;max);</div><div class="line">            <span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;img.channels();k++)&#123;</div><div class="line">                <span class="keyword">if</span>( min &gt; (W/<span class="number">2.0</span>) )</div><div class="line">                    img_dst.at&lt;Vec3f&gt;(i,j)[k]=<span class="number">0.5</span>;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    img_dst.at&lt;Vec3f&gt;(i,j)[k]=r.at&lt;<span class="keyword">float</span>&gt;(k,<span class="number">0</span>);</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    namedWindow(<span class="string">"src image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"dst image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    imshow(<span class="string">"src image"</span>,img);</div><div class="line">    imshow(<span class="string">"dst image"</span>, img_dst);</div><div class="line">    waitKey(<span class="number">0</span>);</div><div class="line">    <span class="comment">//return</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="直方图处理："><a href="#直方图处理：" class="headerlink" title="直方图处理："></a>直方图处理：</h2><p>彩色图像的直方图处理通常只需要在灰度级完成，而非对每个颜色通道都进行直方图操作，故而我们在彩色图像的直方图处理中考虑使用 HSI（HSV）颜色模型。</p>
<p>下面我们看一则例子, 这则例子中，原图像亮度偏暗，操作其 V 通道进行直方图均衡化处理，加强了亮度：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 直方图处理. png" alt="V 通道直方图均衡化"></p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 直方图对比. png" alt="直方图对比"></p>
<h2 id="彩色图像模糊与锐化："><a href="#彩色图像模糊与锐化：" class="headerlink" title="彩色图像模糊与锐化："></a>彩色图像模糊与锐化：</h2><p>在 RGB 颜色空间中，一般的线性处理（如均值滤波）分别作用在各通道的结果等于直接作用在颜色向量的结果，然而，如统计排序滤波（如中值滤波等）这些非线性操作就不适用了，你很难衡量向量间的大小关系。</p>
<p>通常，为了不影响彩色图像的颜色信息，我们更乐意在 HSV 图像下的 V 通道（即灰度图）下进行图像的模糊处理。下面是一则例子，在这则例子中，分别对 RGB 图像的三个通道做均值滤波处理，而在 HSV 图像的 V 通道做均值滤波，在第四幅图（用对数进行过对比度增强，实际差异较小）中可以看到，二者的模糊效果还是有所差异：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 彩色图像锐化. png" alt="彩色图像模糊"></p>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv/cv.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</div><div class="line"></div><div class="line"><span class="comment">// 图像处理基础素材路径</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BASEPATH <span class="meta-string">"/Users/feiyu06/Pictures/img_processing/"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE unsigned char</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 图像路径</span></div><div class="line">    <span class="built_in">string</span> img_path = <span class="string">"DIP3E_Original_Images_CH06/Fig0638(a)(lenna_RGB).tif"</span>;</div><div class="line">    Mat img = imread(BASEPATH+img_path, <span class="number">1</span>);</div><div class="line">    Mat img_bgr = img.clone();</div><div class="line">    <span class="comment">// 将图像转换到 HSV 颜色空间</span></div><div class="line">    Mat img_hsv;</div><div class="line">    cvtColor(img, img_hsv, CV_BGR2HSV);</div><div class="line">    <span class="comment">// 分离用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt;  s_channels(img.channels());</div><div class="line">    <span class="comment">// 合并用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; m_channels(img.channels());</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="comment">//********************************* 完成 RGB 图像的模糊处理 ***********************************************</span></div><div class="line">    split(img_bgr,s_channels);</div><div class="line">    <span class="comment">// 对各通道进行均值滤波</span></div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;img_bgr.channels();i++)&#123;</div><div class="line">        blur(s_channels[i], m_channels[i],&#123;<span class="number">3</span>,<span class="number">3</span>&#125;);</div><div class="line">    &#125;</div><div class="line">    merge(m_channels,img_bgr);</div><div class="line">    <span class="comment">//********************************* 完成 HSV 图像的模糊处理 ***********************************************</span></div><div class="line">    split(img_hsv,s_channels);</div><div class="line">    <span class="comment">// 仅对 V 通道进行均值滤波</span></div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;img_hsv.channels();i++)&#123;</div><div class="line">        <span class="keyword">if</span>(i==<span class="number">2</span>)</div><div class="line">            blur(s_channels[i], m_channels[i], &#123;<span class="number">3</span>,<span class="number">3</span>&#125;);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            m_channels[i] = s_channels[i];</div><div class="line">    &#125;</div><div class="line">    merge(m_channels,img_hsv);</div><div class="line">    <span class="comment">// 讲 HSV 图像转换为 RGB 图像，方便显示</span></div><div class="line">    cvtColor(img_hsv, img_hsv, CV_HSV2BGR);</div><div class="line">    <span class="comment">//HSV 模糊处理与 RGB 模糊处理的差异图像</span></div><div class="line">    Mat diff = img_bgr - img_hsv;</div><div class="line">    cvtColor(diff,diff,CV_BGR2GRAY);</div><div class="line">    diff.convertTo(diff, CV_32F);</div><div class="line">    <span class="built_in">log</span>(diff, diff);</div><div class="line">    namedWindow(<span class="string">"src image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"RGB image blured"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"HSV image blured"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"The difference of bluring"</span>,WINDOW_AUTOSIZE);</div><div class="line">    imshow(<span class="string">"src image"</span>,img);</div><div class="line">    imshow(<span class="string">"RGB image blured"</span>, img_bgr);</div><div class="line">    imshow(<span class="string">"HSV image blured"</span>,img_hsv);</div><div class="line">    imshow(<span class="string">"The difference of bluring"</span>,diff);</div><div class="line">    waitKey(<span class="number">0</span>);</div><div class="line">    <span class="comment">//return</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下例是锐化操作，锐化滤波器为拉普拉斯滤波器，直接对 RGB 图像进行滤波：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 直接对 RGB 图像锐化. png" alt="彩色图像锐化"></p>
<p>##HSV 颜色空间的颜色分割（突出颜色区域）：</p>
<p>在<strong>冈萨雷斯的《数字图像处理》</strong>中其实还有提到 RGB 颜色空间的颜色分离，但实现起来比较复杂，在此不讨论，HSV 颜色空间通过色调 (hue) 和饱和度 (saturation) 就能很好地确定颜色信息，相当方便。</p>
<p>在 HSV 颜色空间的颜色分割的实现经历如下步骤：</p>
<ol>
<li><p>分离出 Hue 通道（首先，颜色参与提名“需要突出颜色”）</p>
</li>
<li><p>分离出 Saturation 通道，并且二值化为 0、1，用二值化后的饱和度图像作为掩膜，与色度图像做点积（淘汰那些饱和度不够的提名色）</p>
</li>
</ol>
<p>下面是例子，该例子中，原图像色泽较为浓郁的区域被突出（最右下角图片）：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip-HSV 颜色分割. png" alt="HSV 颜色分割"></p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip-HSV 颜色分割 2.png" alt="HSV 颜色分割 2"></p>
<p>(a)原图像 (b)Hue 通道 (c)饱和度通道</p>
<p>(d)二值化的饱和度通道 (e)分割后图像</p>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv/cv.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</div><div class="line"></div><div class="line"><span class="comment">// 图像处理基础素材路径</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BASEPATH <span class="meta-string">"/Users/feiyu06/Pictures/img_processing/"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE unsigned char</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 图像路径</span></div><div class="line">    <span class="built_in">string</span> img_path = <span class="string">"DIP3E_Original_Images_CH06/Fig0642(a)(jupiter_moon_original).tif"</span>;</div><div class="line">    Mat img = imread(BASEPATH+img_path, <span class="number">1</span>);</div><div class="line">    <span class="comment">// 将图像转换到 HSV 颜色空间</span></div><div class="line">    Mat img_hsv;</div><div class="line">    cvtColor(img, img_hsv, CV_BGR2HSV);</div><div class="line">    <span class="comment">// 分离用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt;  s_channels(img.channels());</div><div class="line">    <span class="comment">// 合并用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; m_channels(img.channels());</div><div class="line">    <span class="comment">// 分离 HSV 图像各个通道</span></div><div class="line">    split(img_hsv,s_channels);</div><div class="line">    <span class="comment">// 设置饱和度阈值</span></div><div class="line">    s_channels[<span class="number">1</span>].convertTo(m_channels[<span class="number">1</span>], CV_32F);</div><div class="line">    m_channels[<span class="number">0</span>] = s_channels[<span class="number">0</span>];</div><div class="line">    <span class="keyword">double</span> min,max;</div><div class="line">    minMaxLoc(m_channels[<span class="number">1</span>],&amp;min,&amp;max);</div><div class="line">    <span class="built_in">cout</span>&lt;&lt;max&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">double</span> thresh = max*<span class="number">0.3</span>;</div><div class="line">    <span class="comment">// 二值化饱和度图像</span></div><div class="line">    threshold(m_channels[<span class="number">1</span>], m_channels[<span class="number">1</span>], thresh,<span class="number">1.0</span>, THRESH_BINARY);</div><div class="line">    m_channels[<span class="number">1</span>].convertTo(m_channels[<span class="number">1</span>], CV_8U);</div><div class="line">    <span class="comment">// 二值化后的饱和度图像与色度图像点积获得最终颜色分割图像</span></div><div class="line">    Mat img_dst;</div><div class="line">    multiply(m_channels[<span class="number">0</span>], m_channels[<span class="number">1</span>], img_dst);</div><div class="line">    m_channels[<span class="number">1</span>].convertTo(m_channels[<span class="number">1</span>],CV_32F);</div><div class="line">    namedWindow(<span class="string">"Src image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"Hue image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"Saturation image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"Binary Saturation mask"</span>,WINDOW_AUTOSIZE);</div><div class="line">    namedWindow(<span class="string">"Dst image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    imshow(<span class="string">"Src image"</span>,img);</div><div class="line">    imshow(<span class="string">"Hue image"</span>, m_channels[<span class="number">0</span>]);</div><div class="line">    imshow(<span class="string">"Saturation image"</span>,s_channels[<span class="number">1</span>]);</div><div class="line">    imshow(<span class="string">"Binary Saturation mask"</span>,m_channels[<span class="number">1</span>]);</div><div class="line">    imshow(<span class="string">"Dst image"</span>, img_dst);</div><div class="line">    waitKey(<span class="number">0</span>);</div><div class="line">    <span class="comment">//return</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="全彩色图像的边缘检测："><a href="#全彩色图像的边缘检测：" class="headerlink" title="全彩色图像的边缘检测："></a>全彩色图像的边缘检测：</h2><p>因为梯度（反映图像灰度变化）在向量中的定义不同于标量中的定义，故而在灰度图像中的梯度算法并不能直接作用于全彩色图像。通常，在 RGB 颜色模型中，我们会对各分量进行边缘检测后再叠加。</p>
<p>如下例子所示，我们对彩色图像的各分量图像做边缘检测后进行叠加，在这里，所用到边缘检测算法是 Canny 边缘检测。注意到：</p>
<blockquote>
<p>Canny 算法中减少假边缘数量的方法是采用双阈值法。选择两个阈值（关于阈值的选取方法在扩展中进行讨论），根据高阈值得到一个边缘图像，这样一个图像含有很少的假边缘，但是由于阈值较高，产生的图像边缘可能不闭合，未解决这样一个问题采用了另外一个低阈值。</p>
<p>在高阈值图像中把边缘链接成轮廓，当到达轮廓的端点时，该算法会在断点的 8 邻域点中寻找满足低阈值的点，再根据此点收集新的边缘，直到整个图像边缘闭合。</p>
</blockquote>
<p>在此，我们通过滑动条来控制高、低阈值：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 全彩色图像边缘检测. png" alt="彩色图像边缘检测"></p>
<p>代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv/cv.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</div><div class="line"></div><div class="line"><span class="comment">// 图像处理基础素材路径</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BASEPATH <span class="meta-string">"/Users/feiyu06/Pictures/img_processing/"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE unsigned char</span></div><div class="line"></div><div class="line"><span class="comment">// 定义滑动条基本参数</span></div><div class="line"><span class="keyword">int</span> high_thresh = <span class="number">255</span>;</div><div class="line"><span class="keyword">int</span> low_thresh = <span class="number">0</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> max_val = <span class="number">255</span>;</div><div class="line"><span class="built_in">string</span> winname = <span class="string">"Edges Detecting...."</span>;</div><div class="line"><span class="comment">// 原图像</span></div><div class="line">Mat img;</div><div class="line"><span class="comment">// 边缘图像</span></div><div class="line">Mat edges_img;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">edgesDetecting</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">void</span>*)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 图像路径</span></div><div class="line">    <span class="built_in">string</span> img_path = <span class="string">"DIP3E_Original_Images_CH06/Fig0638(a)(lenna_RGB).tif"</span>;</div><div class="line">    img = imread(BASEPATH+img_path, <span class="number">1</span>);</div><div class="line">    namedWindow(winname,WINDOW_AUTOSIZE);</div><div class="line">    createTrackbar(<span class="string">"High Threshold"</span>, winname, &amp;high_thresh, max_val,edgesDetecting);</div><div class="line">    createTrackbar(<span class="string">"Low Threshold"</span>, winname, &amp;low_thresh,max_val, edgesDetecting);</div><div class="line">    edgesDetecting(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    namedWindow(<span class="string">"Src Image"</span>,WINDOW_AUTOSIZE);</div><div class="line">    imshow(<span class="string">"Src Image"</span>,img);</div><div class="line">    waitKey(<span class="number">0</span>);</div><div class="line">    <span class="comment">//return</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 定义根据滑动条参数设定来完成边缘检测</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">edgesDetecting</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">void</span>*)</span></span>&#123;</div><div class="line">    <span class="comment">// 分离用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; s_channels(img.channels());</div><div class="line">    <span class="comment">// 合并用通道</span></div><div class="line">    <span class="built_in">vector</span>&lt;Mat&gt; m_channels(img.channels());</div><div class="line">    split(img,s_channels);</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="comment">// 对各通道进行边缘检测</span></div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;img.channels();i++)</div><div class="line">        Canny(s_channels[i], m_channels[i], high_thresh, low_thresh);</div><div class="line">    merge(m_channels, edges_img);</div><div class="line">    imshow(winname, edges_img);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Sails_Tutorial/利用sails.js+mongodb开发博客系统(2)--框架完善/">利用 Sails.js+MongoDB 开发博客系统 (2)-- 框架完善</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="章节概述"><a href="#章节概述" class="headerlink" title="章节概述"></a>章节概述</h2><p>在本章中，你将能学到如下知识：</p>
<ul>
<li>如何将 sails 的模板引擎替换为 swig，并且设置和扩展 swig</li>
<li>集成 bower 来管理我们的前端库</li>
<li>集成 compass 来更优雅的撰写 css</li>
<li>通过 grunt 来监听 scss 文件变动，并自动编译</li>
<li>前端模块化开发思路即实现</li>
<li>集成 semantic-ui 来撰写 UI</li>
<li>利用 grunt 来对产品环境下的访问进行优化</li>
</ul>
<h2 id="更换模板引擎"><a href="#更换模板引擎" class="headerlink" title="更换模板引擎"></a>更换模板引擎</h2><p>Sails 默认的模板引擎为 ejs，仅就我个人而言，纯主观上来说，对这个框架不是很喜欢，尤其 ejs 不支持继承，令我大为恼火。所以我会考虑用 <a href="http://jinja.pocoo.org/" target="_blank" rel="external"><strong>jinja</strong></a> 风格的 swig 来做模板引擎。</p>
<h3 id="安装-swig"><a href="#安装-swig" class="headerlink" title="安装 swig"></a>安装 swig</h3><blockquote>
<p>标准的 swig 提供的 filter，tag 等可能不够用，比如字符串分割（split）等就未提供，为此，我们也需要安装其扩展</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install swig --save</div><div class="line">npm install swig-extras --save</div></pre></td></tr></table></figure>
<h3 id="替换默认引擎"><a href="#替换默认引擎" class="headerlink" title="替换默认引擎"></a>替换默认引擎</h3><p>在<strong>config/views.js</strong>中，修改 egine 为 swig, 并对 swig 做一些方便我们开发的配置，比如在这里，我们设定一些常用资源路径，避免了在页面中每次都要书写冗长的路径前缀。同时，为了在开发环境下修改 swig 而不用重启服务器，我们需要设置 swig 默认不缓存:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> extras = <span class="built_in">require</span>(<span class="string">'swig-extras'</span>);</div><div class="line"><span class="built_in">module</span>.exports.views = &#123;</div><div class="line">    <span class="attr">engine</span>: &#123;</div><div class="line">        <span class="comment">/* Template File Extension */</span></div><div class="line">        ext: <span class="string">'swig'</span>,</div><div class="line"></div><div class="line">        <span class="comment">/* Function to handle render request */</span></div><div class="line">        fn: <span class="function"><span class="keyword">function</span> (<span class="params">path, data, cb</span>) </span>&#123;</div><div class="line">            <span class="comment">/* Swig Renderer */</span></div><div class="line">            <span class="keyword">var</span> swig = <span class="built_in">require</span>(<span class="string">'swig'</span>);</div><div class="line">            <span class="comment">// 保证我们在开发环境下每次更改 swig 不用重启 sails</span></div><div class="line">            <span class="keyword">if</span> (data.settings.env === <span class="string">'development'</span>) &#123;</div><div class="line">                swig.setDefaults(&#123;<span class="attr">cache</span>: <span class="literal">false</span>&#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * 绑定一些常用路径</div><div class="line">             * Thanks to: https://github.com/mahdaen/sails-views-swig</div><div class="line">             * */</div><div class="line">            <span class="keyword">var</span> paths = &#123;</div><div class="line">                <span class="attr">script</span>: <span class="string">'/js'</span>,</div><div class="line">                <span class="attr">style</span>: <span class="string">'/styles/default'</span>,</div><div class="line">                <span class="attr">image</span>: <span class="string">'/images'</span>,</div><div class="line">                <span class="attr">font</span>: <span class="string">'/fonts'</span>,</div><div class="line">                <span class="attr">icon</span>: <span class="string">'/icons'</span>,</div><div class="line">                <span class="attr">bower</span>: <span class="string">'/bower_components'</span></div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!data.path) &#123;</div><div class="line">                data.path = paths;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> paths) &#123;</div><div class="line">                    <span class="keyword">if</span> (!key <span class="keyword">in</span> data.path) &#123;</div><div class="line">                        data.path[key] = paths[key];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 补充 extra</span></div><div class="line">            extras.useFilter(swig, <span class="string">'split'</span>);</div><div class="line">            <span class="comment">/* Render Templates */</span></div><div class="line">            <span class="keyword">return</span> swig.renderFile(path, data, cb);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">layout</span>: <span class="string">'layout'</span>,</div><div class="line"></div><div class="line">    <span class="attr">partials</span>: <span class="literal">false</span></div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="创建一些页面"><a href="#创建一些页面" class="headerlink" title="创建一些页面"></a>创建一些页面</h3><p>在<strong>views/</strong>下创建一些 swig 页面, 其中<strong>partial</strong>文件夹下为一些公用视图部分或者视图模板：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-views_dir.png" alt="views_dir"></p>
<p>并初始化一些内容<br><strong>layout.swig</strong>:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> title -%&#125;</span><span class="xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></div><div class="line">    <span class="comment">&#123;# 引入常用 css 文件 #&#125;</span><span class="xml"></span></div><div class="line">    <span class="template-tag">&#123;% <span class="name"><span class="keyword">include</span></span> "stylesheets.swig" -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="comment">&#123;# 引入导航栏 #&#125;</span><span class="xml"></span></div><div class="line">    <span class="template-tag">&#123;% <span class="name"><span class="keyword">include</span></span> "header.swig" -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="comment">&#123;# 主内容显示部分，提供给集成页面重写 #&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mainContainer"</span>&gt;</span></div><div class="line">        <span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> content -%&#125;</span><span class="xml"></span></div><div class="line">        <span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="comment">&#123;# 引入常用脚本 #&#125;</span><span class="xml"></span></div><div class="line"></div><div class="line">    <span class="template-tag">&#123;% <span class="name"><span class="keyword">include</span></span> "scripts.swig" %&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>index.swig</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;% extends 'partial/layout.swig' %&#125;</div><div class="line">&#123;% block title -%&#125;Woo 的博客 &#123;%- endblock %&#125;</div><div class="line">&#123;% block content -%&#125;</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;p&gt;</div><div class="line">            这是 Woo 的博客?</div><div class="line">        &lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&#123;%- endblock %&#125;</div></pre></td></tr></table></figure>
<h3 id="设置路由："><a href="#设置路由：" class="headerlink" title="设置路由："></a>设置路由：</h3><p>为我们新添加的 index.twig 添加路由</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="string">'/'</span> : &#123;</div><div class="line">   <span class="attr">view</span> :<span class="string">'index'</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>OK, 现在我们执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails lift</div></pre></td></tr></table></figure>
<p>并输入<a href="http://localhost:1337" target="_blank" rel="external">http://localhost:1337</a>, 就能看到如下页面：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-index_show.png" alt="index_show"></p>
<h2 id="利用-bower-来管理我们的前端库"><a href="#利用-bower-来管理我们的前端库" class="headerlink" title="利用 bower 来管理我们的前端库"></a>利用 bower 来管理我们的前端库</h2><h3 id="安装-bower"><a href="#安装-bower" class="headerlink" title="安装 bower"></a>安装 bower</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install bower -g</div></pre></td></tr></table></figure>
<h3 id="在项目中配置-bower"><a href="#在项目中配置-bower" class="headerlink" title="在项目中配置 bower"></a>在项目中配置 bower</h3><p>在项目根目录下创建. bowerrc 文件, 并在文件中设置 bower 库目录</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"directory"</span>:<span class="string">"assets/bower_components"</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之所以需要将 bower 下载下的组件放置在 assets 目录下，是方便我们在不用撰写任何 grunt 任务的情况下就能在页面中引用 bower 下载的库资源。</p>
<h3 id="使用-bower"><a href="#使用-bower" class="headerlink" title="使用 bower"></a>使用 bower</h3><p>我们尝试利用 bower 来下载 jquery</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bower install jquery --save</div></pre></td></tr></table></figure>
<p>可以看到，jquery 的响应资源已经成功地安装在了在 assets/bower_components 目录下</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-bower_jquery.png" alt="bower_jquery"></p>
<h2 id="利用-compass-来撰写-CSS"><a href="#利用-compass-来撰写-CSS" class="headerlink" title="利用 compass 来撰写 CSS"></a>利用 compass 来撰写 CSS</h2><h3 id="安装-compass"><a href="#安装-compass" class="headerlink" title="安装 compass"></a>安装 compass</h3><p>基于和 bower 的目录配置同样的理由，我们选择将 compass 放置在 assets 目录下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">gem install compass</div><div class="line">cd assets</div><div class="line">compass init</div></pre></td></tr></table></figure>
<h3 id="配置-compass"><a href="#配置-compass" class="headerlink" title="配置 compass"></a>配置 compass</h3><p>修改 assets/config.rb 的文件内容如下：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'compass/import-once/activate'</span></div><div class="line"><span class="comment"># Require any additional compass plugins here.</span></div><div class="line"></div><div class="line"><span class="comment"># Set this to the root of your project when deployed:</span></div><div class="line">http_path = <span class="string">"/"</span></div><div class="line">css_dir = <span class="string">"styles"</span></div><div class="line">sass_dir = <span class="string">"sass"</span></div><div class="line">images_dir = <span class="string">"images"</span></div><div class="line">javascripts_dir = <span class="string">"js"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># You can select your preferred output style here (can be overridden via the command line):</span></div><div class="line"><span class="comment"># output_style = :expanded or :nested or :compact or :compressed</span></div><div class="line">output_style = <span class="symbol">:expanded</span></div><div class="line"></div><div class="line"><span class="comment"># To enable relative paths to assets via compass helper functions. Uncomment:</span></div><div class="line"><span class="comment"># relative_assets = true</span></div><div class="line"></div><div class="line"><span class="comment"># To disable debugging comments that display the original location of your selectors. Uncomment:</span></div><div class="line"><span class="comment"># line_comments = false</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># If you prefer the indented syntax, you might want to regenerate this</span></div><div class="line"><span class="comment"># project again passing --syntax sass, or you can uncomment this:</span></div><div class="line"><span class="comment"># preferred_syntax = :sass</span></div><div class="line"><span class="comment"># and then run:</span></div><div class="line"><span class="comment"># sass-convert -R --from scss --to sass sass scss &amp;&amp; rm -rf sass &amp;&amp; mv scss sass</span></div></pre></td></tr></table></figure>
<h3 id="设置-compass-任务"><a href="#设置-compass-任务" class="headerlink" title="设置 compass 任务"></a>设置 compass 任务</h3><p>OK，接下来我们需要创建响应的 grunt task 来设置 compass 的编译任务, 使得每次<strong>assets/sass</strong>文件夹下的 scss 文件变动时，不用手动输入命令就能完成 scss 到 css 的编译工作:</p>
<h3 id="安装-grunt-contrib-compass"><a href="#安装-grunt-contrib-compass" class="headerlink" title="安装 grunt-contrib-compass"></a>安装 grunt-contrib-compass</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install grunt-contrib-compass</div></pre></td></tr></table></figure>
<h3 id="创建-compass-任务"><a href="#创建-compass-任务" class="headerlink" title="创建 compass 任务"></a>创建 compass 任务</h3><p>在<strong>tasks/config</strong>下新建<strong>compass.js</strong>并添加如下内容：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 指定 Compass 配置文件，完成 sass 编译</div><div class="line"> */</div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>)</span>&#123;</div><div class="line">    grunt.config.set(<span class="string">'compass'</span>,&#123;</div><div class="line">        <span class="attr">dist</span>: &#123;</div><div class="line">            <span class="attr">options</span>: &#123;</div><div class="line">                <span class="attr">config</span>: <span class="string">'assets/config.rb'</span>,</div><div class="line">                <span class="comment">// 重要，如果不声明 assets，compass 无法找到待编译的 scss 文件</span></div><div class="line">                basePath : <span class="string">'assets'</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    grunt.loadNpmTasks(<span class="string">'grunt-contrib-compass'</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="监视-scss-文件变动"><a href="#监视-scss-文件变动" class="headerlink" title="监视 scss 文件变动"></a>监视 scss 文件变动</h3><p>修改<strong>tasks/config</strong>下的<strong>watch.js</strong>任务，使得当 scss 文件变动时，compass 能够自动编译 scss 至 css。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</div><div class="line"></div><div class="line">  grunt.config.set(<span class="string">'watch'</span>, &#123;</div><div class="line">    <span class="attr">options</span> :&#123;</div><div class="line">      <span class="attr">livereload</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">api</span>: &#123;</div><div class="line"></div><div class="line">      <span class="comment">// API files to watch:</span></div><div class="line">      files: [<span class="string">'api/**/*'</span>, <span class="string">'!**/node_modules/**'</span>]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">assets</span>: &#123;</div><div class="line"></div><div class="line">      <span class="comment">// Assets to watch:</span></div><div class="line">      files: [<span class="string">'assets/**/*'</span>, <span class="string">'tasks/pipeline.js'</span>, <span class="string">'!**/node_modules/**'</span>],</div><div class="line"></div><div class="line">      <span class="comment">// When assets are changed:</span></div><div class="line">      tasks: [<span class="string">'syncAssets'</span> , <span class="string">'linkAssets'</span>]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">compass</span>: &#123;</div><div class="line">      <span class="attr">files</span>: [<span class="string">'assets/sass/&#123;,*/&#125;*.scss'</span>],</div><div class="line">      <span class="attr">tasks</span>: [<span class="string">'compass'</span>,<span class="string">'sync:dev'</span>]</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  grunt.loadNpmTasks(<span class="string">'grunt-contrib-watch'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="更新任务流"><a href="#更新任务流" class="headerlink" title="更新任务流"></a>更新任务流</h3><p>修改__register/compileAssets.js 任务流，将 compass 添加到编译流程当中。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">grunt</span>) </span>&#123;</div><div class="line">  grunt.registerTask(<span class="string">'compileAssets'</span>, [</div><div class="line">    <span class="string">'clean:dev'</span>,</div><div class="line">    <span class="string">'jst:dev'</span>,</div><div class="line">    <span class="string">'compass'</span>,</div><div class="line">    <span class="string">'copy:dev'</span>,</div><div class="line">    <span class="string">'coffee:dev'</span></div><div class="line">  ]);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="前端模块化开发"><a href="#前端模块化开发" class="headerlink" title="前端模块化开发"></a>前端模块化开发</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>现在我们的前端模块化开发有如下思路：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails - 前端模块化开发. png" alt="前端模块化开发思路"></p>
<p>即每个页面的前端逻辑受一个<strong>模块(module)</strong>控制，且该模块暴露一个<strong>run()</strong>方法，当该页面加载成功时，<strong>模块</strong>的<strong>run()</strong>方法会被执行。该模块也可引用其他一些模块，只是这些模块对页面透明，这样就做到页面和其对应逻辑的一一对应，方便前端开发者的分工协作。</p>
<h3 id="利用-requirejs-进行模块化开发"><a href="#利用-requirejs-进行模块化开发" class="headerlink" title="利用 requirejs 进行模块化开发"></a>利用 requirejs 进行模块化开发</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bower install requirejs --save</div></pre></td></tr></table></figure>
<h4 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h4><p>在<strong>views/partial/scripts.swig</strong>下声明 requirejs, 注意相应路径写绝对路径：</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">data-main</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.script &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/common/main"</span> <span class="attr">src</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.bower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/requirejs/require.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>其中，path 是我们定义好的 swig 扩展。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>在<strong>assets/js/common</strong>下新建<strong>main.js</strong>, 并添加如下内容，注意，baseURL 写绝对路径:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 第三方模块声明</span></div><div class="line"><span class="built_in">require</span>.config(&#123;</div><div class="line">    <span class="attr">baseUrl</span>: <span class="string">'/bower_components/'</span>,</div><div class="line">    <span class="attr">paths</span>: &#123;</div><div class="line">        </div><div class="line">    &#125;&#125;);</div></pre></td></tr></table></figure>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>然而每次需要我们手动在<strong>main.js</strong>中维护 bower 下载的库并不是一种优雅的做法，我们现在需要借助 <a href="https://github.com/yeoman/bower-requirejs" target="_blank" rel="external">bower-requirejs</a> 这个插件来帮助我们在 main.js 中自动维护 bower 下载下的相关库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install bower-requirejs --save-dev</div></pre></td></tr></table></figure>
<p>通过 bower 的 hook 机制，我们将 bower-requejs 任务绑定到每次<strong>bower install</strong>之后，亦即每次通过 bower 安装了插件之后，我们的库会被自动添加到 main.js 中，在<strong>.bowerrc</strong>中添加如下内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"directory"</span>:<span class="string">"assets/bower_components"</span>,</div><div class="line">  <span class="attr">"scripts"</span>:&#123;</div><div class="line">    <span class="attr">"postinstall"</span>: <span class="string">".node_modules/.bin/bower-requirejs/bin/bower-requirejs -c assets/js/common/main.js -b assets/bower_components/"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>现在我们安装</p>
<ul>
<li><a href="http://www.semantic-ui.cn/" target="_blank" rel="external">semantic-ui</a>– 将来我们用来完善页面显示的前端样式框架，</li>
<li><a href="http://backbonejs.org/" target="_blank" rel="external">Backbone.js</a>– 前端 MVC 框架。</li>
<li>观察 bower-requirejs 是否配置成功。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bower install semantic-ui --save</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bower install backbone --save</div></pre></td></tr></table></figure>
<blockquote>
<p>backbone 的依赖项<strong>undersocre</strong>，bower 会为我们解决</p>
</blockquote>
<p>可以看到，main.js 中已经自动生成了相关配置。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">require</span>.config(&#123;</div><div class="line">    <span class="attr">baseUrl</span>: <span class="string">'/bower_components/'</span>,</div><div class="line">    <span class="attr">paths</span>: &#123;</div><div class="line">        <span class="attr">jquery</span>: <span class="string">'jquery/dist/jquery'</span>,</div><div class="line">        <span class="attr">requirejs</span>: <span class="string">'requirejs/require'</span>,</div><div class="line">        <span class="string">'semantic-ui'</span>: <span class="string">'semantic-ui/dist/semantic'</span>,</div><div class="line">        <span class="attr">underscore</span>: <span class="string">'underscore/underscore'</span>,</div><div class="line">        <span class="attr">backbone</span>: <span class="string">'backbone/backbone'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">packages</span>: [</div><div class="line"></div><div class="line">    ]</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>接下来，我们新建<strong>assets/js/default/index.js</strong>, 随便写入点内容：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 每个模块暴露一个 run()方法执行</span></div><div class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">run</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            $(<span class="string">'body'</span>).css(<span class="string">'background-color'</span>,<span class="string">'black'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="配置页面和模块的映射关系："><a href="#配置页面和模块的映射关系：" class="headerlink" title="配置页面和模块的映射关系："></a>配置页面和模块的映射关系：</h4><p><strong>_views/scripts.swig</strong>:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></div><div class="line">    <span class="keyword">var</span> app = &#123;&#125;;</div><div class="line">    <span class="comment">//    如果指明了预调用模块，则为 app 设置动作</span></div><div class="line">    <span class="template-tag">&#123;% <span class="name"><span class="keyword">if</span></span> module -%&#125;</span><span class="xml"><span class="undefined"></span></span></div><div class="line">    app.action = '<span class="template-variable">&#123;&#123; module &#125;&#125;</span><span class="xml"><span class="undefined">';</span></span></div><div class="line">    <span class="template-tag">&#123;%- <span class="name"><span class="keyword">endif</span></span>  %&#125;</span><span class="xml"><span class="undefined"></span></span></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">data-main</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.script &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/common/main"</span> <span class="attr">src</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123; path.bower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/requirejs/require.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>我们新建<strong>assets/js/common/app.js</strong>来调用我们的模块方法, 当 app 模块初始化时，会调用 module 的 run()方法:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'jquery'</span>,<span class="string">'underscore'</span>,<span class="string">'backbone'</span>,<span class="string">'/js/'</span>+app.action+<span class="string">'.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">$,_,Backbone,module</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">init</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="built_in">module</span>.run();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>修改<strong>assets/js/common/main.js</strong>，让其加载 app:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">require</span>.config(&#123;</div><div class="line">    <span class="attr">baseUrl</span>: <span class="string">'/bower_components/'</span>,</div><div class="line">    <span class="attr">paths</span>: &#123;</div><div class="line">        <span class="attr">jquery</span>: <span class="string">'jquery/dist/jquery'</span>,</div><div class="line">        <span class="attr">requirejs</span>: <span class="string">'requirejs/require'</span>,</div><div class="line">        <span class="string">'semantic-ui'</span>: <span class="string">'semantic-ui/dist/semantic'</span>,</div><div class="line">        <span class="attr">underscore</span>: <span class="string">'underscore/underscore'</span>,</div><div class="line">        <span class="attr">backbone</span>: <span class="string">'backbone/backbone'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">packages</span>: [</div><div class="line"></div><div class="line">    ]</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 加载 app，并运行</span></div><div class="line"><span class="built_in">require</span>([<span class="string">'/js/common/app.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">app</span>)</span>&#123;</div><div class="line">    app.init();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在<strong>views/index.swig</strong>中通过 swig 的<strong>set</strong>标签来制定该页面对应的前端控制逻辑：</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;% extends 'partial/layout.swig' %&#125;</div><div class="line">&#123;# 声明本页面调用的模块 #&#125;</div><div class="line">&#123;% set module = 'default/index' -%&#125;</div><div class="line"></div><div class="line">&#123;% block title -%&#125;Woo 的博客 &#123;%- endblock %&#125;</div><div class="line">&#123;% block content -%&#125;</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;p&gt;</div><div class="line">            这是 Woo 的博客?</div><div class="line">        &lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&#123;%- endblock %&#125;</div></pre></td></tr></table></figure>
<p>OK, 接下来我们执行</p>
<figure class="highlight plain"><figcaption><span>lift```</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line">并访问 [http://localhost:1337](http://localhost:1337), 如果页面背景为黑色就代表控制逻辑成功被调用</div><div class="line"></div><div class="line">![sails lift](http://7pulhb.com1.z0.glb.clouddn.com/sails-black.png)</div><div class="line"></div><div class="line">## 利用 semantic-ui 来做界面展示</div><div class="line"></div><div class="line"> 关于 bootstrap 和 semantic-ui 选择纯粹是出于个人爱好了，我更喜欢 semantic-ui 的语义化 css 控制以及其自带一些控件风格，最暖心的是，semantic-ui 的模态框不会抖动有木有！！</div><div class="line"></div><div class="line">之前我们已经在__assets/js/common/main.js__中声明了对 semantic-ui 相应 js 控制逻辑的依赖，接下来再__views/partial/stylesheets.swig__中添加 semantic-ui 的 css 调用：</div><div class="line"></div><div class="line">```twig</div><div class="line">&#123;# semantic #&#125;</div><div class="line">&lt;link href=&quot;&#123;&#123; path.bower &#125;&#125;/semantic-ui/dist/semantic.min.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;/&gt;</div></pre></td></tr></table></figure>
<h2 id="产品（Production）环境下的访问优化"><a href="#产品（Production）环境下的访问优化" class="headerlink" title="产品（Production）环境下的访问优化:"></a>产品（Production）环境下的访问优化:</h2><p>sails 通过：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails lift --prod</div></pre></td></tr></table></figure>
<p>来将应用部署到产品环境，在其基础上，我们希望产品环境的访问速度能够得到更大的优化，因而就要考虑对我们自定义的 js，css 模块进行压缩，这里就会修改<strong>uglify.js</strong>及<strong>cssmin.js</strong>两个 grunt 压缩任务，并相应地修改<strong>prod.js</strong>任务流，如下所示:</p>
<p><strong>tasks/config/uglify.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</div><div class="line"></div><div class="line">  grunt.config.set(<span class="string">'uglify'</span>, &#123;</div><div class="line"></div><div class="line">    <span class="attr">dist</span>: &#123;</div><div class="line"></div><div class="line">      <span class="attr">src</span>: [<span class="string">'.tmp/public/concat/production.js'</span>],</div><div class="line">      <span class="attr">dest</span>: <span class="string">'.tmp/public/min/production.min.js'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 压缩各个自定义模块 js</span></div><div class="line">    modules: &#123;</div><div class="line">      <span class="attr">files</span>:[&#123;</div><div class="line">        <span class="attr">expand</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">cwd</span>: <span class="string">'.tmp/public/js'</span>,</div><div class="line">        <span class="attr">src</span>: <span class="string">'**/*.js'</span>,</div><div class="line">        <span class="attr">dest</span>: <span class="string">'.tmp/public/js'</span></div><div class="line">      &#125;]</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  grunt.loadNpmTasks(<span class="string">'grunt-contrib-uglify'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>tasks/config/cssmin.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</div><div class="line"></div><div class="line">  grunt.config.set(<span class="string">'cssmin'</span>, &#123;</div><div class="line">    <span class="attr">dist</span>: &#123;</div><div class="line">      <span class="attr">src</span>: [<span class="string">'.tmp/public/concat/production.css'</span>],</div><div class="line">      <span class="attr">dest</span>: <span class="string">'.tmp/public/min/production.min.css'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">modules</span>: &#123;</div><div class="line">      <span class="attr">files</span>:[&#123;</div><div class="line">        <span class="attr">expand</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">cwd</span>: <span class="string">'.tmp/public/styles'</span>,</div><div class="line">        <span class="attr">src</span>: <span class="string">'**/*.css'</span>,</div><div class="line">        <span class="attr">dest</span>: <span class="string">'.tmp/public/styles'</span></div><div class="line">      &#125;]</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  grunt.loadNpmTasks(<span class="string">'grunt-contrib-cssmin'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>tasks/register/prod.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">grunt</span>) </span>&#123;</div><div class="line">  grunt.registerTask(<span class="string">'prod'</span>, [</div><div class="line">    <span class="string">'compileAssets'</span>,</div><div class="line">    <span class="string">'concat'</span>,</div><div class="line">    <span class="string">'uglify:dist'</span>,</div><div class="line">    <span class="string">'uglify:modules'</span>, <span class="comment">// 压缩自定义模块</span></div><div class="line">    <span class="string">'cssmin:dist'</span>,</div><div class="line">    <span class="string">'cssmin:modules'</span>, <span class="comment">// 压缩自定义 css</span></div><div class="line">    <span class="string">'sails-linker:prodJs'</span>,</div><div class="line">    <span class="string">'sails-linker:prodStyles'</span>,</div><div class="line">    <span class="string">'sails-linker:devTpl'</span>,</div><div class="line">    <span class="string">'sails-linker:prodJsJade'</span>,</div><div class="line">    <span class="string">'sails-linker:prodStylesJade'</span>,</div><div class="line">    <span class="string">'sails-linker:devTplJade'</span></div><div class="line">  ]);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>OK, 现在执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails lift --prod</div></pre></td></tr></table></figure>
<p>我们看到在<strong>.tmp/public</strong>目录下，我们之前撰写的 css 及 js 文件都被压缩:</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-css_compressed.png" alt="css_compressed"></p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-js_compressed.png" alt="js_compressed"></p>
<hr>
<h2 id="章节预告"><a href="#章节预告" class="headerlink" title="章节预告"></a>章节预告</h2><p>下一章中，我们将正式进入博客系统的开发，我们先会实现我们的账户系统。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Web/RMM Level -- 对于REST的层级划分模型/">RMM Level -- 对于 REST 的层级划分模型</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>##Richardson Maturity Model</p>
<p>原文链接：<a href="http://martinfowler.com/articles/richardsonMaturityModel.html" target="_blank" rel="external">http://martinfowler.com/articles/richardsonMaturityModel.html</a></p>
<p>该模型将 REST 划作了由低到高四个等级，等级越高，RESTful 就越成熟，但是，熟透了东西不一定好，甚至可能烂了，所以，项目中对于 RESTful 层级的选择要灵活把控。先看模型图：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/web-REST 层次. png" alt="RMM Model"></p>
<hr>
<p>###Level 0:The swarmp of POX(Plain old XML)</p>
<p>该等级的 REST 有如下特点:</p>
<ol>
<li><p>HTTP 仅作为一个通信隧道（即 HTTP 只关注通信消息，而不关注客户端及服务器间的行为）</p>
</li>
<li><p>采用远程调用协议（Remote Procedure Call Protocol）：即客户端想要执行某一任务，或者说向服务器请求某一服务，只需发送相关消息（执行某一句柄），而不用关心底层实现。</p>
</li>
<li><p>提供一个调用接口给客户端。</p>
</li>
</ol>
<p>考虑一个例子：某病人（Client）想要预约某位医生为其诊断，那么其必然经历：</p>
<ol>
<li><p>病人问询医院（Server）该医生那天是否有空。</p>
</li>
<li><p>医院告知病人该医生当天的空闲时间。</p>
</li>
<li><p>病人执行预约</p>
</li>
</ol>
<p>在 Level 0 中，该过程如下图所示：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/web-level0.png" alt="Level 0"></p>
<p>注意到绿色的端点（appointmentService），这是医院（Server）为了病人（Client）能够远程咨询（远程调用）而提供的一个调用接口，以下是该过程的伪代码描述, 其中请求及相应都用 XML 描述。</p>
<ol>
<li>病人想知道 2010 年 1 月 4 号时，jones 医生啥时候有空：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">POST /appointmentService HTTP/1.1</div><div class="line">[various other headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotRequest</span> <span class="attr">date</span> = <span class="string">"2010-01-04"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span>/&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>医院告诉病人 jones 医生当日的闲暇时间：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotList</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">doctor</span> <span class="attr">id</span> = <span class="string">"mjones"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">start</span> = <span class="string">"1600"</span> <span class="attr">end</span> = <span class="string">"1650"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">doctor</span> <span class="attr">id</span> = <span class="string">"mjones"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">openSlotList</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>病人选择当中一段时间预约 jones 医生</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">POST /appointmentService HTTP/1.1</div><div class="line">[various other headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointmentRequest</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointmentRequest</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>查看预约结果</li>
</ol>
<p>如果预约成功：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointment</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointment</span>&gt;</span></div></pre></td></tr></table></figure>
<p>否则：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointmentRequestFailure</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">reason</span>&gt;</span>Slot not available<span class="tag">&lt;/<span class="name">reason</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointmentRequestFailure</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注意到，这里服务器并没有通过状态码来反映预约成功与否，而通过回调了冗长的错误信息。</p>
<hr>
<p>###Level 1：Resources</p>
<p>该层的特点有：</p>
<ol>
<li><p>通过 URI 来定位资源，实现资源独立性</p>
</li>
<li><p>采用 “面向对象” 的通信方式</p>
</li>
</ol>
<p>相比于 Level 0，这层更加成熟的地方是客户端需要标明<strong>“我需要什么？”</strong>，考虑上面的例子，其新的模型如下：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/web-level1.png" alt="Level 1"></p>
<p>可以看到，每个资源都有各自调用接口（如医生资源，空闲表资源），该模型的病人预约过程如下：</p>
<ol>
<li>客户决定预约日期</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">POST /doctors/mjones HTTP/1.1</div><div class="line">[various other headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotRequest</span> <span class="attr">date</span> = <span class="string">"2010-01-04"</span>/&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>医院据此返回当日空闲表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotList</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"1234"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"5678"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1600"</span> <span class="attr">end</span> = <span class="string">"1650"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">openSlotList</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>病人请求获得 id 为 1234 的空闲服务（slot）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">POST /slots/1234 HTTP/1.1</div><div class="line">[various other headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointmentRequest</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointmentRequest</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>医院返回该 slot 资源给病人</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointment</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"1234"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointment</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<p>###Level 2:HTTP Verbs</p>
<p>顾名思义，Level 2 追加了 HTTP 动作来指明我们对于资源要做何种操作，如此，客户端的请求就能完整的表述为<strong>“我需要对 XX（资源）做 XX（行为）”</strong>, 该层级是当前使用最为广泛地 REST 层级，通常定义如下四个 HTTP 动作：</p>
<ol>
<li><p><strong>GET</strong>—-》一般性获得资源，并不改变资源，所以这种操作相对安全</p>
</li>
<li><p><strong>POST</strong>—》通常为创建资源操作</p>
</li>
<li><p><strong>PUT</strong>—-》通常为更新资源操作</p>
</li>
<li><p><strong>DELETE</strong>-》删除资源操作</p>
</li>
</ol>
<p>同时，服务端不再通过错误消息（当然，某些系统也会封装错误消息，给予客户友善提示）来告诉客户端执行状态，而是通过返回 HTTP 状态字来告知客户端请求执行结果。</p>
<p>上例在该层级下的模型如下：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/web-level2.png" alt="Level 2"></p>
<p>任务过程如下：</p>
<ol>
<li>客户想要获得 10 年 1 月 4 好的医生空闲表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET /doctors/mjones/slots?date=20100104&amp;status=open HTTP/1.1</div><div class="line">Host: royalhope.nhs.uk</div></pre></td></tr></table></figure>
<ol>
<li>医院返回空闲表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotList</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"1234"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"5678"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1600"</span> <span class="attr">end</span> = <span class="string">"1650"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">openSlotList</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>客户执行预约：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">POST /slots/1234 HTTP/1.1</div><div class="line">[various other headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointmentRequest</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointmentRequest</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>医院告知预约结果：</li>
</ol>
<p>若成功：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 201 Created</div><div class="line">Location: slots/1234/appointment</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointment</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"1234"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointment</span>&gt;</span></div></pre></td></tr></table></figure>
<p>若失败：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 409 Conflict</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotList</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"5678"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1600"</span> <span class="attr">end</span> = <span class="string">"1650"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">openSlotList</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注意其返回状态字的变化，可以和 Level 0 作对比。</p>
<hr>
<p>###Level 3:Hypermedia Controls</p>
<p>首先要知道 HATEOAS (Hypertext As The Engine Of Application State)：这种策略解决了我们如何从得到的资源中顺带知晓下一步应当如何进行？</p>
<p>因为要服务端的响应要封装“下一步如何做”，故而上例的模型变为：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/web-level3.png" alt="Level 3"></p>
<p>任务过程如下:</p>
<ol>
<li>病人请求 2010 年 1 月 4 号的空闲表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET /doctors/mjones/slots?date=20100104&amp;status=open HTTP/1.1</div><div class="line">Host: royalhope.nhs.uk</div></pre></td></tr></table></figure>
<ol>
<li>医院返回空闲表，<strong>并且附加了下一步操作</strong>，其中，rel 用于描述客户端要完成什么行为，uri 用于定位该行为需要访问的资源。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">openSlotList</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"1234"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/slot/book"</span> </span></div><div class="line">           <span class="attr">uri</span> = <span class="string">"/slots/1234"</span>/&gt;</div><div class="line">  <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"5678"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1600"</span> <span class="attr">end</span> = <span class="string">"1650"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/slot/book"</span> </span></div><div class="line">           <span class="attr">uri</span> = <span class="string">"/slots/5678"</span>/&gt;</div><div class="line">  <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">openSlotList</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>病人执行预约：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">POST /slots/1234 HTTP/1.1</div><div class="line">[various other headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointmentRequest</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appointmentRequest</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>医院回调预约结果，<strong>并告知了客户所有预约完以后可以进行的动作（包括取消，联系，帮助等等）</strong>：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HTTP/1.1 201 Created</div><div class="line">Location: http://royalhope.nhs.uk/slots/1234/appointment</div><div class="line">[various headers]</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appointment</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">slot</span> <span class="attr">id</span> = <span class="string">"1234"</span> <span class="attr">doctor</span> = <span class="string">"mjones"</span> <span class="attr">start</span> = <span class="string">"1400"</span> <span class="attr">end</span> = <span class="string">"1450"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">patient</span> <span class="attr">id</span> = <span class="string">"jsmith"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/appointment/cancel"</span></span></div><div class="line">        <span class="attr">uri</span> = <span class="string">"/slots/1234/appointment"</span>/&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/appointment/addTest"</span></span></div><div class="line">        <span class="attr">uri</span> = <span class="string">"/slots/1234/appointment/tests"</span>/&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"self"</span></span></div><div class="line">        <span class="attr">uri</span> = <span class="string">"/slots/1234/appointment"</span>/&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/appointment/changeTime"</span></span></div><div class="line">        <span class="attr">uri</span> = <span class="string">"/doctors/mjones/slots?date=20100104@status=open"</span>/&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/appointment/updateContactInfo"</span></span></div><div class="line">        <span class="attr">uri</span> = <span class="string">"/patients/jsmith/contactInfo"</span>/&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span> = <span class="string">"/linkrels/help"</span></span></div><div class="line">        <span class="attr">uri</span> = <span class="string">"/help/appointment"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">appointment</span>&gt;</span></div></pre></td></tr></table></figure>
<p>显然，Level 3 更加考虑周全，但是这就类似与我们拨打 10010 等查询电话，有时候用户对接下来的动作心里有杆秤，并不需要服务端告知所有能够进行的“下一步”，因而，这种层级在某些时候倒回变成一种累赘。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Sails_Tutorial/利用Sails.js+MongoDB开发博客系统(4)--发布文章/">利用 Sails.js+MongoDB 开发博客系统 (4)-- 文章模块</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="章节概述"><a href="#章节概述" class="headerlink" title="章节概述"></a>章节概述</h2><p>在本章中，你将能学习到如下知识：</p>
<ul>
<li>认识 mongodb 的 mapReduce 函数，并利用其实现标签统计功能</li>
<li>认识 ES6 中的 Promise，了解其实现库 blue bird，为我们解决 node 中难看的嵌套回调</li>
<li>如何利用 markdown 来创建文章并完成代码高亮显示</li>
</ul>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>我们将设计如下两个文档：</p>
<ul>
<li>文章(Article)</li>
<li>分类（Category）</li>
</ul>
<p>而<strong>评论</strong>将利用 <a href="http://duoshuo.com/" target="_blank" rel="external">多说</a> 实现。</p>
<h3 id="文章（Article）设计"><a href="#文章（Article）设计" class="headerlink" title="文章（Article）设计"></a>文章（Article）设计</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>类型</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>title</td>
<td>文章标题</td>
<td>string</td>
<td>必选，长度 1-20 字符</td>
</tr>
<tr>
<td>content</td>
<td>文章内容</td>
<td>string</td>
<td>必选，不少于 1 个字符</td>
</tr>
<tr>
<td>author</td>
<td>作者</td>
<td>User</td>
<td>必选</td>
</tr>
<tr>
<td>tags</td>
<td>标签</td>
<td>array</td>
<td></td>
</tr>
<tr>
<td>category</td>
<td>分类</td>
<td>Category</td>
<td>默认：未分类</td>
</tr>
</tbody>
</table>
<h3 id="分类-Category-设计"><a href="#分类-Category-设计" class="headerlink" title="分类 (Category) 设计"></a>分类 (Category) 设计</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>类型</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>名称</td>
<td>string</td>
<td>必选, 长度 1-20 字符</td>
</tr>
</tbody>
</table>
<h3 id="额外需求"><a href="#额外需求" class="headerlink" title="额外需求"></a>额外需求</h3><ol>
<li>用户具有默认分类 —<strong>未分类</strong>。</li>
<li>每创建一篇文章，需要完成标签统计。</li>
</ol>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="创建-api"><a href="#创建-api" class="headerlink" title="创建 api"></a>创建 api</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails generate api article</div><div class="line">sails generate api category</div></pre></td></tr></table></figure>
<h3 id="创建“未分类”"><a href="#创建“未分类”" class="headerlink" title="创建“未分类”"></a>创建“未分类”</h3><p>对于上面的<strong>需求 1</strong>，很容易实现，我们只需要在 User 模型中的<strong>afterCreate</strong>这个生命期中存储一个默认分类即可：</p>
<p><strong>api/models/Category.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Category.js</div><div class="line"> *</div><div class="line"> * @description :: 分类</div><div class="line"> * @docs        :: http://sailsjs.org/#!documentation/models</div><div class="line"> */</div><div class="line">DEFAULT_NAME = <span class="string">"未分类"</span>;</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line"></div><div class="line">    <span class="attr">attributes</span>: &#123;</div><div class="line">        <span class="attr">name</span>: &#123;</div><div class="line">            <span class="attr">type</span>: <span class="string">"string"</span>,</div><div class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</div><div class="line">            <span class="attr">unique</span>:<span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 获得默认分类名</span></div><div class="line">    getDefault: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> DEFAULT_NAME;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>api/models/User.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 创建（注册）用户前，对用户密码加密</span></div><div class="line">   beforeCreate: <span class="function"><span class="keyword">function</span> (<span class="params">values, cb</span>) </span>&#123;</div><div class="line">       bcrypt.genSalt(<span class="number">10</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, salt</span>) </span>&#123;</div><div class="line">           bcrypt.hash(values.password, salt, <span class="function"><span class="keyword">function</span> (<span class="params">err, hash</span>) </span>&#123;</div><div class="line">               <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);</div><div class="line">               values.password = hash;</div><div class="line">               <span class="comment">// 执行用户定义回调</span></div><div class="line">               cb();</div><div class="line">           &#125;);</div><div class="line">       &#125;);</div><div class="line">   &#125;,</div><div class="line"></div><div class="line">   <span class="comment">// 创建用户后，自动为之生成默认分类 -"未分类"，并更新站点信息</span></div><div class="line">   afterCreate: <span class="function"><span class="keyword">function</span> (<span class="params">createdUser, cb</span>) </span>&#123;</div><div class="line">       <span class="keyword">var</span> thisModal = <span class="keyword">this</span>;</div><div class="line">       Category.create(&#123;<span class="attr">name</span>:Category.getDefault(),<span class="attr">creator</span>:createdUser&#125;)</div><div class="line">           .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,category</span>)</span>&#123;</div><div class="line">               <span class="keyword">if</span>(category)&#123;</div><div class="line">                   thisModal.updateSite(createdUser);</div><div class="line">                   cb();</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">   &#125;,</div></pre></td></tr></table></figure>
<h2 id="标签统计功能实现"><a href="#标签统计功能实现" class="headerlink" title="标签统计功能实现"></a>标签统计功能实现</h2><h3 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h3><p>如何统计所有文章中标签的出现频度，很容易想到的办法是遍历所有文章来统计各个标签的出现的次数，但这样做是十分低效的，为了完成这个需求，我们将利用 MongoDB 中的<strong>mapReduce()</strong>函数，相应知识可以参考官方文档：<a href="http://docs.mongodb.org/manual/core/map-reduce/" target="_blank" rel="external">Map Reduce</a></p>
<p>这里以一个例子简要的介绍一下 mongodb 的 mapreduce。考虑一个学生（Student）集合(Collection)，当中有如下三个学生文档：张三，李四，王五</p>
<p><strong>张三</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  name: "张三",</div><div class="line">  class: 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>李四</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  name: "李四",</div><div class="line">  class: 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>王五</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  name: "王五",</div><div class="line">  class: 2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们利用 mapreduce 来统计各个班级的学生人数，首先我们要进行一个<strong>map（映射）</strong>过程，其实该过程就是<strong>根据一定条件将划分数据</strong>。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> map = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  emit(<span class="keyword">this</span>.class,&#123;<span class="attr">count</span>:<span class="number">1</span>&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过<strong>emit(参数 1, 参数 2)</strong>方法，我们就能获得输出键值对（key-value），其中，<strong>参数 1</strong>可以看做我们数据的划分依据，例如，本例中我们是根据班级进行划分，而<strong>参数 2</strong>则是要传入这个划分的值，本例中，每个班级下，我们需要学生人数统计 count。</p>
<p>本例中，map 过程将会为我们产生两个文档，分别是：</p>
<p><strong>班级 1</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;1,[&#123;count:1&#125;,&#123;count:1&#125;]&#125;</div></pre></td></tr></table></figure>
<p><strong>班级 2</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;2,&#123;count:1&#125;&#125;</div></pre></td></tr></table></figure>
<p>下面再通过<strong>reduce（规约）</strong>过程对 map 产生的键值对进行处理, 输出每个班的人数：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> reduce = <span class="function"><span class="keyword">function</span>(<span class="params">key,values</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> res = &#123;<span class="attr">count</span>:<span class="number">0</span>&#125;</div><div class="line">  values.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">    res.count += value.count;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>! 重要：reduce 函数中接收的 value 参数的形式，必须和 reduce 函数返回的结果 value 的形式一致</p>
</blockquote>
<p>本例中，reduce 过程将产生两个文档：</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  _id: 1</div><div class="line">  value: &#123;count:2&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">_id: 2</div><div class="line">value: &#123;count:1&#125;</div></pre></td></tr></table></figure>
<p>最后，通过 mongodb 的<strong>mapReduce()</strong>函数将统计信息输出到<strong>statistics</strong>集合中：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">db.student.mapReduce(map,reduce,&#123;<span class="attr">out</span>:<span class="string">"statistics"</span>&#125;);</div></pre></td></tr></table></figure>
<p>现在我们执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">db.statistics.find();</div></pre></td></tr></table></figure>
<p>将能看到如下结果：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-mapreduce_result.png" alt="mapreduce"></p>
<h3 id="标签统计实现"><a href="#标签统计实现" class="headerlink" title="标签统计实现"></a>标签统计实现</h3><p>借助 sails 中 <a href="http://sailsjs.org/documentation/reference/waterline-orm/models/native" target="_blank" rel="external"><strong>native()</strong></a> 方法，我们可以封装 mapreduce 函数到我们的业务逻辑中：</p>
<p><strong>api/models/Article.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Article.js</div><div class="line"> *</div><div class="line"> * @description :: 文章模型</div><div class="line"> * @docs        :: http://sailsjs.org/#!documentation/models</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 定义 Article 集合的 map，reduce 函数, 统计标签</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> map = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 分类依据组成为："用户 ID: 标签"</span></div><div class="line">    <span class="keyword">this</span>.tags.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">tag</span>) </span>&#123;</div><div class="line">        emit(tag, <span class="number">1</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> reduce = <span class="function"><span class="keyword">function</span> (<span class="params">k, values</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> total = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</div><div class="line">        total += values[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> total;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line"></div><div class="line">    <span class="attr">attributes</span>: &#123;</div><div class="line">        <span class="attr">title</span>: &#123;</div><div class="line">            <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</div><div class="line">            <span class="attr">minLength</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">maxLength</span>: <span class="number">40</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">content</span>: &#123;</div><div class="line">            <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</div><div class="line">            <span class="attr">minLength</span>: <span class="number">1</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">tags</span>: &#123;</div><div class="line">            <span class="attr">type</span>: <span class="string">'array'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">category</span>: &#123;</div><div class="line">            <span class="attr">model</span>: <span class="string">'category'</span>,</div><div class="line">            <span class="attr">required</span>: <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 每次文章创建完成，更新标签统计</span></div><div class="line">    afterCreate: <span class="function"><span class="keyword">function</span> (<span class="params">article, cb</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.updateTags();</div><div class="line">        cb();</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">//custom</span></div><div class="line">    updateTags: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        Article.native(<span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span> res.serverError(err);</div><div class="line">            collection.mapReduce(map, reduce, &#123;<span class="attr">out</span>: <span class="string">"tags"</span>&#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="创建-Tags-api"><a href="#创建-Tags-api" class="headerlink" title="创建 Tags api"></a>创建 Tags api</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails generate api tags</div></pre></td></tr></table></figure>
<h2 id="添加路由及访问控制"><a href="#添加路由及访问控制" class="headerlink" title="添加路由及访问控制"></a>添加路由及访问控制</h2><h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p><strong>_config/routes.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">//----------------Aticles</span></div><div class="line">   <span class="comment">// 默认显示全部文章</span></div><div class="line">   <span class="string">'/'</span>: <span class="string">'ArticleController.index'</span>,</div><div class="line">   <span class="comment">// 显示某篇文章</span></div><div class="line">   <span class="string">'get /article/show/:id'</span> : <span class="string">'ArticleController.show'</span>,</div><div class="line">   <span class="comment">// 跳转到创建文章页</span></div><div class="line">   <span class="string">'get /article/new'</span>: <span class="string">'ArticleController.new'</span>,</div><div class="line">   <span class="comment">// 跳转到编辑文章页</span></div><div class="line">   <span class="string">'get /article/edit/:id'</span>: <span class="string">'ArticleController.edit'</span>,</div><div class="line"></div><div class="line">   <span class="comment">// 显示分类下的全部文章</span></div><div class="line">   <span class="string">'/category/:id/articles/:page'</span>: <span class="string">'CategoryController.getArticles'</span>,</div><div class="line"></div><div class="line">   <span class="comment">// 显示标签下的全部文章</span></div><div class="line">   <span class="string">'/tag/:name/articles/:page'</span>: <span class="string">'TagsController.getArticles'</span>,</div></pre></td></tr></table></figure>
<h3 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h3><p><strong>config/polies.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 文章显示逻辑不需要登录</span></div><div class="line">    ArticleController: &#123;</div><div class="line">        <span class="attr">index</span>: <span class="string">'userCreated'</span>,</div><div class="line">        <span class="attr">show</span>: <span class="string">'userCreated'</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">CategoryController</span>: &#123;</div><div class="line">        <span class="attr">getArticles</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">TagsController</span>: &#123;</div><div class="line">        <span class="attr">getArticles</span>: <span class="literal">true</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="页面组织"><a href="#页面组织" class="headerlink" title="页面组织"></a>页面组织</h2><p>我是采用如下的页面组织方式:</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-article_views.png" alt="页面组织"></p>
<p>其中编辑页面和创建页面因为逻辑相似（二者的区别在于表单的 action 及 method，这个我们可以通过），共用<strong>save.swig</strong>，其中含有一个编辑器<strong>_editor.swig</strong>的子页面，建议所有内嵌的子页面都以下划线开头，以示区分。</p>
<h2 id="业务逻辑撰写"><a href="#业务逻辑撰写" class="headerlink" title="业务逻辑撰写"></a>业务逻辑撰写</h2><p><strong>api/controllers/ArticleController.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 跳至创建文章</span></div><div class="line">    <span class="keyword">new</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">        <span class="comment">// 获取分类</span></div><div class="line">        Category.find()</div><div class="line">            .exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, categories</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!err) &#123;</div><div class="line">                    <span class="keyword">return</span> res.view(</div><div class="line">                        <span class="string">'article/save'</span>,</div><div class="line">                        &#123;</div><div class="line">                            <span class="attr">categories</span>: categories,</div><div class="line">                            <span class="attr">form</span>: &#123;<span class="attr">action</span>: <span class="string">'/article'</span>, <span class="attr">method</span>: <span class="string">'POST'</span>&#125;</div><div class="line">                        &#125;</div><div class="line">                    )</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 跳至修改文章:</span></div><div class="line">    edit: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">        <span class="comment">// 获取文章</span></div><div class="line">        <span class="keyword">var</span> id = req.param(<span class="string">'id'</span>);</div><div class="line">        Article.findOne(id).exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, article</span>) </span>&#123;</div><div class="line">            <span class="comment">// 如果不存在，404</span></div><div class="line">            <span class="keyword">if</span> (article) &#123;</div><div class="line">                <span class="comment">// 获取分类</span></div><div class="line">                Category.find()</div><div class="line">                    .exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, categories</span>) </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (!err) &#123;</div><div class="line">                            <span class="keyword">return</span> res.view(</div><div class="line">                                <span class="string">'article/save'</span>,</div><div class="line">                                &#123;</div><div class="line">                                    <span class="attr">article</span>: article,</div><div class="line">                                    <span class="attr">categories</span>: categories,</div><div class="line">                                    <span class="attr">form</span>: &#123;<span class="attr">action</span>: <span class="string">'/article/'</span> + id, <span class="attr">method</span>: <span class="string">'PUT'</span>&#125;</div><div class="line">                                &#125;</div><div class="line">                            )</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> res.notFound();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="Promise-解决难看的嵌套回调"><a href="#Promise-解决难看的嵌套回调" class="headerlink" title="Promise 解决难看的嵌套回调"></a>Promise 解决难看的嵌套回调</h3><p>OK，可以看到，我们已经遇到了 Nodejs 常见的多层嵌套回调了，不断横向延伸的代码感觉就像闷了口大翔在嘴里，非常不舒服，在 ES6 中，可以通过 <a href="https://promisesaplus.com/" target="_blank" rel="external">Promise</a> 来解决嵌套的回调，下面简要介绍一下 Promise。</p>
<p>顾名思义，Promise 代表一种 “许诺”，也就是未来才会发生的东西，如同现实生活中的许诺一样，它会被“履行（fulfiled）” 或者“拒绝履行（rejected）“,Promise 的核心方法就在于<strong>then(onFulfiled,onRejected)</strong>方法，通过 then，我们就能构造一个不断向下的过程，而不是横向延伸。下面看个栗子：</p>
<p>一个 AJAX 的嵌套回调:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 首先我要得到一篇文章</span></div><div class="line">$.get(<span class="string">'/article'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(err)</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  <span class="comment">// 在回调中得到该文章所有的评论</span></div><div class="line">    $.get(article.commentsURL,<span class="function"><span class="keyword">function</span>(<span class="params">err,comments</span>)</span>&#123;</div><div class="line">      <span class="comment">//doSomething</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>再看经 promise 处理后的代码:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">$.get(<span class="string">'/article'</span>)</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">article</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> $.get(article.commentsURL);</div><div class="line">  &#125;)</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">comments</span>)</span>&#123;</div><div class="line">    <span class="comment">// doSomething</span></div><div class="line">  &#125;)</div><div class="line">  .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">    <span class="comment">// error handler</span></div><div class="line">  &#125;)</div></pre></td></tr></table></figure>
<p>显然，这种向下的逐级传递使得回调逻辑更加易读以及易维护。想更深入了解 Promise，可以参看<a href="http://spion.github.io/posts/why-i-am-switching-to-promises.html" target="_blank" rel="external">这篇文章</a>.</p>
<p>sails 所采用的 ORM–Waterline 也提倡我们进行 Promise 式的书写，其所采用的 Promise 实现库是<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">blue bird</a>。现在我们通过 blue bird 对以上的编辑（edit）文章的业务逻辑进行重构：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 跳至修改文章:</span></div><div class="line">edit: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="comment">// 获取文章</span></div><div class="line">    <span class="keyword">var</span> id = req.param(<span class="string">'id'</span>);</div><div class="line">    Article.findOne(id).populate(<span class="string">'category'</span>)</div><div class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">article</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> [article,Category.find()];</div><div class="line">        &#125;)</div><div class="line">        .spread(<span class="function"><span class="keyword">function</span> (<span class="params">article, categories</span>) </span>&#123;</div><div class="line">            res.view(</div><div class="line">                <span class="string">'article/save'</span>,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">article</span>: article,</div><div class="line">                    <span class="attr">categories</span>: categories,</div><div class="line">                    <span class="attr">form</span>: &#123;<span class="attr">action</span>: <span class="string">'/article/'</span> + id, <span class="attr">method</span>: <span class="string">'PUT'</span>&#125;</div><div class="line">                &#125;</div><div class="line">            );</div><div class="line">        &#125;)</div><div class="line">        .catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">            res.notFound();</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们访问<a href="http://localhost:1337/article/new" target="_blank" rel="external">localhost:1337/article/new</a>, 进入如下页面:</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails - 创建文章. png" alt="创建文章"></p>
<h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><h3 id="markdown-支持"><a href="#markdown-支持" class="headerlink" title="markdown 支持"></a>markdown 支持</h3><p>个人不喜欢用富文本编辑器，技术博客最好的写作工具还是 markdown，下面我们通过 bower 来为前端添加 markdown 解析，这里我用的<a href="https://github.com/chjj/marked" target="_blank" rel="external">marked</a>, 没理由，git 的 star 多。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bower install marked --save</div></pre></td></tr></table></figure>
<h3 id="代码高亮支持"><a href="#代码高亮支持" class="headerlink" title="代码高亮支持"></a>代码高亮支持</h3><p>对于代码高亮，选择老牌的<a href="https://highlightjs.org/" target="_blank" rel="external">highlight.js</a>, 提供了不少很骚的主题。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bower install highlightjs --save</div></pre></td></tr></table></figure>
<p>记得将喜欢的高亮主题添加到页面，否则看不到加亮效果</p>
<p><strong>views/article/layout.swig</strong>:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> '../partial/layout.swig' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/article.css"</span>/&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.bower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/highlightjs/styles/solarized_dark.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span></div><div class="line"><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p>现在，我们可以试试效果了，在表单创建相应内容，然后单击预览看看效果：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-4_article_edit.png" alt="markdown"></p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-4_article_preview.png" alt="preview"></p>
<blockquote>
<p>在创建 / 编辑文章前端逻辑中，新用到的 semantic-ui 的组件有<a href="http://www.semantic-ui.cn/modules/modal.html" target="_blank" rel="external">modal</a></p>
</blockquote>
<h3 id="重构标签"><a href="#重构标签" class="headerlink" title="重构标签"></a>重构标签</h3><p>因为表单发送的标签（tags）是字符串，而实际上我们的标签在数据库中的组织形式是数组，所以我们需要在<strong>每次后端验证 article 的表单前</strong>对发送过来的标签进行处理，将其转换为字符串形式，并保证每个标签的有效性和唯一性：</p>
<p><strong>api/models/Article.js</strong>中为<strong>beforeValidate</strong>生命期添加逻辑:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 文章验证前，重构标签</span></div><div class="line">    beforeValidate: <span class="function"><span class="keyword">function</span>(<span class="params">article,cb</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(article.tags.length) &#123;</div><div class="line">            <span class="keyword">var</span> rowTags = article.tags[<span class="number">0</span>].split(<span class="string">""</span>);</div><div class="line">            article.tags = [];</div><div class="line">            <span class="comment">// 去除空标签及重复标签</span></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;rowTags.length;i++)&#123;</div><div class="line">                <span class="keyword">var</span> tag = rowTags[i].replace(<span class="string">" "</span>,<span class="string">""</span>);</div><div class="line">                <span class="keyword">if</span>(tag.length&gt;<span class="number">0</span> &amp;&amp; (article.tags.indexOf(tag)&lt;<span class="number">0</span>))&#123;</div><div class="line">                    article.tags.push(tag);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        cb();</div><div class="line">    &#125;,</div></pre></td></tr></table></figure>
<h2 id="显示文章"><a href="#显示文章" class="headerlink" title="显示文章"></a>显示文章</h2><h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>考虑到访问性能，我们要进行分页，分页采用”下一页“方式，操作方式为“点击加载”。</p>
<p>waterline 通过<strong>paginate()</strong>函数实现分页：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">Model.find().paginate(&#123;<span class="attr">page</span>: <span class="number">2</span>, <span class="attr">limit</span>: <span class="number">10</span>&#125;);</div></pre></td></tr></table></figure>
<h3 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h3><p>在<strong>api/controllers/ArticleController.js</strong>添加文章显示的业务逻辑:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 文章查询顺序：以更新时间逆序</span></div><div class="line">FIND_ORDER = <span class="string">'updatedAt desc'</span>;</div><div class="line"><span class="comment">// 文章每页条目数</span></div><div class="line">FIND_PER_PAGE = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="comment">// 文章查询顺序：以更新时间逆序</span></div><div class="line">FIND_ORDER = <span class="string">'updatedAt desc'</span>;</div><div class="line"><span class="comment">// 文章每页条目数</span></div><div class="line">FIND_PER_PAGE = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 首页显示文章</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    index:<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line">        <span class="comment">// 获得当前需要加载第几页</span></div><div class="line">        <span class="keyword">var</span> page = req.param(<span class="string">'page'</span>) ? req.param(<span class="string">'page'</span>) : <span class="number">1</span>;</div><div class="line">        <span class="comment">// 如果是第 1 页，则需要加载分类以及标签</span></div><div class="line">        <span class="keyword">if</span>( page==<span class="number">1</span> ) &#123;</div><div class="line">            Article.find(&#123;</div><div class="line">                <span class="attr">sort</span>: FIND_ORDER,</div><div class="line">            &#125;).paginate(&#123;<span class="attr">page</span>: page, <span class="attr">limit</span>: FIND_PER_PAGE&#125;)</div><div class="line">                .populate(<span class="string">'category'</span>).then(<span class="function"><span class="keyword">function</span> (<span class="params">articles</span>) </span>&#123;</div><div class="line">                    <span class="comment">// 每篇文章转换</span></div><div class="line">                    <span class="comment">// 查找分类, 及标签</span></div><div class="line">                    <span class="keyword">return</span> [</div><div class="line">                        articles,</div><div class="line">                        Category.find(),</div><div class="line">                        Tags.find()</div><div class="line">                    ];</div><div class="line">                &#125;)</div><div class="line">                .spread(<span class="function"><span class="keyword">function</span> (<span class="params">articles, categories, tags</span>) </span>&#123;</div><div class="line">                    <span class="keyword">return</span> res.view(</div><div class="line">                        <span class="string">'article/index'</span>,</div><div class="line">                        &#123;</div><div class="line">                            <span class="attr">articles</span>: articles,</div><div class="line">                            <span class="attr">categories</span>: categories,</div><div class="line">                            <span class="attr">tags</span>: tags,</div><div class="line">                            <span class="attr">page</span>: page</div><div class="line">                        &#125;);</div><div class="line">                &#125;);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            Article.find(&#123;</div><div class="line">                    <span class="attr">sort</span>: FIND_ORDER,</div><div class="line">                &#125;).paginate(&#123;<span class="attr">page</span>: page, <span class="attr">limit</span>: FIND_PER_PAGE&#125;)</div><div class="line">                .populate(<span class="string">'category'</span>).exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, articles</span>) </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (!err) &#123;</div><div class="line">                        <span class="comment">// 刷新下一页</span></div><div class="line">                        <span class="keyword">return</span> res.view(</div><div class="line">                            <span class="string">'article/_article'</span>,</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">articles</span>: articles,</div><div class="line">                                <span class="attr">page</span>: page</div><div class="line">                            &#125;);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="built_in">console</span>.log(err);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 显示某篇文章</span></div><div class="line">    show:<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> id = req.param(<span class="string">'id'</span>);</div><div class="line">        Article.findOne(id).populate(<span class="string">'category'</span>).</div><div class="line">            exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, article</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">                res.notFound();</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                res.view(<span class="string">'article/show'</span>,&#123;</div><div class="line">                    <span class="attr">articles</span>: [article]</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    </div><div class="line">    <span class="comment">//..............</span></div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<h3 id="markdown-显示优化"><a href="#markdown-显示优化" class="headerlink" title="markdown 显示优化"></a>markdown 显示优化</h3><p>我自己小改了一下 git 的 markdown theme，主要是去掉了自带的代码高亮，来使得 markdown 解析出的内容效果更加舒适，相应文件在<a href="https://github.com/yoyoyohamapi/blog/blob/master/assets/sass/default/markdown.scss" target="_blank" rel="external">这儿</a>,<br>在<strong>views/article/layout.swig</strong>引入 css：</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> '../partial/layout.swig' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/article.css"</span>/&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.bower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/highlightjs/styles/solarized_dark.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/markdown.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span></div><div class="line"><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>OK，访问 <a href="http://localhost:1337" target="_blank" rel="external">localhost:1337</a> 看一下效果：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-4_article_index.png" alt="文章显示首页"></p>
<hr>
<h2 id="章节预告"><a href="#章节预告" class="headerlink" title="章节预告"></a>章节预告</h2><p>下一章节中，我们将实现个人信息维护功能。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Sails_Tutorial/利用Sails.js+MongoDB开发博客系统(5)--个人信息维护/">利用 Sails.js+MongoDB 开发博客系统 (5)-- 个人信息维护</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="章节概述"><a href="#章节概述" class="headerlink" title="章节概述"></a>章节概述</h2><p>在本章中，你将能学到如下知识:</p>
<ul>
<li>利用 skipper 来上传和存储文件</li>
</ul>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>对于个人信息维护模块，我们暂时实现如下功能：</p>
<ul>
<li>头像更改, 站点的头像仅支持 jpeg 格式，并保存到：<strong>/assets/images/avatar.jpg</strong></li>
<li>站点信息维护：包括站点名称以及站点介绍</li>
</ul>
<p>其他诸如密码修改等功能留给读者自行完成。</p>
<h2 id="配置路由"><a href="#配置路由" class="headerlink" title="配置路由"></a>配置路由</h2><p><strong>config/routes.js</strong>添加:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">//---------------User Profile</span></div><div class="line">    <span class="string">'/user/profile'</span>: <span class="string">'UserController.index'</span>,</div><div class="line"></div><div class="line">    <span class="string">'/user/profile/avatar'</span>: <span class="string">'UserController.setAvatar'</span>,</div></pre></td></tr></table></figure>
<h2 id="业务逻辑撰写"><a href="#业务逻辑撰写" class="headerlink" title="业务逻辑撰写"></a>业务逻辑撰写</h2><p>sails 中通过 <a href="https://github.com/balderdashy/skipper" target="_blank" rel="external">skipper</a> 实现了<a href="http://www.sailsjs.org/documentation/concepts/file-uploads" target="_blank" rel="external">文件上传</a>，其核心函数是<strong>upload()</strong>，其第一个参数可接受如下配置:</p>
<ul>
<li>dirname：上传文件保存目录</li>
<li>maxBytes：总的上传（不是单个文件）大小限制</li>
<li>saveAs：如果该参数是字符串，表示单个文件的保存名，如果是函数，则对每个上传文件进行设置</li>
<li>onProcess：每此上传过程中的回调逻辑</li>
</ul>
<p><strong>api/controllers/UserController.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="comment">// 个人信息修改首页</span></div><div class="line">    index: <span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(req.method === <span class="string">'GET'</span>)&#123;</div><div class="line">            <span class="keyword">return</span> res.view(<span class="string">'user/index'</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 跳转到设置头像页面</span></div><div class="line">    setAvatar: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (req.method === <span class="string">'GET'</span>)</div><div class="line">            <span class="keyword">return</span> res.view(<span class="string">'user/avatar'</span>);</div><div class="line"></div><div class="line">        <span class="comment">// POST 请求进行文件上传</span></div><div class="line">        <span class="comment">// 判断是否有文件上传</span></div><div class="line">        <span class="keyword">if</span> (!req.file(<span class="string">'avatar'</span>)._files[<span class="number">0</span>]) &#123;</div><div class="line">            <span class="keyword">return</span> res.badRequest(<span class="string">'No file was uploaded'</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 判断文件类型是否争取</span></div><div class="line">        <span class="keyword">var</span> fileType = req.file(<span class="string">'avatar'</span>)._files[<span class="number">0</span>].stream.headers[<span class="string">'content-type'</span>];</div><div class="line">        <span class="keyword">if</span> (fileType != <span class="string">'image/jpeg'</span>) &#123;</div><div class="line">            <span class="keyword">return</span> res.badRequest(<span class="string">'文件类型错误, 仅支持 JPG 文件格式'</span>);</div><div class="line">        &#125;</div><div class="line">        req.file(<span class="string">'avatar'</span>).upload(&#123;</div><div class="line">            <span class="attr">maxBytes</span>: <span class="number">10000000</span>,</div><div class="line">            <span class="attr">dirname</span>: <span class="string">'../../assets/images'</span>,</div><div class="line">            <span class="attr">saveAs</span>: <span class="string">'avatar.jpg'</span></div><div class="line">        &#125;, <span class="function"><span class="keyword">function</span> <span class="title">whenDone</span>(<span class="params">err, uploadedFiles</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) &#123;</div><div class="line">                <span class="keyword">return</span> res.negotiate(err);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/'</span>);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="界面显示"><a href="#界面显示" class="headerlink" title="界面显示"></a>界面显示</h3><p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-5_article_profile.png" alt="profile"></p>
<blockquote>
<p>图像预览我选用的插件是<a href="https://github.com/blueimp/JavaScript-Load-Image" target="_blank" rel="external">JavaScript-Load-Image
</a></p>
</blockquote>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>利用 sails+mongodb 开发个人博客系统的教程就暂告段落，其实教程中很多东西未必是最佳实践（Best Practice），很多功能也尚未开发，本教程的写作动机和目的也不在于搭建一个博客系统，因为博主认为技术博客的最佳实践仍是静态博客，本教程的出发点还是在于让各位能够了解 sails 搭建 web app 的开发流程、少部分优化手段以及借此让各位接触一下 bower，grunt，semantic-ui 这些前端工具。</p>
<p>真心希望各位能够对文章提出宝贵的意见与批评 —- 吴小蛆.</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Sails_Tutorial/利用sails.js+mongodb开发博客系统(3)--登录注册/">利用 Sails.js+MongoDB 开发博客系统 (3)-- 账户模块</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="章节概述"><a href="#章节概述" class="headerlink" title="章节概述"></a>章节概述</h2><p>在本章中，你讲学习到如下知识： </p>
<ul>
<li><p>sails 中如何配置 mongodb</p>
</li>
<li><p>sails 中的模型层（Models）知识，包含有模型属性（attributes），模型生命期回调（lifecycle callbacks）等</p>
</li>
<li><p>利用 Passport.js 来管理我们的账户认证</p>
</li>
<li><p>认识密码加密策略 —bcrypt</p>
</li>
<li><p>认识 sails 的核心模块 —policies</p>
</li>
<li><p>如何在 sails 中撰写自定义配置</p>
</li>
<li><p>如何扩展 swig 模板引擎</p>
</li>
<li><p>semantic-ui 中表单验证模块的应用</p>
</li>
</ul>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><h3 id="用户（User）文档设计"><a href="#用户（User）文档设计" class="headerlink" title="用户（User）文档设计"></a>用户（User）文档设计</h3><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>类型</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>siteName</td>
<td>站点名称</td>
<td>string</td>
<td>必选，1~10 个字符</td>
</tr>
<tr>
<td>siteDesc</td>
<td>站点简介</td>
<td>string</td>
<td>可选，不超过 20 字符</td>
</tr>
<tr>
<td>email</td>
<td>用户邮箱</td>
<td>string(email)</td>
<td>必选，唯一</td>
</tr>
<tr>
<td>password</td>
<td>密码</td>
<td>string</td>
<td>必选，原始长度不少于 6 个字符</td>
</tr>
</tbody>
</table>
<h3 id="用户-api-生成"><a href="#用户-api-生成" class="headerlink" title="用户 api 生成"></a>用户 api 生成</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails generate api user</div></pre></td></tr></table></figure>
<p>可以看到，sails 为我们生成了 user 相应地模型及控制器</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-generate_api.png" alt="sails_generate_api"></p>
<h2 id="配置-MongoDB-数据库连接"><a href="#配置-MongoDB-数据库连接" class="headerlink" title="配置 MongoDB 数据库连接"></a>配置 MongoDB 数据库连接</h2><h3 id="安装-sails-对-mongo-的依赖"><a href="#安装-sails-对-mongo-的依赖" class="headerlink" title="安装 sails 对 mongo 的依赖"></a>安装 sails 对 mongo 的依赖</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install sails-mongo --save</div></pre></td></tr></table></figure>
<h3 id="配置-mongo-连接"><a href="#配置-mongo-连接" class="headerlink" title="配置 mongo 连接"></a>配置 mongo 连接</h3><p>修改<strong>config/connections.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.connections = &#123;</div><div class="line">  <span class="attr">mongo</span>: &#123;</div><div class="line">    <span class="attr">adapter</span>: <span class="string">'sails-mongo'</span>,</div><div class="line">    <span class="attr">host</span>: <span class="string">'localhost'</span>, <span class="comment">// defaults to `localhost` if omitted</span></div><div class="line">    port: <span class="number">27017</span>, <span class="comment">// defaults to 27017 if omitted</span></div><div class="line">    database: <span class="string">'blog'</span> <span class="comment">// or omit if not relevant</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="模型层的基本配置"><a href="#模型层的基本配置" class="headerlink" title="模型层的基本配置"></a>模型层的基本配置</h3><p>修改<strong>config/models.js</strong>, 配置模型的连接数据库位 mongodb，并为每个模型添加 updatedAt 以及 createdAt 属性:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.models = &#123;</div><div class="line"></div><div class="line">  <span class="string">'connection'</span> : <span class="string">'mongo'</span>,</div><div class="line">  <span class="attr">autoCreatedAt</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">autoUpdatedAt</span>: <span class="literal">true</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="利用-Passport-js-来管理我们的账户认证"><a href="#利用-Passport-js-来管理我们的账户认证" class="headerlink" title="利用 Passport.js 来管理我们的账户认证"></a>利用 Passport.js 来管理我们的账户认证</h2><p><a href="http://passportjs.org/" target="_blank" rel="external"><strong>Passport.js</strong></a>是 Node.js 中一个专注于登录验证的中间件，配置灵活，支持很多第三方登录验证，同时也能与 sails 无缝衔接。十分感谢 <a href="http://iliketomatoes.com/implement-passport-js-authentication-with-sails-js-0-10-2/" target="_blank" rel="external">这篇教程</a> 帮助我将 Passport.js 集成到 sails 中。</p>
<h3 id="安装相应依赖"><a href="#安装相应依赖" class="headerlink" title="安装相应依赖"></a>安装相应依赖</h3><p>安装<a href="">bcrypt</a>,bcrypt 被认为是比一般加盐加密更好的密码加密手段，一般的加盐加密在密码较简单是仍可能被暴力破解，bcrypt 牺牲了部分性能，来换取更高的密码存储安全，参看如下两篇文章：</p>
<ul>
<li><p><a href="http://codahale.com/how-to-safely-store-a-password/" target="_blank" rel="external">How To Safely Store A Password</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/lixiong/archive/2011/12/24/2300098.html" target="_blank" rel="external">md5/sha1+salt 和 Bcrypt</a></p>
</li>
</ul>
<p>安装 bcrypt:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install bcrpyt --save</div></pre></td></tr></table></figure>
<p>安装 Passport.js:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install passport --save</div></pre></td></tr></table></figure>
<p>因为我们是本地验证，所以只需要 passport 的本地验证支持</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install passport-local --save</div></pre></td></tr></table></figure>
<h3 id="配置-User-实体"><a href="#配置-User-实体" class="headerlink" title="配置 User 实体"></a>配置 User 实体</h3><p>在此博客系统中，用户注册前需要对用户密码进行 bcrypt 加密，这将会利用到 sails 中模型层的生命期回调<a href="http://www.sailsjs.org/documentation/concepts/models-and-orm/lifecycle-callbacks" target="_blank" rel="external">Lifecycle callbacks</a>, 在此，我们用到的生命期为<strong>beforeCreate</strong>，亦即模型创建前执行的回调：</p>
<p><strong>api/models/User.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>);</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="comment">// 站点名称</span></div><div class="line">    siteName: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">required</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">minLength</span>:<span class="number">1</span>,</div><div class="line">      <span class="attr">maxLength</span>:<span class="number">10</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 邮箱</span></div><div class="line">    email: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'email'</span>,</div><div class="line">      <span class="attr">unique</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">required</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 密码</span></div><div class="line">    password: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">required</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 站点简介</span></div><div class="line">    siteDesc: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">defaultsTo</span>: <span class="string">'暂无简介'</span>,</div><div class="line">      <span class="attr">maxLength</span>:<span class="number">40</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 是否管理员（默认为非管理员）</span></div><div class="line">    isAdmin: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'boolean'</span>,</div><div class="line">      <span class="attr">defaultsTo</span>: <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// 创建（注册）用户前，对用户密码加密</span></div><div class="line">  beforeCreate: <span class="function"><span class="keyword">function</span> (<span class="params">values, cb</span>) </span>&#123;</div><div class="line">    bcrypt.genSalt(<span class="number">10</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, salt</span>) </span>&#123;</div><div class="line">      bcrypt.hash(values.password, salt, <span class="function"><span class="keyword">function</span>(<span class="params">err, hash</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(err) <span class="keyword">return</span> cb(err);</div><div class="line">        values.password = hash;</div><div class="line">        <span class="comment">// 执行用户定义回调</span></div><div class="line">        cb();</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="创建路由及视图"><a href="#创建路由及视图" class="headerlink" title="创建路由及视图"></a>创建路由及视图</h3><p>先创建一个封装了登录注册逻辑的控制器<strong>AuthController.js</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sails generate controller auth</div></pre></td></tr></table></figure>
<p>接下来在<strong>config/routes.js</strong>中为我们的登录注册创建相应路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">//config/routes.js</span></div><div class="line"><span class="built_in">module</span>.exports.routes = &#123;</div><div class="line"></div><div class="line">  <span class="comment">/***************************************************************************</span></div><div class="line">  *                                                                          *</div><div class="line">  * Make the view located at `views/homepage.ejs` (or `views/homepage.jade`, *</div><div class="line">  * etc. depending on your default view engine) your home page.              *</div><div class="line">  *                                                                          *</div><div class="line">  * (Alternatively, remove this and add an `index.html` file in your         *</div><div class="line">  * `assets` directory)                                                      *</div><div class="line">  *                                                                          *</div><div class="line">  ***************************************************************************/</div><div class="line"></div><div class="line">  <span class="comment">//'/': &#123;</span></div><div class="line">  <span class="comment">//  view: 'homepage'</span></div><div class="line">  <span class="comment">//&#125;</span></div><div class="line"></div><div class="line">  <span class="string">'/'</span> : &#123;</div><div class="line">    <span class="attr">view</span> :<span class="string">'index'</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">//---------------Login &amp; Register</span></div><div class="line">    <span class="comment">// 跳转到注册页面</span></div><div class="line">    <span class="string">'get /register'</span>: <span class="string">'AuthController.toRegister'</span>,</div><div class="line">    <span class="comment">// 处理注册逻辑</span></div><div class="line">    <span class="string">'post /register'</span>: <span class="string">'AuthController.processRegister'</span>,</div><div class="line">    <span class="comment">// 跳转到登陆页</span></div><div class="line">    <span class="string">'get /login'</span>: &#123;</div><div class="line">        <span class="attr">view</span>: <span class="string">'passport/login'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 处理登陆逻辑</span></div><div class="line">    <span class="string">'post /login'</span>: <span class="string">'AuthController.processLogin'</span>,</div><div class="line">    <span class="comment">// 登出逻辑</span></div><div class="line">    <span class="string">'/logout'</span>: <span class="string">'AuthController.logout'</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="创建对应的视图"><a href="#创建对应的视图" class="headerlink" title="创建对应的视图"></a>创建对应的视图</h3><blockquote>
<p>相应地 css 文件内容不给出，UI 设计见仁见智。</p>
</blockquote>
<p><strong>views/passport/layout.swig</strong>:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> '../partial/layout.swig' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> stylesheets -%&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; path.style &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/passport.css"</span>/&gt;</span></span></div><div class="line"><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>注意，给登录及注册页面声明待调用模块：<br><strong>passport/login</strong>及<strong>passport/register</strong></p>
<p><strong>views/passport/login.swig</strong>:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> 'layout.swig' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">set</span></span> module = 'passport/login' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> title -%&#125;</span><span class="xml">欢迎登录</span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> form_content -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"ui form"</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"ui dividing header"</span>&gt;</span> 欢迎登录 < span class="tag">&lt;/<span class="name">h1</span>&gt;</div><div class="line">        <span class="template-tag">&#123;% <span class="name"><span class="keyword">if</span></span> err -%&#125;</span><span class="xml"></span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui error message"</span> <span class="attr">style</span>=<span class="string">"display: block"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span> 登录失败 < span class="tag">&lt;/<span class="name">div</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span> 账号或密码错误 < span class="tag">&lt;/<span class="name">p</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="template-tag">&#123;%- <span class="name"><span class="keyword">endif</span></span> %&#125;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"您的邮箱"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"您的密码"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui buttons"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"ui positive button"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span> 登录 < span class="tag">&lt;/<span class="name">button</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"or"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"ui negative button"</span> <span class="attr">href</span>=<span class="string">"/register"</span>&gt;</span> 注册 < span class="tag">&lt;/<span class="name">a</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p><strong>views/passport/register.swig</strong>:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">extends</span></span> 'layout.swig' -%&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">set</span></span> module='passport/register' %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> title -%&#125;</span><span class="xml">注册</span><span class="template-tag">&#123;%- <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> form_content -%&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"ui form"</span> <span class="attr">action</span>=<span class="string">"/register"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"ui dividing header"</span>&gt;</span> 欢迎注册 < span class="tag">&lt;/<span class="name">h1</span>&gt;</div><div class="line">        <span class="template-tag">&#123;% <span class="name"><span class="keyword">if</span></span> err -%&#125;</span><span class="xml"></span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui error message"</span> <span class="attr">style</span>=<span class="string">"display: block"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span> 注册失败 < span class="tag">&lt;/<span class="name">div</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span> 邮箱已被注册 < span class="tag">&lt;/<span class="name">p</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="template-tag">&#123;%- <span class="name"><span class="keyword">endif</span></span> %&#125;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span> = <span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"siteName"</span> <span class="attr">name</span>=<span class="string">"siteName"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"填写站点名称"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">placeholder</span>=<span class="string">"填写邮箱"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"填写密码（不少于 6 个字符）"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"siteDesc"</span> <span class="attr">name</span>=<span class="string">"siteDesc"</span> <span class="attr">placeholder</span>=<span class="string">"填写站点简介"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ui buttons"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"ui positive button"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span> 注册 < span class="tag">&lt;/<span class="name">button</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"or"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"ui negative button"</span> <span class="attr">href</span>=<span class="string">"/login"</span>&gt;</span> 登录 < span class="tag">&lt;/<span class="name">a</span>&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;%-<span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="撰写登录验证逻辑，感谢-Giancarlo-Soverini-提供教程"><a href="#撰写登录验证逻辑，感谢-Giancarlo-Soverini-提供教程" class="headerlink" title="撰写登录验证逻辑，感谢 Giancarlo Soverini 提供教程"></a>撰写登录验证逻辑，<a href="http://iliketomatoes.com/implement-passport-js-authentication-with-sails-js-0-10-2/" target="_blank" rel="external">感谢 Giancarlo Soverini 提供教程</a></h3><p>在<strong>api/controllers/AuthController.js</strong>添加如下内容：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 验证逻辑控制器</div><div class="line">* */</div><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理注册逻辑</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    processRegister: <span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line">        <span class="comment">// 由请求参数构造待创建 User 对象</span></div><div class="line">        <span class="keyword">var</span> user = req.allParams();</div><div class="line">        User.create(user).exec(<span class="function"><span class="keyword">function</span> <span class="title">createCB</span>(<span class="params">err, created</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">               <span class="comment">// 如果有误，返回错误</span></div><div class="line">                res.view(<span class="string">'passport/register'</span>,&#123;<span class="attr">err</span>:err&#125;);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">// 否则，将新创建的用户登录</span></div><div class="line">                req.login(created, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> next(err); &#125;</div><div class="line">                    <span class="keyword">return</span> res.redirect(<span class="string">'/'</span>);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理登陆逻辑</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    processLogin: <span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</div><div class="line">        <span class="comment">// 使用本地验证策略对登录进行验证</span></div><div class="line">        passport.authenticate(<span class="string">'local'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, user, info</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> ((err) || (!user)) &#123;</div><div class="line">                <span class="keyword">return</span> res.send(&#123;</div><div class="line">                    <span class="attr">message</span>: info.message,</div><div class="line">                    <span class="attr">user</span>: user</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            req.logIn(user, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) res.send(err);</div><div class="line">                <span class="keyword">return</span> res.send(&#123;</div><div class="line">                    <span class="attr">message</span>: info.message,</div><div class="line">                    <span class="attr">user</span>: user</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">        &#125;)(req, res);</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理登出逻辑</div><div class="line">     * @param req</div><div class="line">     * @param res</div><div class="line">     */</div><div class="line">    logout: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">        req.logout();</div><div class="line">        res.redirect(<span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p>任何 sails 的控制器方法都有两个参数，<a href="http://www.sailsjs.org/documentation/reference/request-req" target="_blank" rel="external">req（请求）对象</a>及<a href="http://www.sailsjs.org/documentation/reference/response-res" target="_blank" rel="external">res（响应）对象</a>。</p>
</blockquote>
<p>创建<strong>config/passport.js</strong>对 passport 验证进行如下配置：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>),</div><div class="line">    <span class="comment">// 使用本地登录逻辑</span></div><div class="line">    LocalStrategy = <span class="built_in">require</span>(<span class="string">'passport-local'</span>).Strategy,</div><div class="line">    <span class="comment">// 使用 bcrypt 进行密码加密</span></div><div class="line">    bcrypt = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>);</div><div class="line"></div><div class="line">passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, done</span>) </span>&#123;</div><div class="line">    done(<span class="literal">null</span>, user.id);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, done</span>) </span>&#123;</div><div class="line">    User.findOne(&#123; <span class="attr">id</span>: id &#125; , <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">        done(err, user);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">passport.use(<span class="keyword">new</span> LocalStrategy(&#123;</div><div class="line">        <span class="attr">usernameField</span>: <span class="string">'email'</span>,</div><div class="line">        <span class="attr">passwordField</span>: <span class="string">'password'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">email, password, done</span>) </span>&#123;</div><div class="line"></div><div class="line">        User.findOne(&#123; <span class="attr">email</span>: email &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> done(err); &#125;</div><div class="line">            <span class="keyword">if</span> (!user) &#123;</div><div class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>, &#123; <span class="attr">message</span>: <span class="string">'Incorrect email.'</span> &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            bcrypt.compare(password, user.password, <span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!res)</div><div class="line">                    <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>, &#123;</div><div class="line">                        <span class="attr">message</span>: <span class="string">'Invalid Password'</span></div><div class="line">                    &#125;);</div><div class="line">                <span class="keyword">var</span> returnUser = &#123;</div><div class="line">                    <span class="attr">email</span>: user.email,</div><div class="line">                    <span class="attr">createdAt</span>: user.createdAt,</div><div class="line">                    <span class="attr">id</span>: user.id</div><div class="line">                &#125;;</div><div class="line">                <span class="keyword">return</span> done(<span class="literal">null</span>, returnUser, &#123;</div><div class="line">                    <span class="attr">message</span>: <span class="string">'Logged In Successfully'</span></div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">));</div></pre></td></tr></table></figure>
<h2 id="访问控制-ACL"><a href="#访问控制-ACL" class="headerlink" title="访问控制(ACL)"></a>访问控制(ACL)</h2><p>将 sails 启动后，访问 <a href="http://localhost:1337" target="_blank" rel="external">localhost:1337/register</a> 进行用户注册:</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails - 注册页面. png" alt="注册页面"></p>
<p>然后可以在 mongodb 中看到，我们成功创建了用户:</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails-2_user_created.png" alt="mongo_user_created"></p>
<p>###Policies</p>
<p>如何对系统中的页面进行访问控制，这里就要用到 sails 的核心组件 —<a href="http://www.sailsjs.org/documentation/concepts/policies" target="_blank" rel="external">Policies</a>，接下来我们创建几个 policy 来对我们的业务逻辑进行访问控制（access control）。</p>
<p>首先，创建<strong>api/policies/isAuthenticated.js</strong>，该 policy 用于判断请求是否授权（即用户是否登录）：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 用户是否被授权</div><div class="line"> * @param req</div><div class="line"> * @param res</div><div class="line"> * @param next</div><div class="line"> * @returns &#123;*&#125;</div><div class="line"> */</div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (req.isAuthenticated()) &#123;</div><div class="line">        <span class="keyword">return</span> next();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>因为本博客系统<strong>仅允许单用户</strong>存在，故在跳转到注册的业务逻辑时，我们需要知道用户是否被创建，如果用户被创建，则跳转回首页，否则继续执行注册相应逻辑：</p>
<p>创建<strong>api/policies/userNotCreated.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// 检查数据库中是否已经有用户</span></div><div class="line">    User.find().exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(users.length)&#123;</div><div class="line">            res.redirect(<span class="string">'/logout'</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            next();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>同时，本系统显然只有当用户存在时访问才是有效地（否则没有文章来源）：</p>
<p>创建<strong>api/policies/userCreated.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// 检查数据库中是否已经有用户</span></div><div class="line">    User.find().exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(users.length)&#123;</div><div class="line">            next();</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            res.redirect(<span class="string">'/register'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>然后设置<strong>config/policies.js</strong>，建立 policy 与各业务逻辑的映射关系：</p>
<blockquote>
<p><strong>true</strong>的含义代表，该业务逻辑可被任何角色访问，而通配符 * 则代表所有业务逻辑(action)</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Policy Mappings</div><div class="line"> */</div><div class="line"><span class="built_in">module</span>.exports.policies = &#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 默认所有行为需要登录</span></div><div class="line">    <span class="comment">// 若某些行为不需要，则在下面声明</span></div><div class="line">    <span class="string">'*'</span>: <span class="string">'isAuthenticated'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// 验证逻辑都不需要登录</span></div><div class="line">    <span class="comment">// 用户创建后不再允许注册</span></div><div class="line">    AuthController: &#123;</div><div class="line">        <span class="string">'*'</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">toRegister</span>: <span class="string">'userNotCreated'</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>接下来重启 sails，并访问<a href="http://localhost:1337" target="_blank" rel="external">localhost:1337</a>, 我们将会被跳转登录页：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails - 登陆页面. png" alt="登录页"></p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>注入站点名称（siteName），站点简介（siteDesc）等属性将经常被不止一个页面所访问，如果每次我们进行数据库查询获取这两个数据将会是十分低效的，在这里，我们通过 sails 灵活的自定义配置来设置这两个属性。</p>
<p>创建<strong>config/site.js</strong>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.site = &#123;</div><div class="line">    <span class="comment">// 站点名称</span></div><div class="line">    name  : <span class="string">""</span>,</div><div class="line">    <span class="comment">// 站点介绍</span></div><div class="line">    desc  : <span class="string">""</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>现在，在 swig 中，我们可以通过如下方式访问到这两个变量了:</p>
<figure class="highlight twig"><table><tr><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; sails.config.site.name &#125;&#125;</span><span class="xml"></span></div><div class="line"><span class="template-variable">&#123;&#123; sails.config.site.desc &#125;&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>然后，这样的书写方式太过冗长，为此，我们修改我们的视图配置，让页面维护一个<strong>site</strong>对象：</p>
<p><strong>config/views.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> extras = <span class="built_in">require</span>(<span class="string">'swig-extras'</span>);</div><div class="line"><span class="built_in">module</span>.exports.views = &#123;</div><div class="line">    <span class="attr">engine</span>: &#123;</div><div class="line">        <span class="comment">/* Template File Extension */</span></div><div class="line">        ext: <span class="string">'swig'</span>,</div><div class="line"></div><div class="line">        <span class="comment">/* Function to handle render request */</span></div><div class="line">        fn: <span class="function"><span class="keyword">function</span> (<span class="params">path, data, cb</span>) </span>&#123;</div><div class="line">            <span class="comment">/* Swig Renderer */</span></div><div class="line">            <span class="keyword">var</span> swig = <span class="built_in">require</span>(<span class="string">'swig'</span>);</div><div class="line">            <span class="comment">// 保证我们在开发环境下每次更改 swig 不用重启 sails</span></div><div class="line">            <span class="keyword">if</span> (data.settings.env === <span class="string">'development'</span>) &#123;</div><div class="line">                swig.setDefaults(&#123;<span class="attr">cache</span>: <span class="literal">false</span>&#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 维护一个 site 变量</span></div><div class="line">            data.site = sails.config.site;</div><div class="line">            <span class="comment">// 提供一个变量标示用户是否登录</span></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> (data.isLogged) == <span class="string">'undefined'</span>) &#123;</div><div class="line">                data.isLogged = !!data.req.isAuthenticated();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * 绑定一些常用路径</div><div class="line">             * Thanks to: https://github.com/mahdaen/sails-views-swig</div><div class="line">             * */</div><div class="line">            <span class="keyword">var</span> paths = &#123;</div><div class="line">                <span class="attr">script</span>: <span class="string">'/js'</span>,</div><div class="line">                <span class="attr">style</span>: <span class="string">'/styles/default'</span>,</div><div class="line">                <span class="attr">image</span>: <span class="string">'/images'</span>,</div><div class="line">                <span class="attr">font</span>: <span class="string">'/fonts'</span>,</div><div class="line">                <span class="attr">icon</span>: <span class="string">'/icons'</span>,</div><div class="line">                <span class="attr">bower</span>: <span class="string">'/bower_components'</span></div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!data.path) &#123;</div><div class="line">                data.path = paths;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> paths) &#123;</div><div class="line">                    <span class="keyword">if</span> (!key <span class="keyword">in</span> data.path) &#123;</div><div class="line">                        data.path[key] = paths[key];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 补充 extra</span></div><div class="line">            extras.useFilter(swig, <span class="string">'split'</span>);</div><div class="line">            <span class="comment">/* Render Templates */</span></div><div class="line">            <span class="keyword">return</span> swig.renderFile(path, data, cb);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">layout</span>: <span class="string">'layout'</span>,</div><div class="line"></div><div class="line">    <span class="attr">partials</span>: <span class="literal">false</span></div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>显然，每次服务器启动的时候就应当设置这两个变量，为此，我们修改<strong>config/bootstrap.js</strong>，该文件可以配置服务器启动时的相应动作：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.bootstrap = <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</div><div class="line">    <span class="comment">// 启动时刷新站点信息</span></div><div class="line">    User.find().exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(users.length &gt; <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">var</span> user = users[<span class="number">0</span>];</div><div class="line">            sails.config.site.name = user.siteName;</div><div class="line">            sails.config.site.desc = user.siteDesc;</div><div class="line">        &#125;</div><div class="line">        cb();</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>而每次用户信息创建或更新时也应当更新站点配置，为此，我们在<strong>User</strong>模型中添加新的生命期回调 —afterUpdate 及 afterCreate:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"></div><div class="line">afterCreate: <span class="function"><span class="keyword">function</span> (<span class="params">createdUser, cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.updateSite(user);</div><div class="line">    cb();</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// 用户信息更新时，更新站点信息</span></div><div class="line">afterUpdate: <span class="function"><span class="keyword">function</span> (<span class="params">user,cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.updateSite(user);</div><div class="line">    cb();</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// 更新站点信息</span></div><div class="line">updateSite: <span class="function"><span class="keyword">function</span>(<span class="params">user</span>)</span>&#123;</div><div class="line">    sails.config.site.name = user.siteName;</div><div class="line">    sails.config.site.desc = user.siteDesc;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h2><p>后端的响应属性验证已经在对应的 User 模型中设置好了，现在我们利用 semantic-ui 的 <a href="http://semantic-ui.com/collections/form.html" target="_blank" rel="external">表单验证模块</a> 来设置前端表单验证，让登录注册页的交互更加完整。</p>
<p>首先，我们要在<strong>assets/js/common/main.js</strong>中手动声明 semantic 表单验证组件的位置：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 第三方模块声明</span></div><div class="line"><span class="built_in">require</span>.config(&#123;</div><div class="line">    <span class="attr">baseUrl</span>: <span class="string">'/bower_components/'</span>,</div><div class="line">    <span class="attr">paths</span>: &#123;</div><div class="line">        <span class="attr">jquery</span>: <span class="string">'jquery/dist/jquery'</span>,</div><div class="line">        <span class="attr">requirejs</span>: <span class="string">'requirejs/require'</span>,</div><div class="line">        <span class="string">'semantic-ui'</span>: <span class="string">'semantic-ui/dist/semantic'</span>,</div><div class="line">        <span class="attr">underscore</span>: <span class="string">'underscore/underscore'</span>,</div><div class="line">        <span class="attr">backbone</span>: <span class="string">'backbone/backbone'</span>,</div><div class="line">        <span class="string">'semantic-form'</span>: <span class="string">'semantic-ui/dist/components/form.min'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">packages</span>: [</div><div class="line"></div><div class="line">    ]</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 加载 app，并运行</span></div><div class="line"><span class="built_in">require</span>([<span class="string">'/js/common/app.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">app</span>)</span>&#123;</div><div class="line">    app.init();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>接下来，我们在<strong>assets/js/passport/</strong>目录下创建三个文件：</p>
<ul>
<li><strong>login.js</strong></li>
<li><strong>register.js</strong></li>
<li><strong>PassportPanel.js</strong></li>
</ul>
<p>其中，<strong>PassportPanel.js</strong>中提供一个账户框视图组件（继承自<strong>Backbone.View</strong>）供 login 及 register 两个 module 调用。</p>
<p><strong>PassportPanel.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'semantic-form'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> PassportPanel = Backbone.View.extend(&#123;</div><div class="line">        <span class="attr">el</span>: $(<span class="string">'.passportContainer'</span>),</div><div class="line">        <span class="attr">events</span>: &#123;</div><div class="line">            <span class="string">'click input'</span>: <span class="string">'hideError'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">initialize</span>: <span class="function"><span class="keyword">function</span> (<span class="params">which</span>) </span>&#123;</div><div class="line">            <span class="comment">// 初始化时绑定表单验证</span></div><div class="line">            <span class="keyword">if</span> (which === <span class="string">'login'</span>)</div><div class="line">                <span class="keyword">this</span>.bindLoginForm();</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="keyword">this</span>.bindRegForm();</div><div class="line"></div><div class="line">        &#125;,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 聚焦输入框时，隐藏错误提示</div><div class="line">         */</div><div class="line">        hideError: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> ($(<span class="string">'.error'</span>).length &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (!$(<span class="string">'.error'</span>).is(<span class="string">':hidden'</span>)) &#123;</div><div class="line">                    $(<span class="string">'.error'</span>).hide();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 绑定登录表单验证</div><div class="line">         */</div><div class="line">        bindLoginForm: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            $(<span class="string">'.ui.form'</span>).form(&#123;</div><div class="line">                <span class="attr">inline</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">fields</span>: &#123;</div><div class="line">                    <span class="attr">email</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'email'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'email'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'请填写正确的邮箱'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">password</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'password'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'empty'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'请填写密码'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 绑定注册表单验证</span></div><div class="line">        bindRegForm: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            $(<span class="string">'.ui.form'</span>).form(&#123;</div><div class="line">                <span class="attr">inline</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">fields</span>: &#123;</div><div class="line">                    <span class="attr">siteName</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'siteName'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'empty'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'站点名不能为空'</span></div><div class="line">                            &#125;,</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'maxLength[10]'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'站点名不能超过 10 个字符'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">email</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'email'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'email'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'请填写正确的邮箱'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">password</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'password'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'length[6]'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'密码不能少于 6 位'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">siteDesc</span>: &#123;</div><div class="line">                        <span class="attr">identifier</span>: <span class="string">'siteDesc'</span>,</div><div class="line">                        <span class="attr">rules</span>: [</div><div class="line">                            &#123;</div><div class="line">                                <span class="attr">type</span>: <span class="string">'maxLength[20]'</span>,</div><div class="line">                                <span class="attr">prompt</span>: <span class="string">'站点简介不超过 20 字符'</span></div><div class="line">                            &#125;</div><div class="line">                        ]</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> PassportPanel;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>login.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'./PassportPanel.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">PassportPanel</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">run</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="comment">// 如果有错误，则当 focus 输入域时，自动隐藏错误提示</span></div><div class="line">            <span class="keyword">var</span> loginPanel = <span class="keyword">new</span> PassportPanel(<span class="string">'login'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>register.js</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">define([<span class="string">'./PassportPanel.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">PassportPanel</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">run</span> : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="keyword">var</span> regPanel = <span class="keyword">new</span> PassportPanel(<span class="string">'reg'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>测试一下：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/sails - 表单验证测试. png" alt="表单测试"></p>
<h2 id="章节预告"><a href="#章节预告" class="headerlink" title="章节预告"></a>章节预告</h2><p>在下一章当中，我们开始实现博客系统的文章模块。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Image_Processing/数字图像处理（9）-- 频率域滤波（3）：图像锐化/">数字图像处理（9）-- 频率域滤波（3）：图像锐化</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="频率域锐化滤波器："><a href="#频率域锐化滤波器：" class="headerlink" title="频率域锐化滤波器："></a>频率域锐化滤波器：</h2><p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 频率域锐化滤波器透视图. jpg" alt="频率域锐化滤波器"></p>
<p>锐化是平滑的反处理，平滑我们使低频突出，而高频下陷，锐化我们使低频下陷，高频突出。</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 频率域锐化滤波器. jpg" alt="频率域锐化滤波器"></p>
<p>如上可以看出，理想高通滤波器存在明显的 “振铃” 现象，而高斯高通滤波器则没有 “振铃” 现象。</p>
<p>实验表明，GHPF 的结果比 BHPF 和 IHPF 的结果更加平滑。</p>
<h2 id="频率域拉普拉斯算子："><a href="#频率域拉普拉斯算子：" class="headerlink" title="频率域拉普拉斯算子："></a>频率域拉普拉斯算子：</h2><p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 拉普拉斯算子 2.jpg" alt="频率域拉普拉斯算子"> </p>
<p>注意，拉普拉斯图像虽然是拱形的，但并非完成的是低频通过的滤波，因为高频分量被乘上了负值也是通过了的，而低频分量乘以一个十分靠近 0 的数则会受到抑制，所以拉普拉斯仍然是一个高通滤波器。可以看到，拉普拉斯滤波函数使得原图像平均灰度级变为 0，故而拉普拉斯滤波后的图像上分布着灰度值有正有负的像素点。</p>
<p>下面是拉普拉斯滤波后的结果：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 拉普拉斯 Demo2.jpg" alt="拉普拉斯滤波 Demo"></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Image_Processing/数字图像处理（10）-- 在OpenCv2及MATLAB中傅里叶变换的使用/">数字图像处理（10）-- 在 OpenCv2 及 MATLAB 中傅里叶变换的使用</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>##opencv2 中：</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;iostream&gt;</div><div class="line">#include &lt;opencv2\imgproc\imgproc.hpp&gt;</div><div class="line">#include &lt;opencv2\highgui\highgui.hpp&gt;</div><div class="line"></div><div class="line">using namespace cv;</div><div class="line">using namespace std;</div><div class="line"></div><div class="line">//Gloabla Variables</div><div class="line">Mat imgSrc,imgFrq;</div><div class="line">const char *winSrcName = "Image Src";</div><div class="line">const char *winFrqName = "Image Frq scaled";</div><div class="line"></div><div class="line"></div><div class="line">// 主函数入口 </div><div class="line">int main()&#123;</div><div class="line">  // 读取原图像, 并转换为灰度图像</div><div class="line">  const char *imgSrcPath = "E:\\Srcs\\Fig0323(a)(mars_moon_phobos).tif";</div><div class="line">  imgSrc = imread(imgSrcPath,CV_LOAD_IMAGE_GRAYSCALE);</div><div class="line">  </div><div class="line">  if (imgSrc.empty())</div><div class="line">    return -1;</div><div class="line"></div><div class="line">  Mat padded;// 扩展图像以加快离散傅里叶变换（当图像的尺寸是 2， 3，5 的整数倍时，计算速度最快）</div><div class="line">  int m = getOptimalDFTSize(imgSrc.rows);// 获得最佳变换尺寸</div><div class="line">  int n = getOptimalDFTSize(imgSrc.cols);</div><div class="line">  // 扩展原图像至 Padded 图像中, 边缘添加零, 且边缘右下填充（0,m-imgSrc.rows 代表顶部填充 0 行，底部填充 m-imgSrc.rows 行）</div><div class="line">  copyMakeBorder(imgSrc,padded,0,m-imgSrc.rows,0,n-imgSrc.cols,BORDER_CONSTANT,Scalar::all(0));</div><div class="line"></div><div class="line">  // 为傅立叶变换的结果(实部和虚部) 分配存储空间</div><div class="line">  Mat planes[] = &#123; Mat_&lt;float&gt;(padded), Mat::zeros(padded.size(), CV_32F) &#125;;</div><div class="line">  Mat imgComplex;// 新建复数域的图像</div><div class="line">  merge(planes,2,imgComplex);// 混合图像的实数部分和复数部分至新图像，亦即新图像每个像素点有实数，复数两个通道</div><div class="line"></div><div class="line">  // 执行傅里叶变换</div><div class="line">  dft(imgComplex,imgComplex);</div><div class="line">  // 得到幅度值，去复数域</div><div class="line">  split(imgComplex,planes);</div><div class="line">  magnitude(planes[0], planes[1], planes[0]);// 幅度 = （Real 平方 + Imginary 平方）开根号</div><div class="line">  Mat imgFrq = planes[0];// 此时不标定，将会产生全白色图像（因为平方数很大）</div><div class="line"></div><div class="line">  // 对数化图像，增加亮度(输出图像 = log(1 + 输入图像))</div><div class="line">  imgFrq += Scalar::all(1);</div><div class="line">  log(imgFrq,imgFrq);</div><div class="line">  /*</div><div class="line">  * 频谱图中心化</div><div class="line">  * 将频谱以中心划分为四个象限：</div><div class="line">  * 左上 -&gt;1，左下 -&gt;2，右下 -&gt;3，右上 -&gt;4</div><div class="line">  * 原象限与中心化后的象限对应关系：</div><div class="line">  *1-&gt;3,  2-&gt;4,  3-&gt;1,  4-&gt;2</div><div class="line">  */</div><div class="line">  int centerX = imgFrq.cols / 2;</div><div class="line">  int centerY = imgFrq.rows / 2;</div><div class="line">  Mat q1(imgFrq,Rect(0,0,centerX,centerY));</div><div class="line">  Mat q2(imgFrq, Rect(0, centerY, centerX, centerY));</div><div class="line">  Mat q3(imgFrq, Rect(centerX, centerY, centerX, centerY));</div><div class="line">  Mat q4(imgFrq, Rect(centerX, 0, centerX, centerY));</div><div class="line"></div><div class="line">  // 执行交换</div><div class="line">  Mat tmp;</div><div class="line">  q1.copyTo(tmp);</div><div class="line">  q3.copyTo(q1);</div><div class="line">  tmp.copyTo(q3);</div><div class="line"></div><div class="line">  q2.copyTo(tmp);</div><div class="line">  q4.copyTo(q2);</div><div class="line">  tmp.copyTo(q4);</div><div class="line"></div><div class="line">  // 标定</div><div class="line">  normalize(imgFrq, imgFrq, 255.0,0);</div><div class="line">  // 显示原图像及其填充图像对应的傅里叶频谱</div><div class="line">  namedWindow(winSrcName,CV_WINDOW_AUTOSIZE);</div><div class="line">  imshow(winSrcName,imgSrc);</div><div class="line">  namedWindow(winFrqName, CV_WINDOW_AUTOSIZE);</div><div class="line">  imshow(winFrqName, imgFrq);</div><div class="line">  waitKey(0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip-opencv2_傅里叶. png" alt="opencv2 傅里叶变换"></p>
<p>##Matlab 中:</p>
<figure class="highlight matlab"><table><tr><td class="code"><pre><div class="line">imgSrc = imread(<span class="string">'E:\\Srcs\\Fig0323(a)(mars_moon_phobos).tif'</span>);</div><div class="line"><span class="comment">% 进行离散傅里叶变换</span></div><div class="line">imgDst = fft2(imgSrc);</div><div class="line"><span class="comment">% 中心化</span></div><div class="line">imgDstCentered = fftshift(imgDst);</div><div class="line"><span class="comment">% 得到幅度值</span></div><div class="line">imgSpectrum = <span class="built_in">abs</span>(imgDstCentered);</div><div class="line"><span class="comment">% 对数增强</span></div><div class="line">imgSpectrum = <span class="built_in">log</span>(imgSpectrum);</div><div class="line"></div><div class="line"><span class="comment">% 傅里叶反变换</span></div><div class="line">imgIDFT = ifft2(imgDst);</div><div class="line"></div><div class="line"><span class="comment">% 显示工作</span></div><div class="line">figure;</div><div class="line">subplot(<span class="number">131</span>);</div><div class="line">imshow(imgSrc);</div><div class="line">subplot(<span class="number">132</span>);</div><div class="line">imshow(imgSpectrum,[]);</div><div class="line">subplot(<span class="number">133</span>);</div><div class="line">imshow(imgIDFT,[]);</div></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip-matlab_傅里叶. png" alt="matlab 傅里叶变换"></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/03/08/Image_Processing/数字图像处理（12）-- 图像修复及重建(1)：关于噪声的探讨/">数字图像处理（12）-- 图像修复及重建 (1)：关于噪声的探讨</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Mar 8, 2017
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="首先，我们需要构建图像质量下降的模型："><a href="#首先，我们需要构建图像质量下降的模型：" class="headerlink" title="首先，我们需要构建图像质量下降的模型："></a>首先，我们需要构建图像质量下降的模型：</h2><h3 id="空间域："><a href="#空间域：" class="headerlink" title="空间域："></a>空间域：</h3><p>$g(x,y)=h(x,y)\text{☆}f(x,y)+\eta(x,y)$</p>
<p>其中 $g(x,y)$ 为质量下降后的图像,$h(x,y)$ 使图像降质的函数,$f(x,y)$ 为原图像,$\eta(x,y)$ 为噪声图像</p>
<h3 id="频率域（空间域卷积对应频率域乘积）："><a href="#频率域（空间域卷积对应频率域乘积）：" class="headerlink" title="频率域（空间域卷积对应频率域乘积）："></a>频率域（空间域卷积对应频率域乘积）：</h3><p>$G(u,v)=H(u,v)F(u,v)+N(u,v)$</p>
<p>$G$,$H$,$F$,$N$ 对应如上 $g$,$h$,$f$,$\eta$ 的傅里叶变换。</p>
<h2 id="下面认识几种重要的噪声："><a href="#下面认识几种重要的噪声：" class="headerlink" title="下面认识几种重要的噪声："></a>下面认识几种重要的噪声：</h2><p>###Gaussian:</p>
<p>其概率密度函数为：（$p(z)$ 即噪声灰度为 $z$ 的概率）</p>
<p>$p(z)=\frac{1}{\sqrt{2\pi}\delta}e^{-(z-\bar{z})^2/2\delta^2}$</p>
<p>Gaussian 噪声的特点是：噪声灰度集中在中央灰阶左右，相对偏灰，黑白噪声分布较少。</p>
<p>###Rayleigh:</p>
<p>其概率密度函数为：</p>
<p>$\begin{equation} p(z)=\begin{cases}\frac{2}{b}(z-a)e^{-(z-a)^2/b}&amp;\mbox{for z}\geq{a} \0 &amp;\mbox{for z &lt; a} \end{cases}\end{equation}$</p>
<p>噪声灰度 $\geq a$, 概率密度曲线向右倾斜，右侧积分面积更大，即噪声灰度更多分布在中轴（$a+\sqrt{\frac{b}{2}}$）右侧。</p>
<p>###Erlang(gamma):</p>
<p>其概率密度函数为：</p>
<p>$\begin{equation}p(z)=\begin{cases}\frac{a^bz^{b-1}}{(b-1)!}{-e^{-az}}&amp;\mbox{for z}\geq{0}\0&amp;\mbox{for z &lt; 0}\end{cases}\end{equation}$</p>
<p>Erlang 噪声类似于 Reyleigh 噪声，但可以取到更左侧灰度。</p>
<p>###Exponential:</p>
<p>其概率密度函数为：</p>
<p>$\begin{equation}p(z)=\begin{cases}ae^(-az)&amp;\mbox{for z}\geq{0}\0&amp;\mbox{for z &lt; 0}\end{cases}\end{equation}$</p>
<p>概率密度函数呈指数下降状态，噪声灰度多集中在低灰度区。</p>
<p>###Uniform:</p>
<p>其概率密度函数为：</p>
<p>$\begin{equation}p(z)=\begin{cases}\frac{1}{b-a} &amp;\mbox{for a}\leq{z}\geq{b}\0 &amp;\mbox{otherwise}\end{cases}\end{equation}$</p>
<p>噪声灰度在 [a,b] 间等可能取值。</p>
<p>###Impulse(salt-and-peper):</p>
<p>其概率密度是函数为：</p>
<p>$\begin{equation}p(z)=\begin{cases}P_a &amp;\mbox{for z=a}\P_b &amp;\mbox{for z=b}\0 &amp;\mbox{otherwise}\end{cases}\end{equation}$</p>
<p>噪声灰度以一定可能性取值为 $a$，以一定可能性取值为 $b$，通常 $a$，$b$ 对比明显，一者为白如雪盐(salt)，另者黑如胡椒(pepper)</p>
<h2 id="空间滤波："><a href="#空间滤波：" class="headerlink" title="空间滤波："></a>空间滤波：</h2><p>当图像的降质仅有噪声引起时，即图像的降质模型为：</p>
<p>$g(x,y)=f(x,y)+\eta(x,y)$</p>
<p>$G(u,v)=F(u,v)+N(u,v)$</p>
<p>此时，宜考虑使用空间滤波进行图像修复</p>
<h3 id="均值滤波（mean-filter）："><a href="#均值滤波（mean-filter）：" class="headerlink" title="均值滤波（mean filter）："></a>均值滤波（mean filter）：</h3><p>####Arithmetic mean filter（算数均值滤波）：</p>
<p>图像修复模型：</p>
<p>$\hat{f}(x,y)=\frac{1}{mn}\sum\limits<em>{(s,t)\in S</em>{xy}}g(s,t)$</p>
<p>即坐标 $(x,y)$ 处像素修复后的灰度为该坐标领域 (领域大小为 $m*n$) 内像素灰度的算术平均值，其对 Gaussian 噪声有较好的处理效果。</p>
<p>####Geometric mean filter（几何均值滤波）：</p>
<p>图像修复模型：</p>
<p>$\hat{f}(x,y)=[\prod\limits<em>{(s,t)\in S</em>{xy}}g(s,t)]^{\frac{1}{mn}}$</p>
<p>即坐标 $(x,y)$ 处像素修复后的灰度为该坐标领域 (领域大小为 $m*n$) 内像素灰度的几何平均值，其对 Gaussian 噪声有较好的处理效果。</p>
<p>####Harmonic mean filter（调和平均数滤波）：</p>
<p>图像修复模型：</p>
<p>$\hat{f}(x,y)=\frac{mn}{\sum\limits<em>{(s,t)\in S</em>{xy}}\frac{1}{g(s,t)}}$</p>
<p>该模型有利于消除 salt 噪声，而不利于消除 pepper 噪声。</p>
<p>####Contraharmonic mean filter（反调和平均数滤波）:</p>
<p>图像修复模型：</p>
<p> $\hat{f}(x,y)=\frac{\sum\limits<em>{(s,t)\in S</em>{xy}}g(s,t)^{Q+1}}{\sum\limits<em>{(s,t)\in S</em>{xy}}g(s,t)^{Q}}$</p>
<p>该模型中对于 Q 的取值决定了针对什么噪声做图像复原，例如，若 Q 取正值，则能减轻 pepper 噪声，取负值则减轻 salt 噪声，鱼和熊掌不可兼得。如果 $Q=0$，则该模型就退化成了 arthmetic filter，而若 $Q=-1$，该模型就退化成了 harmonic filter。</p>
<h3 id="统计排序滤波（order-statistic-filter）："><a href="#统计排序滤波（order-statistic-filter）：" class="headerlink" title="统计排序滤波（order-statistic filter）："></a>统计排序滤波（order-statistic filter）：</h3><p>先排序像素灰度，再按一定算法选取某一灰度作为修复灰度。</p>
<p>####Median Filter（中值滤波）：<br>图像修复模型：</p>
<p>$\hat{f}(x,y)=\mbox{median}<em>{(s,t)\in S</em>{xy}}{g(s,t)}$</p>
<p>该模型实现简单，且能很好地消除椒盐噪声，因为通常椒盐噪声的灰度都偏向极端，不太可能落到中值位置（除非某一区域内落入了大量椒盐噪声）。<br>Max and min filters（最大最小值滤波）：<br>图像修复模型;</p>
<p>Max：$\hat{f}(x,y)=\max\limits<em>{(s,t)\in S</em>{xy}}g(s,t)$</p>
<p>Min:   $\hat{f}(x,y)=\min\limits<em>{(s,t)\in S</em>{xy}}g(s,t)$</p>
<p>显然，最大值滤波有利于消除 pepper 噪声，最小值滤波有利于消除 salt 噪声，因为通常 pepper 噪声的灰度都是极度小的，而 salt 噪声的灰度是极度大的。</p>
<p>####Midpoint filter(中点滤波):</p>
<p>图像修复模型：</p>
<p>$\hat{f}(x,y)=\frac{1}{2}[\min\limits<em>{(s,t)\in S</em>{xy}}g(s,t)+\max\limits<em>{(s,t)\in S</em>{xy}}g(s,t)]$</p>
<p>该模型既包含了统计排序又包含了平均化过程，其对于消除随机噪声会有很好地效果比如 Gaussian 噪声和 uniform 噪声。</p>
<p>####Alpha-trimmed mean filter（修正的阿尔法均值滤波）：</p>
<p>图像修复模型：</p>
<p>$\hat{f}(x,y)=\frac{1}{mn-d}\sum\limits<em>{(s,t)\in S</em>{xy}}g_r(s,t)$</p>
<p>该修复模型的工作过程如下：在 $m*n$ 大小排序好的像素领域内，删去前 $d/2$ 个灰度最小像素，前 $d/2$ 个灰度最大像素（掐头去尾可以消除椒盐噪声）,$g_r(s,t)$ 为剩下的 mn-d 个排序好的像素，对剩余像素求灰度平均（平均化操作又能消除如 Gaussian 或者 uniform 这样的随机噪声），故而该算法有利于消除混合噪声。</p>
<p>在该模型中，注意到若 $d=0$，则模型退化为 arithmetic mean filter，而若 $d=mn-1$，则模型退化为 mean filter，d 的选取是该模型的关键。</p>
<h2 id="频率域滤波："><a href="#频率域滤波：" class="headerlink" title="频率域滤波："></a>频率域滤波：</h2><p>一些周期性噪声在图像的频谱图中很容易观察得到，故而我们可以考虑使用<strong>（1）带通滤波器 (bandpass filter) 或带限滤波器（bandreject filter）</strong> <strong>（2）陷波滤波器（notch filter）</strong>对噪声进行消除。</p>
<p>###Ex1：带通或带限滤波器进行滤波</p>
<ol>
<li><p>如下，原图像遭受了严重的正弦波噪声（sinusoidal noise）污染在图像经过傅里叶变换后得到的频谱图的低频区中，零星的，呈圆形的分布着可疑亮点，而我们知道，图像频谱图中的亮点代表某频率出现次数异常得高，即某个灰度变化出现的次数很高，再考虑到正弦噪声是相对于周围像素灰度变化不严重（即正弦噪声对应于低频分量），且正弦噪声为周期性噪声，出现次数频繁（即正弦噪声对应的频率分量在频谱图中很亮），故判断这些亮点对应的图像很可能是正弦噪声。</p>
</li>
<li><p>使用 Butterworth Bandreject Filter 进行滤波。</p>
</li>
<li><p>滤波后的频谱图经傅里叶反变换后得到修复图像。</p>
</li>
<li><p>并且可通过带通滤波器提取到噪声图像。</p>
</li>
</ol>
<p><img src="http://7pulhb.com1.z0.glb.clouddn.com/ip - 滤波 Demo.png" alt="滤波 Demo"></p>
<p>###Ex2：使用陷波滤波器进行滤波：</p>
<p>陷波滤波器类似于带限滤波器，都是使某一部分频率下陷，但陷波滤波器着重指是不规则形状包围的频率分量下陷。</p>
<p>如下，对被水平扫描线噪声污染了的图像做傅里叶变换获得其频谱图，可以观察到中央分布着一条垂直亮线，即暗示着在垂直方向，图像的灰度变化剧烈，而各条水平扫描线正是在垂直方向上灰度变化剧烈，故我们使该条垂直亮线下陷，即得到了修复图像，是该条垂直亮线通过，则得到了水平扫描线图像。</p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:softshot37@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/yoyoyohamapi" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://www.zhihu.com/people/wu-xiao-jun-64-55/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">吴晓军</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
